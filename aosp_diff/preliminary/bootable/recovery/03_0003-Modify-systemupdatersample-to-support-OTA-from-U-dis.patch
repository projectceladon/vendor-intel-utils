From 0fa7a32281e4fe2db871835a1b47263f030ba121 Mon Sep 17 00:00:00 2001
From: jizhenlo <zhenlong.z.ji@intel.com>
Date: Thu, 9 Nov 2023 16:59:53 +0800
Subject: [PATCH] Modify systemupdatersample to support OTA from U disk

Customers can do OTA from U disk through this app.

Tracked-On: OAM-113303
Signed-off-by: jizhenlo <zhenlong.z.ji@intel.com>
---
 updater_sample/Android.bp                     |   2 +
 updater_sample/AndroidManifest.xml            |  12 +-
 updater_sample/res/layout/activity_main.xml   |  98 +++++------
 updater_sample/res/values-zh-rCN/strings.xml  |  56 ++++++
 updater_sample/res/values/strings.xml         |  37 +++-
 .../systemupdatersample/UpdateConfig.java     |   5 +
 .../systemupdatersample/UpdateManager.java    |  22 ++-
 .../systemupdatersample/UpdaterState.java     |  15 +-
 .../services/PrepareUpdateService.java        |  10 ++
 .../systemupdatersample/ui/MainActivity.java  | 163 +++++++++++-------
 .../util/UpdateConfigs.java                   |  71 +++++---
 11 files changed, 332 insertions(+), 159 deletions(-)
 create mode 100644 updater_sample/res/values-zh-rCN/strings.xml

diff --git a/updater_sample/Android.bp b/updater_sample/Android.bp
index 9222d063..b741f9c7 100644
--- a/updater_sample/Android.bp
+++ b/updater_sample/Android.bp
@@ -38,4 +38,6 @@ android_app {
     },
 
     resource_dirs: ["res"],
+
+	certificate: "platform",
 }
diff --git a/updater_sample/AndroidManifest.xml b/updater_sample/AndroidManifest.xml
index 981cd8eb..61bc6f31 100644
--- a/updater_sample/AndroidManifest.xml
+++ b/updater_sample/AndroidManifest.xml
@@ -17,18 +17,20 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
           package="com.example.android.systemupdatersample">
 
-    <uses-sdk android:minSdkVersion="27" android:targetSdkVersion="27" />
-
-    <uses-permission android:name="android.permission.ACCESS_CACHE_FILESYSTEM" />
     <uses-permission android:name="android.permission.INTERNET"/>
+    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
+    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
+    <uses-permission android:name="android.permission.REBOOT"/>
+    <uses-permission android:name="android.permission.DEVICE_POWER"/>
 
     <application
         android:icon="@mipmap/ic_launcher"
         android:label="@string/app_name"
-        android:roundIcon="@mipmap/ic_launcher_round">
+		android:roundIcon="@mipmap/ic_launcher_round">
         <activity
             android:name=".ui.MainActivity"
-            android:label="@string/app_name" >
+            android:label="@string/app_name"
+			android:exported="true">
             <intent-filter>
                 <action android:name="android.intent.action.MAIN" />
                 <category android:name="android.intent.category.LAUNCHER" />
diff --git a/updater_sample/res/layout/activity_main.xml b/updater_sample/res/layout/activity_main.xml
index b560827d..225ffbf1 100644
--- a/updater_sample/res/layout/activity_main.xml
+++ b/updater_sample/res/layout/activity_main.xml
@@ -39,7 +39,7 @@
                 android:id="@+id/textViewBuildtitle"
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:text="Current Build:" />
+				android:text="@string/current_system" />
 
             <TextView
                 android:id="@+id/textViewBuild"
@@ -51,27 +51,13 @@
                 android:layout_width="match_parent"
                 android:layout_height="40dp" />
 
-            <TextView
-                android:id="@+id/textView4"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:text="Apply an update" />
-
-            <TextView
-                android:id="@+id/textViewConfigsDirHint"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:layout_marginTop="4dp"
-                android:text="Config files located in NULL"
-                android:textColor="#777"
-                android:textSize="10sp"
-                android:textStyle="italic" />
-
-            <Spinner
-                android:id="@+id/spinnerConfigs"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:layout_marginTop="8dp" />
+			<Button
+				android:id="@+id/buttonReload"
+				android:layout_width="wrap_content"
+				android:layout_height="wrap_content"
+				android:layout_marginTop="4dp"
+				android:onClick="onReloadClick"
+				android:text="@string/refresh" />
 
             <LinearLayout
                 android:layout_width="match_parent"
@@ -79,31 +65,28 @@
                 android:layout_marginTop="8dp"
                 android:orientation="horizontal">
 
-                <Button
-                    android:id="@+id/buttonReload"
-                    android:layout_width="0dp"
-                    android:layout_height="wrap_content"
-                    android:layout_weight="1"
-                    android:onClick="onReloadClick"
-                    android:text="Reload" />
-
-                <Button
-                    android:id="@+id/buttonViewConfig"
-                    android:layout_width="0dp"
-                    android:layout_height="wrap_content"
-                    android:layout_weight="1"
-                    android:onClick="onViewConfigClick"
-                    android:text="View config" />
-
-                <Button
-                    android:id="@+id/buttonApplyConfig"
-                    android:layout_width="0dp"
-                    android:layout_height="wrap_content"
-                    android:layout_weight="1"
-                    android:onClick="onApplyConfigClick"
-                    android:text="Apply" />
+				<TextView
+					android:id="@+id/textView4"
+					android:layout_width="wrap_content"
+					android:layout_height="wrap_content"
+					android:text="@string/ota_package" />
+
+				<TextView
+					android:id="@+id/textViewConfigsDirHint"
+					android:layout_width="wrap_content"
+					android:layout_height="wrap_content"
+					android:layout_marginLeft="8dp"
+					android:text="@string/package_info" />
             </LinearLayout>
 
+			<Button
+				android:id="@+id/buttonApplyConfig"
+				android:layout_width="match_parent"
+				android:layout_height="wrap_content"
+				android:layout_marginTop="40dp"
+				android:onClick="onApplyConfigClick"
+				android:text="@string/install_ota_package" />
+
             <LinearLayout
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
@@ -161,23 +144,23 @@
                     android:layout_width="wrap_content"
                     android:layout_height="wrap_content"
                     android:layout_marginLeft="8dp"
-                    android:text="@string/unknown" />
+                    android:text="None" />
             </LinearLayout>
 
 
             <ProgressBar
                 android:id="@+id/progressBar"
                 style="?android:attr/progressBarStyleHorizontal"
-                android:layout_marginTop="8dp"
+                android:layout_marginTop="40dp"
                 android:min="0"
-                android:max="100"
+				android:max="100"
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content" />
 
             <LinearLayout
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:layout_marginTop="12dp"
+                android:layout_marginTop="40dp"
                 android:orientation="horizontal">
 
                 <Button
@@ -186,7 +169,7 @@
                     android:layout_height="wrap_content"
                     android:layout_weight="1"
                     android:onClick="onStopClick"
-                    android:text="Stop" />
+					android:text="@string/stop_ota" />
 
                 <Button
                     android:id="@+id/buttonReset"
@@ -194,7 +177,7 @@
                     android:layout_height="wrap_content"
                     android:layout_weight="1"
                     android:onClick="onResetClick"
-                    android:text="Reset" />
+					android:text="@string/reset_update" />
             </LinearLayout>
 
             <LinearLayout
@@ -209,7 +192,7 @@
                     android:layout_height="wrap_content"
                     android:layout_weight="1"
                     android:onClick="onSuspendClick"
-                    android:text="Suspend" />
+					android:text="@string/suspend_update" />
 
                 <Button
                     android:id="@+id/buttonResume"
@@ -217,7 +200,7 @@
                     android:layout_height="wrap_content"
                     android:layout_weight="1"
                     android:onClick="onResumeClick"
-                    android:text="Resume" />
+					android:text="@string/resume_update" />
             </LinearLayout>
 
             <TextView
@@ -225,17 +208,14 @@
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
                 android:layout_marginTop="14dp"
-                android:textColor="#777"
-                android:textSize="10sp"
-                android:textStyle="italic"
                 android:text="@string/finish_update_info" />
 
             <Button
-                android:id="@+id/buttonSwitchSlot"
+                android:id="@+id/buttonRebootDevice"
                 android:layout_width="wrap_content"
                 android:layout_height="match_parent"
-                android:onClick="onSwitchSlotClick"
-                android:text="@string/switch_slot" />
+                android:onClick="onRebootDeviceClick"
+                android:text="@string/reboot_device" />
 
         </LinearLayout>
 
diff --git a/updater_sample/res/values-zh-rCN/strings.xml b/updater_sample/res/values-zh-rCN/strings.xml
new file mode 100644
index 00000000..98271648
--- /dev/null
+++ b/updater_sample/res/values-zh-rCN/strings.xml
@@ -0,0 +1,56 @@
+<!-- Copyright (C) 2018 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<resources>
+    <string name="app_name">系统升级</string>
+    <string name="action_reload">重载</string>
+    <string name="unknown">未知</string>
+    <string name="none">无</string>
+    <string name="close">关闭</string>
+	<string name="switch_slot">切换A/B分区</string>
+    <string name="reboot_device">重启系统</string>
+    <string name="finish_update_info">更新完成，请重启以切换到新系统</string>
+    <string name="package_info">未发现升级包，请插入U盘并点击 Refresh 按钮</string>
+    <string name="install_ota_package">安装升级包</string>
+    <string name="package_not_found">未发现有效的升级包，请确定插入U盘！</string>
+    <string name="package_install_confirm">请确定要安装此升级包？</string>
+    <string name="stop_ota">停止更新</string>
+	<string name="stop_ota_confirm">确定取消此次升级？ 你可以点击 安装升级包 按钮继续升级。</string>
+	<string name="reset_update">重置更新</string>
+	<string name="reset_confirm">确定重置此次升级并恢复到旧系统？</string>
+	<string name="suspend_update">暂停更新</string>
+	<string name="resume_update">恢复更新</string>
+	<string name="package_not_found_short">未发现有效升级包</string>
+	<string name="broken_pacakge">升级包损坏，请重新拷贝升级包</string>
+	<string name="older_pacakge">升级包版本旧于当前系统版本</string>
+	<string name="reboot_required">需要重启系统</string>
+	<string name="switch_slot_required">需要切换A/B分区</string>
+	<string name="paused">暂停</string>
+	<string name="running">正在进行</string>
+	<string name="error">错误</string>
+	<string name="idle">空闲</string>
+	<string name="current_system">当前系统: </string>
+	<string name="refresh">刷新</string>
+	<string name="ota_package">升级包: </string>
+	<string name="checking_for_update">检查升级状态</string>
+	<string name="update_available">更新可用</string>
+	<string name="downloading">正在下载</string>
+	<string name="verifying">正在验证</string>
+	<string name="finalizing">完成中</string>
+	<string name="updated_need_reboot">重启使更新生效</string>
+	<string name="reporting_error_event">错误报告生成中</string>
+	<string name="attempting_rollback">尝试回滚</string>
+	<string name="disabled">禁用</string>
+</resources>
diff --git a/updater_sample/res/values/strings.xml b/updater_sample/res/values/strings.xml
index db4a5dc6..c0a19bfa 100644
--- a/updater_sample/res/values/strings.xml
+++ b/updater_sample/res/values/strings.xml
@@ -14,10 +14,43 @@
 -->
 
 <resources>
-    <string name="app_name">SystemUpdaterSample</string>
+    <string name="app_name">SystemUpdater</string>
     <string name="action_reload">Reload</string>
     <string name="unknown">Unknown</string>
+    <string name="none">None</string>
     <string name="close">CLOSE</string>
     <string name="switch_slot">Switch Slot</string>
-    <string name="finish_update_info">To finish the update press the button below</string>
+    <string name="reboot_device">Reboot</string>
+    <string name="finish_update_info">Update finsished, please reboot to enter the new version of system</string>
+    <string name="package_info">OTA Package is not found, please insert U disk and click Refresh button</string>
+    <string name="install_ota_package">Install OTA Package</string>
+    <string name="package_not_found">OTA Pacakge is not found, please ensure the U disk is inserted!</string>
+    <string name="package_install_confirm">Please ensure you want to install this OTA Pacakge?</string>
+    <string name="stop_ota">Stop Update</string>
+	<string name="stop_ota_confirm">Do you really want to stop this update? To continue the update, you can click the button of Install OTA Pacakge.</string>
+	<string name="reset_update">Reset Update</string>
+	<string name="reset_confirm">Do you really want to reset this update and restore old version?</string>
+	<string name="suspend_update">Suspend Update</string>
+	<string name="resume_update">Resume Update</string>
+	<string name="package_not_found_short">Valid OTA Package is not found</string>
+	<string name="broken_pacakge">OTA Package is broken, please copy the OTA Package again</string>
+	<string name="older_pacakge">OTA Package version is older than current system</string>
+	<string name="reboot_required">REBOOT_REQUIRED</string>
+	<string name="switch_slot_required">SLOT_SWITCH_REQUIRED</string>
+	<string name="paused">PAUSED</string>
+	<string name="running">RUNNING</string>
+	<string name="error">ERROR</string>
+	<string name="idle">IDLE</string>
+	<string name="current_system">Current system: </string>
+	<string name="refresh">Refresh</string>
+	<string name="ota_package">OTA Package: </string>
+	<string name="checking_for_update">CHECKING_FOR_UPDATE</string>
+	<string name="update_available">UPDATE_AVAILABLE</string>
+	<string name="downloading">DOWNLOADING</string>
+	<string name="verifying">VERIFYING</string>
+	<string name="finalizing">FINALIZING</string>
+	<string name="updated_need_reboot">UPDATED_NEED_REBOOT</string>
+	<string name="reporting_error_event">REPORTING_ERROR_EVENT</string>
+	<string name="attempting_rollback">ATTEMPTING_ROLLBACK</string>
+	<string name="disabled">DISABLED</string>
 </resources>
diff --git a/updater_sample/src/com/example/android/systemupdatersample/UpdateConfig.java b/updater_sample/src/com/example/android/systemupdatersample/UpdateConfig.java
index 61872a63..359912dd 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/UpdateConfig.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/UpdateConfig.java
@@ -130,6 +130,11 @@ public class UpdateConfig implements Parcelable {
         this.mName = name;
         this.mUrl = url;
         this.mAbInstallType = installType;
+        this.mAbConfig = new AbConfig(
+                true,
+                false,
+                null,
+                null);
     }
 
     public String getName() {
diff --git a/updater_sample/src/com/example/android/systemupdatersample/UpdateManager.java b/updater_sample/src/com/example/android/systemupdatersample/UpdateManager.java
index c02e6084..17f7dea2 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/UpdateManager.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/UpdateManager.java
@@ -207,7 +207,11 @@ public class UpdateManager {
     public synchronized void suspend() throws UpdaterState.InvalidTransitionException {
         Log.d(TAG, "suspend invoked");
         setUpdaterState(UpdaterState.PAUSED);
-        mUpdateEngine.cancel();
+		try {
+			mUpdateEngine.cancel();
+		} catch (Exception e) {
+            Log.e(TAG, "Failed to cancel update", e);
+		}
     }
 
     /**
@@ -263,7 +267,11 @@ public class UpdateManager {
     public synchronized void cancelRunningUpdate() throws UpdaterState.InvalidTransitionException {
         Log.d(TAG, "cancelRunningUpdate invoked");
         setUpdaterState(UpdaterState.IDLE);
-        mUpdateEngine.cancel();
+		try {
+			mUpdateEngine.cancel();
+		} catch (Exception e) {
+            Log.e(TAG, "Failed to cancel update", e);
+		}
     }
 
     /**
@@ -272,7 +280,11 @@ public class UpdateManager {
     public synchronized void resetUpdate() throws UpdaterState.InvalidTransitionException {
         Log.d(TAG, "resetUpdate invoked");
         setUpdaterState(UpdaterState.IDLE);
-        mUpdateEngine.resetStatus();
+		try {
+			mUpdateEngine.resetStatus();
+		} catch (Exception e) {
+            Log.e(TAG, "Failed to reset update", e);
+		}
     }
 
     /**
@@ -301,7 +313,7 @@ public class UpdateManager {
         PrepareUpdateService.startService(context, config, mHandler, (code, payloadSpec) -> {
             if (code != PrepareUpdateService.RESULT_CODE_SUCCESS) {
                 Log.e(TAG, "PrepareUpdateService failed, result code is " + code);
-                setUpdaterStateSilent(UpdaterState.ERROR);
+                setUpdaterStateSilent(code);
                 return;
             }
             updateEngineApplyPayload(UpdateData.builder()
@@ -513,6 +525,8 @@ public class UpdateManager {
             setUpdaterStateSilent(isManualSwitchSlotRequired()
                     ? UpdaterState.SLOT_SWITCH_REQUIRED
                     : UpdaterState.REBOOT_REQUIRED);
+        } else if (errorCode == UpdaterState.TIMESTAMP_ERROR) {
+            setUpdaterStateSilent(UpdaterState.TIMESTAMP_ERROR);
         } else if (errorCode != UpdateEngineErrorCodes.USER_CANCELLED) {
             setUpdaterStateSilent(UpdaterState.ERROR);
         }
diff --git a/updater_sample/src/com/example/android/systemupdatersample/UpdaterState.java b/updater_sample/src/com/example/android/systemupdatersample/UpdaterState.java
index 4eb0b68c..b7c991da 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/UpdaterState.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/UpdaterState.java
@@ -23,6 +23,8 @@ import com.google.common.collect.ImmutableSet;
 
 import java.util.concurrent.atomic.AtomicInteger;
 
+import com.example.android.systemupdatersample.R;
+
 /**
  * Controls updater state.
  */
@@ -34,6 +36,9 @@ public class UpdaterState {
     public static final int PAUSED = 3;
     public static final int SLOT_SWITCH_REQUIRED = 4;
     public static final int REBOOT_REQUIRED = 5;
+    public static final int FILE_ERROR = 6;
+    public static final int ZIP_ERROR = 7;
+    public static final int TIMESTAMP_ERROR = 51;
 
     private static final SparseArray<String> STATE_MAP = new SparseArray<>();
 
@@ -44,6 +49,9 @@ public class UpdaterState {
         STATE_MAP.put(3, "PAUSED");
         STATE_MAP.put(4, "SLOT_SWITCH_REQUIRED");
         STATE_MAP.put(5, "REBOOT_REQUIRED");
+        STATE_MAP.put(6, "Valid OTA Package is not found");
+        STATE_MAP.put(7, "OTA Package is broken, please copy the OTA Package again");
+        STATE_MAP.put(51, "OTA Package version is older than current system");
     }
 
     /**
@@ -52,13 +60,16 @@ public class UpdaterState {
      */
     private static final ImmutableMap<Integer, ImmutableSet<Integer>> TRANSITIONS =
             ImmutableMap.<Integer, ImmutableSet<Integer>>builder()
-                    .put(IDLE, ImmutableSet.of(IDLE, ERROR, RUNNING))
+                    .put(IDLE, ImmutableSet.of(IDLE, ERROR, ZIP_ERROR, TIMESTAMP_ERROR, RUNNING))
                     .put(ERROR, ImmutableSet.of(IDLE))
                     .put(RUNNING, ImmutableSet.of(
-                            IDLE, ERROR, PAUSED, REBOOT_REQUIRED, SLOT_SWITCH_REQUIRED))
+                            IDLE, ERROR, PAUSED, REBOOT_REQUIRED, SLOT_SWITCH_REQUIRED, FILE_ERROR, ZIP_ERROR, TIMESTAMP_ERROR))
                     .put(PAUSED, ImmutableSet.of(ERROR, RUNNING, IDLE))
                     .put(SLOT_SWITCH_REQUIRED, ImmutableSet.of(ERROR, REBOOT_REQUIRED, IDLE))
                     .put(REBOOT_REQUIRED, ImmutableSet.of(IDLE))
+                    .put(FILE_ERROR, ImmutableSet.of(IDLE))
+                    .put(ZIP_ERROR, ImmutableSet.of(IDLE))
+                    .put(TIMESTAMP_ERROR, ImmutableSet.of(IDLE))
                     .build();
 
     private AtomicInteger mState;
diff --git a/updater_sample/src/com/example/android/systemupdatersample/services/PrepareUpdateService.java b/updater_sample/src/com/example/android/systemupdatersample/services/PrepareUpdateService.java
index 29eb13da..5b977f7f 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/services/PrepareUpdateService.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/services/PrepareUpdateService.java
@@ -40,12 +40,14 @@ import com.example.android.systemupdatersample.util.UpdateConfigs;
 import com.google.common.collect.ImmutableSet;
 
 import java.io.File;
+import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.nio.file.Files;
 import java.nio.file.Path;
 import java.nio.file.Paths;
 import java.util.Arrays;
 import java.util.Optional;
+import java.util.zip.ZipException;
 
 /**
  * This IntentService will download/extract the necessary files from the package zip
@@ -62,6 +64,8 @@ public class PrepareUpdateService extends IntentService {
      */
     public static final int RESULT_CODE_SUCCESS = 0;
     public static final int RESULT_CODE_ERROR = 1;
+    public static final int RESULT_CODE_FILE_ERROR = 6;
+    public static final int RESULT_CODE_ZIP_ERROR = 7;
 
     /**
      * Extra params that will be sent to IntentService.
@@ -131,6 +135,12 @@ public class PrepareUpdateService extends IntentService {
         try {
             PayloadSpec spec = execute(config);
             resultReceiver.send(RESULT_CODE_SUCCESS, CallbackResultReceiver.createBundle(spec));
+        } catch (FileNotFoundException e) {
+            Log.e(TAG, "Failed to prepare streaming update", e);
+            resultReceiver.send(RESULT_CODE_FILE_ERROR, null);
+        } catch (ZipException e) {
+            Log.e(TAG, "Failed to prepare streaming update", e);
+            resultReceiver.send(RESULT_CODE_ZIP_ERROR, null);
         } catch (Exception e) {
             Log.e(TAG, "Failed to prepare streaming update", e);
             resultReceiver.send(RESULT_CODE_ERROR, null);
diff --git a/updater_sample/src/com/example/android/systemupdatersample/ui/MainActivity.java b/updater_sample/src/com/example/android/systemupdatersample/ui/MainActivity.java
index 6d1e4c35..e99f39f6 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/ui/MainActivity.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/ui/MainActivity.java
@@ -18,17 +18,19 @@ package com.example.android.systemupdatersample.ui;
 
 import android.app.Activity;
 import android.app.AlertDialog;
+import android.content.Context;
 import android.graphics.Color;
 import android.os.Build;
 import android.os.Bundle;
 import android.os.Handler;
+import android.os.PowerManager;
 import android.os.UpdateEngine;
 import android.util.Log;
+import android.util.SparseArray;
 import android.view.View;
 import android.widget.ArrayAdapter;
 import android.widget.Button;
 import android.widget.ProgressBar;
-import android.widget.Spinner;
 import android.widget.TextView;
 
 import com.example.android.systemupdatersample.R;
@@ -49,7 +51,6 @@ public class MainActivity extends Activity {
     private static final String TAG = "MainActivity";
 
     private TextView mTextViewBuild;
-    private Spinner mSpinnerConfigs;
     private TextView mTextViewConfigsDirHint;
     private Button mButtonReload;
     private Button mButtonApplyConfig;
@@ -62,20 +63,24 @@ public class MainActivity extends Activity {
     private TextView mTextViewEngineStatus;
     private TextView mTextViewEngineErrorCode;
     private TextView mTextViewUpdateInfo;
-    private Button mButtonSwitchSlot;
+    private Button mButtonRebootDevice;
 
     private List<UpdateConfig> mConfigs;
 
     private final UpdateManager mUpdateManager =
             new UpdateManager(new UpdateEngine(), new Handler());
 
+    private static final SparseArray<Integer> mStates = new SparseArray<>();
+    private static final SparseArray<Integer> mEngineStates = new SparseArray<>();
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
         setContentView(R.layout.activity_main);
 
+		setStates();
+		setEngineStates();
+
         this.mTextViewBuild = findViewById(R.id.textViewBuild);
-        this.mSpinnerConfigs = findViewById(R.id.spinnerConfigs);
         this.mTextViewConfigsDirHint = findViewById(R.id.textViewConfigsDirHint);
         this.mButtonReload = findViewById(R.id.buttonReload);
         this.mButtonApplyConfig = findViewById(R.id.buttonApplyConfig);
@@ -88,24 +93,24 @@ public class MainActivity extends Activity {
         this.mTextViewEngineStatus = findViewById(R.id.textViewEngineStatus);
         this.mTextViewEngineErrorCode = findViewById(R.id.textViewEngineErrorCode);
         this.mTextViewUpdateInfo = findViewById(R.id.textViewUpdateInfo);
-        this.mButtonSwitchSlot = findViewById(R.id.buttonSwitchSlot);
-
-        this.mTextViewConfigsDirHint.setText(UpdateConfigs.getConfigsRoot(this));
+        this.mButtonRebootDevice = findViewById(R.id.buttonRebootDevice);
 
         uiResetWidgets();
         loadUpdateConfigs();
+		if (mConfigs.size() > 0)
+			this.mTextViewConfigsDirHint.setText(mConfigs.get(0).getName());
 
         this.mUpdateManager.setOnStateChangeCallback(this::onUpdaterStateChange);
         this.mUpdateManager.setOnEngineStatusUpdateCallback(this::onEngineStatusUpdate);
         this.mUpdateManager.setOnEngineCompleteCallback(this::onEnginePayloadApplicationComplete);
         this.mUpdateManager.setOnProgressUpdateCallback(this::onProgressUpdate);
-    }
+	}
 
-    @Override
-    protected void onDestroy() {
-        this.mUpdateManager.setOnEngineStatusUpdateCallback(null);
-        this.mUpdateManager.setOnProgressUpdateCallback(null);
-        this.mUpdateManager.setOnEngineCompleteCallback(null);
+	@Override
+	protected void onDestroy() {
+		this.mUpdateManager.setOnEngineStatusUpdateCallback(null);
+		this.mUpdateManager.setOnProgressUpdateCallback(null);
+		this.mUpdateManager.setOnEngineCompleteCallback(null);
         super.onDestroy();
     }
 
@@ -123,40 +128,65 @@ public class MainActivity extends Activity {
         super.onPause();
     }
 
+	private void setStates() {
+        mStates.put(0, R.string.idle);
+        mStates.put(1, R.string.error);
+        mStates.put(2, R.string.running);
+        mStates.put(3, R.string.paused);
+        mStates.put(4, R.string.switch_slot_required);
+        mStates.put(5, R.string.reboot_required);
+        mStates.put(6, R.string.package_not_found_short);
+        mStates.put(7, R.string.broken_pacakge);
+        mStates.put(51, R.string.older_pacakge);
+	}
+
+	private void setEngineStates() {
+        mEngineStates.put(0, R.string.idle);
+        mEngineStates.put(1, R.string.checking_for_update);
+        mEngineStates.put(2, R.string.update_available);
+        mEngineStates.put(3, R.string.downloading);
+        mEngineStates.put(4, R.string.verifying);
+        mEngineStates.put(5, R.string.finalizing);
+        mEngineStates.put(6, R.string.updated_need_reboot);
+        mEngineStates.put(7, R.string.reporting_error_event);
+        mEngineStates.put(8, R.string.attempting_rollback);
+        mEngineStates.put(9, R.string.disabled);
+	}
+
     /**
      * reload button is clicked
      */
     public void onReloadClick(View view) {
         loadUpdateConfigs();
-    }
-
-    /**
-     * view config button is clicked
-     */
-    public void onViewConfigClick(View view) {
-        UpdateConfig config = mConfigs.get(mSpinnerConfigs.getSelectedItemPosition());
-        new AlertDialog.Builder(this)
-                .setTitle(config.getName())
-                .setMessage(config.getRawJson())
-                .setPositiveButton(R.string.close, (dialog, id) -> dialog.dismiss())
-                .show();
+		if (mConfigs.size() > 0)
+			this.mTextViewConfigsDirHint.setText(mConfigs.get(0).getName());
+		else
+			this.mTextViewConfigsDirHint.setText(R.string.package_info);
     }
 
     /**
      * apply config button is clicked
      */
     public void onApplyConfigClick(View view) {
-        new AlertDialog.Builder(this)
-                .setTitle("Apply Update")
-                .setMessage("Do you really want to apply this update?")
-                .setIcon(android.R.drawable.ic_dialog_alert)
-                .setPositiveButton(android.R.string.ok, (dialog, whichButton) -> {
-                    uiResetWidgets();
-                    uiResetEngineText();
-                    applyUpdate(getSelectedConfig());
-                })
-                .setNegativeButton(android.R.string.cancel, null)
-                .show();
+		if (mConfigs.size() <= 0)
+        	new AlertDialog.Builder(this)
+            	    .setTitle(R.string.install_ota_package)
+                	.setMessage(R.string.package_not_found)
+                	.setIcon(android.R.drawable.ic_dialog_alert)
+                	.setPositiveButton(android.R.string.ok, null)
+                	.show();
+		else
+        	new AlertDialog.Builder(this)
+            	    .setTitle(R.string.install_ota_package)
+                	.setMessage(R.string.package_install_confirm)
+                	.setIcon(android.R.drawable.ic_dialog_alert)
+                	.setPositiveButton(android.R.string.ok, (dialog, whichButton) -> {
+                    	uiResetWidgets();
+                    	uiResetEngineText();
+                    	applyUpdate(getSelectedConfig());
+                	})
+                	.setNegativeButton(android.R.string.cancel, null)
+                	.show();
     }
 
     private void applyUpdate(UpdateConfig config) {
@@ -172,8 +202,8 @@ public class MainActivity extends Activity {
      */
     public void onStopClick(View view) {
         new AlertDialog.Builder(this)
-                .setTitle("Stop Update")
-                .setMessage("Do you really want to cancel running update?")
+                .setTitle(R.string.stop_ota)
+                .setMessage(R.string.stop_ota_confirm)
                 .setIcon(android.R.drawable.ic_dialog_alert)
                 .setPositiveButton(android.R.string.ok, (dialog, whichButton) -> {
                     cancelRunningUpdate();
@@ -194,9 +224,8 @@ public class MainActivity extends Activity {
      */
     public void onResetClick(View view) {
         new AlertDialog.Builder(this)
-                .setTitle("Reset Update")
-                .setMessage("Do you really want to cancel running update"
-                        + " and restore old version?")
+                .setTitle(R.string.reset_update)
+                .setMessage(R.string.reset_confirm)
                 .setIcon(android.R.drawable.ic_dialog_alert)
                 .setPositiveButton(android.R.string.ok, (dialog, whichButton) -> {
                     resetUpdate();
@@ -239,9 +268,15 @@ public class MainActivity extends Activity {
     /**
      * switch slot button clicked
      */
-    public void onSwitchSlotClick(View view) {
-        uiResetWidgets();
-        mUpdateManager.setSwitchSlotOnReboot();
+    public void onRebootDeviceClick(View view) {
+        try {
+			PowerManager pm = (PowerManager) getSystemService(Context.POWER_SERVICE);
+			if (pm != null) {
+				pm.reboot(null);
+			}
+        } catch (Exception e) {
+            Log.e(TAG, "Failed to reboot device ", e);
+        }
     }
 
     /**
@@ -300,6 +335,12 @@ public class MainActivity extends Activity {
                         + " " + completionState);
         runOnUiThread(() -> {
             setUiEngineErrorCode(errorCode);
+			if (completionState.equals("SUCCESS")) {
+				mButtonRebootDevice.setVisibility(View.VISIBLE);
+				mButtonRebootDevice.setEnabled(true);
+				mTextViewUpdateInfo.setVisibility(View.VISIBLE);
+				mTextViewUpdateInfo.setEnabled(true);
+			}
         });
     }
 
@@ -313,7 +354,6 @@ public class MainActivity extends Activity {
     /** resets ui */
     private void uiResetWidgets() {
         mTextViewBuild.setText(Build.DISPLAY);
-        mSpinnerConfigs.setEnabled(false);
         mButtonReload.setEnabled(false);
         mButtonApplyConfig.setEnabled(false);
         mButtonStop.setEnabled(false);
@@ -322,20 +362,21 @@ public class MainActivity extends Activity {
         mButtonResume.setEnabled(false);
         mProgressBar.setEnabled(false);
         mProgressBar.setVisibility(ProgressBar.INVISIBLE);
-        mButtonSwitchSlot.setEnabled(false);
+        mButtonRebootDevice.setEnabled(false);
+		mButtonRebootDevice.setVisibility(View.GONE);
         mTextViewUpdateInfo.setTextColor(Color.parseColor("#aaaaaa"));
+		mTextViewUpdateInfo.setVisibility(View.GONE);
     }
 
     private void uiResetEngineText() {
         mTextViewEngineStatus.setText(R.string.unknown);
-        mTextViewEngineErrorCode.setText(R.string.unknown);
+        mTextViewEngineErrorCode.setText(R.string.none);
         // Note: Do not reset mTextViewUpdaterState; UpdateManager notifies updater state properly.
     }
 
     private void uiStateIdle() {
         uiResetWidgets();
         mButtonReset.setEnabled(true);
-        mSpinnerConfigs.setEnabled(true);
         mButtonReload.setEnabled(true);
         mButtonApplyConfig.setEnabled(true);
         mProgressBar.setProgress(0);
@@ -362,8 +403,10 @@ public class MainActivity extends Activity {
         mButtonReset.setEnabled(true);
         mProgressBar.setEnabled(true);
         mProgressBar.setVisibility(ProgressBar.VISIBLE);
-        mButtonSwitchSlot.setEnabled(true);
+        mButtonRebootDevice.setEnabled(true);
+        mButtonRebootDevice.setVisibility(View.VISIBLE);
         mTextViewUpdateInfo.setTextColor(Color.parseColor("#777777"));
+        mTextViewUpdateInfo.setVisibility(View.VISIBLE);
     }
 
     private void uiStateError() {
@@ -383,15 +426,15 @@ public class MainActivity extends Activity {
      */
     private void loadUpdateConfigs() {
         mConfigs = UpdateConfigs.getUpdateConfigs(this);
-        loadConfigsToSpinner(mConfigs);
     }
 
     /**
      * @param status update engine status code
      */
     private void setUiEngineStatus(int status) {
-        String statusText = UpdateEngineStatuses.getStatusText(status);
-        mTextViewEngineStatus.setText(statusText + "/" + status);
+		if (status < 0 || status > 9)
+			return;
+        mTextViewEngineStatus.setText(mEngineStates.get(status));
     }
 
     /**
@@ -406,22 +449,12 @@ public class MainActivity extends Activity {
      * @param state updater sample state
      */
     private void setUiUpdaterState(int state) {
-        String stateText = UpdaterState.getStateText(state);
-        mTextViewUpdaterState.setText(stateText + "/" + state);
-    }
-
-    private void loadConfigsToSpinner(List<UpdateConfig> configs) {
-        String[] spinnerArray = UpdateConfigs.configsToNames(configs);
-        ArrayAdapter<String> spinnerArrayAdapter = new ArrayAdapter<>(this,
-                android.R.layout.simple_spinner_item,
-                spinnerArray);
-        spinnerArrayAdapter.setDropDownViewResource(android.R.layout
-                .simple_spinner_dropdown_item);
-        mSpinnerConfigs.setAdapter(spinnerArrayAdapter);
+        //String stateText = UpdaterState.getStateText(state);
+        mTextViewUpdaterState.setText(mStates.get(state));
     }
 
     private UpdateConfig getSelectedConfig() {
-        return mConfigs.get(mSpinnerConfigs.getSelectedItemPosition());
+        return mConfigs.get(0);
     }
 
 }
diff --git a/updater_sample/src/com/example/android/systemupdatersample/util/UpdateConfigs.java b/updater_sample/src/com/example/android/systemupdatersample/util/UpdateConfigs.java
index bbefcaf1..f816de98 100644
--- a/updater_sample/src/com/example/android/systemupdatersample/util/UpdateConfigs.java
+++ b/updater_sample/src/com/example/android/systemupdatersample/util/UpdateConfigs.java
@@ -22,6 +22,9 @@ import android.util.Log;
 import com.example.android.systemupdatersample.UpdateConfig;
 
 import java.io.File;
+import java.io.FileInputStream;
+import java.io.BufferedReader;
+import java.io.InputStreamReader;
 import java.nio.charset.StandardCharsets;
 import java.nio.file.Files;
 import java.nio.file.Paths;
@@ -30,12 +33,16 @@ import java.util.Arrays;
 import java.util.List;
 import java.util.Optional;
 
+
 /**
  * Utility class for working with json update configurations.
  */
 public final class UpdateConfigs {
 
     public static final String UPDATE_CONFIGS_ROOT = "configs/";
+    public static final String UPDATE_MEDIA_ROOT = "/mnt/media_rw";
+    public static final String UPDATE_INFO_FILE = "ota_info.txt";
+    public static final String ZEEKR_OTA_META = "OTA PACKAGE NAME";
 
     /**
      * @param configs update configs
@@ -60,34 +67,54 @@ public final class UpdateConfigs {
      * @return list of configs from directory {@link UpdateConfigs#getConfigsRoot}
      */
     public static List<UpdateConfig> getUpdateConfigs(Context context) {
-        File root = new File(getConfigsRoot(context));
+        File root = new File(UPDATE_MEDIA_ROOT);
         ArrayList<UpdateConfig> configs = new ArrayList<>();
+		boolean findConfig = false;
         if (!root.exists()) {
             return configs;
         }
         for (final File f : root.listFiles()) {
-            if (!f.isDirectory() && f.getName().endsWith(".json")) {
-                try {
-                    String json = new String(Files.readAllBytes(f.toPath()),
-                            StandardCharsets.UTF_8);
-                    configs.add(UpdateConfig.fromJson(json));
-                } catch (Exception e) {
-                    Log.e("UpdateConfigs", "Can't read/parse config file " + f.getName(), e);
-                    throw new RuntimeException(
-                            "Can't read/parse config file " + f.getName(), e);
-                }
-            }
-        }
-        return configs;
-    }
+			findConfig = false;
+			if (f.isDirectory()) {
+				for (final File f2: f.listFiles()) {
+					if (!f2.isDirectory() && f2.getName().equals(UPDATE_INFO_FILE)) {
+						try {
+							FileInputStream inputStream = new FileInputStream(f2);
+							BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
+							String line;
 
-    /**
-     * @param filename searches by given filename
-     * @param config searches in {@link UpdateConfig#getAbConfig()}
-     * @return offset and size of {@code filename} in the package zip file
-     *         stored as {@link UpdateConfig.PackageFile}.
-     */
-    public static Optional<UpdateConfig.PackageFile> getPropertyFile(
+							if ((line = reader.readLine()) != null && line.equals(ZEEKR_OTA_META)) {
+								if ((line = reader.readLine()) != null) {
+									File pack = new File(UPDATE_MEDIA_ROOT+"/"+ f.getName() + "/" + line);
+									if (pack.exists()) {
+										Log.d("### updater", pack.getName() + " exists");
+										String packName = f.getName() + "/" + line;
+										String packUrl = "file://" + UPDATE_MEDIA_ROOT + "/" + packName;
+										configs.add(new UpdateConfig(packName, packUrl, UpdateConfig.AB_INSTALL_TYPE_NON_STREAMING));
+									}
+									findConfig = true;
+								}
+							}
+							reader.close();
+						} catch (Exception e) {
+							e.printStackTrace();
+						}
+						if (findConfig)
+							break;
+					}
+				}
+			}
+		}
+		return configs;
+	}
+
+	/**
+	 * @param filename searches by given filename
+	 * @param config searches in {@link UpdateConfig#getAbConfig()}
+	 * @return offset and size of {@code filename} in the package zip file
+	 *         stored as {@link UpdateConfig.PackageFile}.
+	 */
+	public static Optional<UpdateConfig.PackageFile> getPropertyFile(
             final String filename,
             UpdateConfig config) {
         return Arrays
-- 
2.25.1

