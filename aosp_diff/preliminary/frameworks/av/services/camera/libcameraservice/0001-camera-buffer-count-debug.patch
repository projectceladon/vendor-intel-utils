From d5211bf232e9677ee420f3201402c2babcb64e6d Mon Sep 17 00:00:00 2001
From: shivasku82 <shiva.kumara.rudrappa@intel.com>
Date: Mon, 19 Jul 2021 14:52:25 +0530
Subject: [PATCH] camera buffer count debug

---
 services/camera/libcameraservice/api1/Camera2Client.cpp       | 4 ++--
 services/camera/libcameraservice/api1/CameraClient.cpp        | 4 ++--
 .../libcameraservice/api1/client2/StreamingProcessor.cpp      | 2 +-
 services/camera/libcameraservice/api2/CameraDeviceClient.cpp  | 2 +-
 services/camera/libcameraservice/common/Camera2ClientBase.cpp | 2 +-
 .../libcameraservice/device1/CameraHardwareInterface.cpp      | 4 ++++
 services/camera/libcameraservice/device3/BufferUtils.cpp      | 2 +-
 .../camera/libcameraservice/device3/Camera3BufferManager.cpp  | 2 +-
 services/camera/libcameraservice/device3/Camera3Device.cpp    | 2 +-
 .../camera/libcameraservice/device3/Camera3OutputStream.cpp   | 3 ++-
 services/camera/libcameraservice/device3/Camera3Stream.cpp    | 2 +-
 11 files changed, 17 insertions(+), 12 deletions(-)

diff --git a/services/camera/libcameraservice/api1/Camera2Client.cpp b/services/camera/libcameraservice/api1/Camera2Client.cpp
index b043c0b557..0afd8ae526 100644
--- a/services/camera/libcameraservice/api1/Camera2Client.cpp
+++ b/services/camera/libcameraservice/api1/Camera2Client.cpp
@@ -14,9 +14,9 @@
  * limitations under the License.
  */
 
-#define LOG_TAG "Camera2Client"
+#define LOG_TAG "api1 Camera2Client"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 
 #include <inttypes.h>
 #include <utils/Log.h>
diff --git a/services/camera/libcameraservice/api1/CameraClient.cpp b/services/camera/libcameraservice/api1/CameraClient.cpp
index 892996c3af..122349f771 100644
--- a/services/camera/libcameraservice/api1/CameraClient.cpp
+++ b/services/camera/libcameraservice/api1/CameraClient.cpp
@@ -14,8 +14,8 @@
  * limitations under the License.
  */
 
-#define LOG_TAG "CameraClient"
-//#define LOG_NDEBUG 0
+#define LOG_TAG "api1 CameraClient"
+#define LOG_NDEBUG 0
 
 #include <cutils/atomic.h>
 #include <cutils/properties.h>
diff --git a/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp b/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp
index 0786f53e61..d9e248ac8f 100644
--- a/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp
+++ b/services/camera/libcameraservice/api1/client2/StreamingProcessor.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera2-StreamingProcessor"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 //#define LOG_NNDEBUG 0 // Per-frame verbose logging
 
 #ifdef LOG_NNDEBUG
diff --git a/services/camera/libcameraservice/api2/CameraDeviceClient.cpp b/services/camera/libcameraservice/api2/CameraDeviceClient.cpp
index e35b4366f2..a147071c14 100644
--- a/services/camera/libcameraservice/api2/CameraDeviceClient.cpp
+++ b/services/camera/libcameraservice/api2/CameraDeviceClient.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "CameraDeviceClient"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 
 #include <cutils/properties.h>
 #include <utils/CameraThreadState.h>
diff --git a/services/camera/libcameraservice/common/Camera2ClientBase.cpp b/services/camera/libcameraservice/common/Camera2ClientBase.cpp
index 0a41776a3e..6ae3c6507b 100644
--- a/services/camera/libcameraservice/common/Camera2ClientBase.cpp
+++ b/services/camera/libcameraservice/common/Camera2ClientBase.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera2ClientBase"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 
 #include <inttypes.h>
 
diff --git a/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp b/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
index 62ef681668..0b9d1f59ce 100644
--- a/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
+++ b/services/camera/libcameraservice/device1/CameraHardwareInterface.cpp
@@ -296,8 +296,10 @@ CameraHardwareInterface::cancelBuffer(uint64_t bufferId) {
 
 hardware::Return<Status>
 CameraHardwareInterface::setBufferCount(uint32_t count) {
+	ALOGE("shiva setBufferCount %d", (int)count);
     ANativeWindow *a = mPreviewWindow.get();
     if (a != nullptr) {
+	    ALOGE("shiva setBufferCount recreate surface");
         // Workaround for b/27039775
         // Previously, setting the buffer count would reset the buffer
         // queue's flag that allows for all buffers to be dequeued on the
@@ -332,6 +334,8 @@ CameraHardwareInterface::setBufferCount(uint32_t count) {
             native_window_set_crop(a, &(mPreviewCrop));
         }
     }
+            ALOGE("shiva setBufferCount2  %d", (int)count);
+
     int rc = native_window_set_buffer_count(a, count);
     if (rc == OK) {
         cleanupCirculatingBuffers();
diff --git a/services/camera/libcameraservice/device3/BufferUtils.cpp b/services/camera/libcameraservice/device3/BufferUtils.cpp
index cc2939062e..fc84a4aa41 100644
--- a/services/camera/libcameraservice/device3/BufferUtils.cpp
+++ b/services/camera/libcameraservice/device3/BufferUtils.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera3-BufUtils"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 //#define LOG_NNDEBUG 0  // Per-frame verbose logging
 
 #include <inttypes.h>
diff --git a/services/camera/libcameraservice/device3/Camera3BufferManager.cpp b/services/camera/libcameraservice/device3/Camera3BufferManager.cpp
index d6bf83eba8..13c9482ea4 100644
--- a/services/camera/libcameraservice/device3/Camera3BufferManager.cpp
+++ b/services/camera/libcameraservice/device3/Camera3BufferManager.cpp
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 #define LOG_TAG "Camera3-BufferManager"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
 
diff --git a/services/camera/libcameraservice/device3/Camera3Device.cpp b/services/camera/libcameraservice/device3/Camera3Device.cpp
index d5f136b84d..c3eb204118 100644
--- a/services/camera/libcameraservice/device3/Camera3Device.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Device.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera3-Device"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 //#define LOG_NNDEBUG 0  // Per-frame verbose logging
 
 #ifdef LOG_NNDEBUG
diff --git a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
index 01ca0064ec..e1104cce16 100644
--- a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera3-OutputStream"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 
 #include <utils/Log.h>
 #include <utils/Trace.h>
@@ -464,6 +464,7 @@ status_t Camera3OutputStream::configureConsumerQueueLocked() {
     mLastTimestamp = 0;
     mUseMonoTimestamp = (isConsumedByHWComposer() | isVideoStream());
 
+    ALOGE("shiva native_window_set_buffer_count %d", (int)mTotalBufferCount);
     res = native_window_set_buffer_count(mConsumer.get(),
             mTotalBufferCount);
     if (res != OK) {
diff --git a/services/camera/libcameraservice/device3/Camera3Stream.cpp b/services/camera/libcameraservice/device3/Camera3Stream.cpp
index 20f616853a..45f5ee6617 100644
--- a/services/camera/libcameraservice/device3/Camera3Stream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Stream.cpp
@@ -16,7 +16,7 @@
 
 #define LOG_TAG "Camera3-Stream"
 #define ATRACE_TAG ATRACE_TAG_CAMERA
-//#define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 
 #include <utils/Log.h>
 #include <utils/Trace.h>
-- 
2.32.0

