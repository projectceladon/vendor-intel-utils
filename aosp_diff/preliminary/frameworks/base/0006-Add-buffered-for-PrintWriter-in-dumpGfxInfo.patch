From 8cfb943e6c4b59bbed08d59b7618395c9ef4e6b5 Mon Sep 17 00:00:00 2001
From: "Gao, HuadongX" <huadongx.gao@intel.com>
Date: Tue, 21 Nov 2023 10:24:05 +0000
Subject: [PATCH] Add buffered for PrintWriter in dumpGfxInfo

The monkey test error:
java.lang.RuntimeException: StrictMode ThreadPolicy violation
...
Caused by: android.os.strictmode.UnbufferedIoViolation

The resolve method:
PrintWrite use BufferedWriter instead of FastPrintWriter.

Tracked-On: OAM-113172
Signed-off-by: Gao, HuadongX <huadongx.gao@intel.com>
---
 core/java/android/view/ThreadedRenderer.java    | 2 +-
 core/java/android/view/WindowManagerGlobal.java | 6 ++++--
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/core/java/android/view/ThreadedRenderer.java b/core/java/android/view/ThreadedRenderer.java
index d839e3532b64..435871afc201 100644
--- a/core/java/android/view/ThreadedRenderer.java
+++ b/core/java/android/view/ThreadedRenderer.java
@@ -491,7 +491,7 @@ public final class ThreadedRenderer extends HardwareRenderer {
     /**
      * Outputs extra debugging information in the specified file descriptor.
      */
-    void dumpGfxInfo(PrintWriter pw, FileDescriptor fd, String[] args) {
+    void dumpGfxInfo(PrintWriter pw, FileDescriptor fd, String[] args) throws Exception {
         pw.flush();
         // If there's no arguments, eg 'dumpsys gfxinfo', then dump everything.
         // If there's a targetted package, eg 'dumpsys gfxinfo com.android.systemui', then only
diff --git a/core/java/android/view/WindowManagerGlobal.java b/core/java/android/view/WindowManagerGlobal.java
index c92a3a086a8b..3f57a3dc71ec 100644
--- a/core/java/android/view/WindowManagerGlobal.java
+++ b/core/java/android/view/WindowManagerGlobal.java
@@ -40,6 +40,8 @@ import com.android.internal.util.FastPrintWriter;
 import java.io.FileDescriptor;
 import java.io.FileOutputStream;
 import java.io.PrintWriter;
+import java.io.BufferedWriter;
+import java.io.OutputStreamWriter;
 import java.util.ArrayList;
 
 /**
@@ -598,9 +600,9 @@ public final class WindowManagerGlobal {
         }
     }
 
-    public void dumpGfxInfo(FileDescriptor fd, String[] args) {
+    public void dumpGfxInfo(FileDescriptor fd, String[] args) throws Exception {
         FileOutputStream fout = new FileOutputStream(fd);
-        PrintWriter pw = new FastPrintWriter(fout);
+        PrintWriter pw = new PrintWriter(new BufferedWriter(new OutputStreamWriter(fout)));
         try {
             synchronized (mLock) {
                 final int count = mViews.size();
-- 
2.34.1

