From b6dcda18039c89751cb293d04bc4a961371dee01 Mon Sep 17 00:00:00 2001
From: Dmitry Dementyev <dementyev@google.com>
Date: Thu, 19 Dec 2024 11:02:42 -0800
Subject: [PATCH] Check account type returned by AbstractAccountAuthenticator.

AccountManagerService already knows which account is used during
AbstractAccountAuthenticator.getAuthToken.

KEY_ACCOUNT_NAME and KEY_ACCOUNT_TYPE in the response look unnecessary,
but we can't change API at this moment.

Bug: 364269936
Test: manual
Flag: EXEMPT bugfix
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:ab3a6b9e5ced38e945b4c4968f6f0afca140d18d)
Merged-In: Ifc62866f4feaca43abc32bc542b97f3741953f56
Change-Id: Ifc62866f4feaca43abc32bc542b97f3741953f56
---
 .../com/android/server/accounts/AccountManagerService.java  | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/services/core/java/com/android/server/accounts/AccountManagerService.java b/services/core/java/com/android/server/accounts/AccountManagerService.java
index 71ed5dbe8ab6..faebe7359eb5 100644
--- a/services/core/java/com/android/server/accounts/AccountManagerService.java
+++ b/services/core/java/com/android/server/accounts/AccountManagerService.java
@@ -3124,6 +3124,12 @@ public class AccountManagerService
                                         "the type and name should not be empty");
                                 return;
                             }
+                            if (!type.equals(mAccountType)) {
+                                onError(AccountManager.ERROR_CODE_INVALID_RESPONSE,
+                                        "incorrect account type");
+                                return;
+                            }
+
                             Account resultAccount = new Account(name, type);
                             if (!customTokens) {
                                 saveAuthTokenToDatabase(
-- 
2.48.1.262.g85cc9f2d1e-goog

