From aa31697ed1de3b525a668d8954eabf3e75401e5d Mon Sep 17 00:00:00 2001
From: Chris Li <lihongyu@google.com>
Date: Wed, 9 Oct 2024 01:50:57 +0000
Subject: [PATCH] Pass SafeActivityOptions with actual caller for
 startActivityInTF

We clearCallingUid before apply the WCT, but SafeActivityOptions will
query the Binder Uid when construct. Update to pass in the actual
caller.

Flag: EXEMPT bug fix
Bug: 369103643
Test: atest WmTests:WindowOrganizerTests#
      testStartActivityInTaskFragment_checkCallerPermission
(cherry picked from commit 20c568e77eae5d469cd5e594b644d8645d830dbd)
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:6c76c394194d40d2704126181313d0a640979606)
Merged-In: I873ae576de0bc4a7402c2f522b45853bce48a0c5
Change-Id: I873ae576de0bc4a7402c2f522b45853bce48a0c5
---
 .../java/com/android/server/wm/ActivityStartController.java  | 5 ++---
 .../com/android/server/wm/WindowOrganizerController.java     | 4 +++-
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/services/core/java/com/android/server/wm/ActivityStartController.java b/services/core/java/com/android/server/wm/ActivityStartController.java
index 32ed4725b3b4..d51b90ef1ec0 100644
--- a/services/core/java/com/android/server/wm/ActivityStartController.java
+++ b/services/core/java/com/android/server/wm/ActivityStartController.java
@@ -39,7 +39,6 @@ import android.content.pm.ApplicationInfo;
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 import android.os.Binder;
-import android.os.Bundle;
 import android.os.IBinder;
 import android.os.UserHandle;
 import android.provider.Settings;
@@ -500,14 +499,14 @@ public class ActivityStartController {
      * Starts an activity in the TaskFragment.
      * @param taskFragment TaskFragment {@link TaskFragment} to start the activity in.
      * @param activityIntent intent to start the activity.
-     * @param activityOptions ActivityOptions to start the activity with.
+     * @param activityOptions SafeActivityOptions to start the activity with.
      * @param resultTo the caller activity
      * @param callingUid the caller uid
      * @param callingPid the caller pid
      * @return the start result.
      */
     int startActivityInTaskFragment(@NonNull TaskFragment taskFragment,
-            @NonNull Intent activityIntent, @Nullable Bundle activityOptions,
+            @NonNull Intent activityIntent, @Nullable SafeActivityOptions activityOptions,
             @Nullable IBinder resultTo, int callingUid, int callingPid,
             @Nullable IBinder errorCallbackToken) {
         final ActivityRecord caller =
diff --git a/services/core/java/com/android/server/wm/WindowOrganizerController.java b/services/core/java/com/android/server/wm/WindowOrganizerController.java
index 0bd28467d649..b7416e0cc97c 100644
--- a/services/core/java/com/android/server/wm/WindowOrganizerController.java
+++ b/services/core/java/com/android/server/wm/WindowOrganizerController.java
@@ -721,8 +721,10 @@ class WindowOrganizerController extends IWindowOrganizerController.Stub
                 }
                 final Intent activityIntent = hop.getActivityIntent();
                 final Bundle activityOptions = hop.getLaunchOptions();
+                final SafeActivityOptions safeOptions =
+                        SafeActivityOptions.fromBundle(activityOptions, caller.mPid, caller.mUid);
                 final int result = mService.getActivityStartController()
-                        .startActivityInTaskFragment(tf, activityIntent, activityOptions,
+                        .startActivityInTaskFragment(tf, activityIntent, safeOptions,
                                 hop.getCallingActivity(), caller.mUid, caller.mPid,
                                 errorCallbackToken);
                 if (!isStartResultSuccessful(result)) {
-- 
2.46.1.824.gd892dcdcdd-goog

