From 4e5202255d5e51d4bc896b9dd0656765cdd5e1e9 Mon Sep 17 00:00:00 2001
From: kanlihu <kanli.hu@intel.com>
Date: Sat, 9 Jul 2022 00:34:15 +0800
Subject: [PATCH] [DO NOT MERGE] for debug enlarge bitmap size

Signed-off-by: Kanli, Hu<kanli.hu@intel.com>
---
 graphics/java/android/graphics/RecordingCanvas.java            | 2 +-
 packages/SystemUI/AndroidManifest.xml                          | 1 +
 .../com/android/server/wallpaper/WallpaperManagerService.java  | 3 ++-
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/graphics/java/android/graphics/RecordingCanvas.java b/graphics/java/android/graphics/RecordingCanvas.java
index c0e0a24583ec..b13563f42729 100644
--- a/graphics/java/android/graphics/RecordingCanvas.java
+++ b/graphics/java/android/graphics/RecordingCanvas.java
@@ -41,7 +41,7 @@ public final class RecordingCanvas extends DisplayListCanvas {
     private static final int POOL_LIMIT = 25;
 
     /** @hide */
-    public static final int MAX_BITMAP_SIZE = 100 * 1024 * 1024; // 100 MB
+    public static final int MAX_BITMAP_SIZE = 300 * 1024 * 1024; // 300 MB
 
     private static final SynchronizedPool<RecordingCanvas> sPool =
             new SynchronizedPool<>(POOL_LIMIT);
diff --git a/packages/SystemUI/AndroidManifest.xml b/packages/SystemUI/AndroidManifest.xml
index ce1eea0a715c..4fc8e5811a56 100644
--- a/packages/SystemUI/AndroidManifest.xml
+++ b/packages/SystemUI/AndroidManifest.xml
@@ -290,6 +290,7 @@
         android:defaultToDeviceProtectedStorage="true"
         android:directBootAware="true"
         tools:replace="android:appComponentFactory"
+        android:largeHeap="true"
         android:appComponentFactory=".SystemUIAppComponentFactory">
         <!-- Keep theme in sync with SystemUIApplication.onCreate().
              Setting the theme on the application does not affect views inflated by services.
diff --git a/services/core/java/com/android/server/wallpaper/WallpaperManagerService.java b/services/core/java/com/android/server/wallpaper/WallpaperManagerService.java
index aaf27d32452d..00c6f796e6f7 100644
--- a/services/core/java/com/android/server/wallpaper/WallpaperManagerService.java
+++ b/services/core/java/com/android/server/wallpaper/WallpaperManagerService.java
@@ -138,7 +138,7 @@ public class WallpaperManagerService extends IWallpaperManager.Stub
     private static final boolean DEBUG_LIVE = true;
 
     // This 100MB limitation is defined in RecordingCanvas.
-    private static final int MAX_BITMAP_SIZE = 100 * 1024 * 1024;
+    private static final int MAX_BITMAP_SIZE = 1000 * 1024 * 1024;
 
     public static class Lifecycle extends SystemService {
         private IWallpaperManagerService mService;
@@ -624,6 +624,7 @@ public class WallpaperManagerService extends IWallpaperManager.Stub
                 needCrop = (options.outHeight > cropHint.height()
                         || options.outWidth > cropHint.width());
             }
+            wpData.mHeight = displayInfo.logicalHeight;
 
             // scale if the crop height winds up not matching the recommended metrics
             needScale = wpData.mHeight != cropHint.height()
-- 
2.31.0

