From 26c99b6c7f20f9eae943358e09732441341d166b Mon Sep 17 00:00:00 2001
From: Ioana Alexandru <aioana@google.com>
Date: Wed, 31 Jul 2024 13:46:30 +0000
Subject: [PATCH] Check more URIs in notifications

Bug: 281044385
Test: presubmit + tested in current release

(cherry picked from commit f47b41a138ebd60f7b518fb6a9d8aa8230488422,
includes changes from commit 57bf60dd7b6a0a0e9785231f8ec25a458fedde64
and commit 47fa2f79584b0a4e9ca7e9c6b237c4e5cf699032)
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:b50af4f855899a63a6b85c5cbfbde8e8236a933e)
Merged-In: I1ce6bebd9452466d005505dc5b99a0fdc0e05e80
Change-Id: I1ce6bebd9452466d005505dc5b99a0fdc0e05e80
---
 core/java/android/app/Person.java         |  3 +++
 core/java/android/widget/RemoteViews.java | 24 +++++++++++++++++++++++
 2 files changed, 27 insertions(+)

diff --git a/core/java/android/app/Person.java b/core/java/android/app/Person.java
index 18fc0ce6af15..c7432c571e43 100644
--- a/core/java/android/app/Person.java
+++ b/core/java/android/app/Person.java
@@ -189,6 +189,9 @@ public final class Person implements Parcelable {
      */
     public void visitUris(@NonNull Consumer<Uri> visitor) {
         visitor.accept(getIconUri());
+        if (mUri != null && !mUri.isEmpty()) {
+            visitor.accept(Uri.parse(mUri));
+        }
     }
 
     /** Builder for the immutable {@link Person} class. */
diff --git a/core/java/android/widget/RemoteViews.java b/core/java/android/widget/RemoteViews.java
index a740b651142d..6ba08f4f1b97 100644
--- a/core/java/android/widget/RemoteViews.java
+++ b/core/java/android/widget/RemoteViews.java
@@ -1084,6 +1084,13 @@ public class RemoteViews implements Parcelable, Filter {
             return SET_REMOTE_VIEW_ADAPTER_LIST_TAG;
         }
 
+        @Override
+        public void visitUris(@NonNull Consumer<Uri> visitor) {
+            for (RemoteViews remoteViews : list) {
+                remoteViews.visitUris(visitor);
+            }
+        }
+
         @Override
         public String getUniqueKey() {
             return (SET_REMOTE_ADAPTER_TAG + "_" + viewId);
@@ -1287,6 +1294,14 @@ public class RemoteViews implements Parcelable, Filter {
             return SET_REMOTE_COLLECTION_ITEMS_ADAPTER_TAG;
         }
 
+        @Override
+        public void visitUris(@NonNull Consumer<Uri> visitor) {
+            RemoteCollectionItems items = getCollectionItemsFromFuture(mItemsFuture);
+            if (items != null) {
+              items.visitUris(visitor);
+            }
+        }
+
         @Override
         public String getUniqueKey() {
             return (SET_REMOTE_ADAPTER_TAG + "_" + viewId);
@@ -7275,6 +7290,15 @@ public class RemoteViews implements Parcelable, Filter {
                         Math.max(mViewTypeCount, 1));
             }
         }
+
+        /**
+         * See {@link RemoteViews#visitUris(Consumer)}.
+         */
+        private void visitUris(@NonNull Consumer<Uri> visitor) {
+            for (RemoteViews view : mViews) {
+                view.visitUris(visitor);
+            }
+        }
     }
 
     /**
-- 
2.34.1

