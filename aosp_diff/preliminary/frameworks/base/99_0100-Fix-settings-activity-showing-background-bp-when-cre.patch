From 5dd3f5a3d6ddeac7ef2c33f71b8f90ce43b139ae Mon Sep 17 00:00:00 2001
From: Hao Dong <spdonghao@google.com>
Date: Fri, 11 Oct 2024 03:54:02 +0000
Subject: [PATCH] Fix settings activity showing background bp when
 createConfirmDeviceCredentialIntent() API is used.

If the app uses createConfirmDeviceCredentialIntent(),
ConfirmDeviceCredentialActivity is the top activity which has "settings"
as package name. Then if the app switches to settings, since previous
foreground check only checks package name, biometric prompt isn't
cancelled. This CL adds a class name check for this case.

Flag: EXEMPT bugfix
Bug: 339532378
Test: manual test with sample app on emulator
Test: atest BiometricActivityTests#testConfirmDeviceCredentialActivityDismiss_whenSwitchToSettings
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:daddef9cd99ab401c4bb0b63ec434c08d549a97d)
Merged-In: I722e285cd15869799b9fadd2324014cf3c6d44ad
Change-Id: I722e285cd15869799b9fadd2324014cf3c6d44ad
---
 .../hardware/biometrics/BiometricPrompt.java  | 14 ++++
 .../hardware/biometrics/PromptInfo.java       | 20 ++++++
 .../biometrics/AuthContainerView.java         |  5 ++
 .../systemui/biometrics/AuthController.java   | 67 +++++++++++++++----
 .../systemui/biometrics/AuthDialog.java       |  6 ++
 5 files changed, 100 insertions(+), 12 deletions(-)

diff --git a/core/java/android/hardware/biometrics/BiometricPrompt.java b/core/java/android/hardware/biometrics/BiometricPrompt.java
index 912e8df6bdc7..8d222a2156f7 100644
--- a/core/java/android/hardware/biometrics/BiometricPrompt.java
+++ b/core/java/android/hardware/biometrics/BiometricPrompt.java
@@ -465,6 +465,20 @@ public class BiometricPrompt implements BiometricAuthenticator, BiometricConstan
         }
         // LINT.ThenChange(frameworks/base/core/java/android/hardware/biometrics/PromptInfo.java)
 
+        /**
+         * Set the class name of ConfirmDeviceCredentialActivity.
+         *
+         * @return This builder.
+         * @hide
+         */
+        @NonNull
+        @RequiresPermission(anyOf = {TEST_BIOMETRIC, USE_BIOMETRIC_INTERNAL})
+        public Builder setClassNameIfItIsConfirmDeviceCredentialActivity() {
+            mPromptInfo.setClassNameIfItIsConfirmDeviceCredentialActivity(
+                    mContext.getClass().getName());
+            return this;
+        }
+
         /**
          * Creates a {@link BiometricPrompt}.
          *
diff --git a/core/java/android/hardware/biometrics/PromptInfo.java b/core/java/android/hardware/biometrics/PromptInfo.java
index e27507874167..b9157c86bb0d 100644
--- a/core/java/android/hardware/biometrics/PromptInfo.java
+++ b/core/java/android/hardware/biometrics/PromptInfo.java
@@ -48,6 +48,7 @@ public class PromptInfo implements Parcelable {
     private boolean mAllowBackgroundAuthentication;
     private boolean mIgnoreEnrollmentState;
     private boolean mIsForLegacyFingerprintManager = false;
+    private String mClassNameIfItIsConfirmDeviceCredentialActivity = null;
 
     public PromptInfo() {
 
@@ -72,6 +73,7 @@ public class PromptInfo implements Parcelable {
         mAllowBackgroundAuthentication = in.readBoolean();
         mIgnoreEnrollmentState = in.readBoolean();
         mIsForLegacyFingerprintManager = in.readBoolean();
+        mClassNameIfItIsConfirmDeviceCredentialActivity = in.readString();
     }
 
     public static final Creator<PromptInfo> CREATOR = new Creator<PromptInfo>() {
@@ -111,6 +113,7 @@ public class PromptInfo implements Parcelable {
         dest.writeBoolean(mAllowBackgroundAuthentication);
         dest.writeBoolean(mIgnoreEnrollmentState);
         dest.writeBoolean(mIsForLegacyFingerprintManager);
+        dest.writeString(mClassNameIfItIsConfirmDeviceCredentialActivity);
     }
 
     // LINT.IfChange
@@ -127,6 +130,8 @@ public class PromptInfo implements Parcelable {
             return true;
         } else if (mIgnoreEnrollmentState) {
             return true;
+        } else if (mClassNameIfItIsConfirmDeviceCredentialActivity != null) {
+            return true;
         }
         return false;
     }
@@ -228,6 +233,13 @@ public class PromptInfo implements Parcelable {
         mAllowedSensorIds.add(sensorId);
     }
 
+    /**
+     * Set the class name of ConfirmDeviceCredentialActivity.
+     */
+    void setClassNameIfItIsConfirmDeviceCredentialActivity(String className) {
+        mClassNameIfItIsConfirmDeviceCredentialActivity = className;
+    }
+
     // Getters
 
     public CharSequence getTitle() {
@@ -309,4 +321,12 @@ public class PromptInfo implements Parcelable {
     public boolean isForLegacyFingerprintManager() {
         return mIsForLegacyFingerprintManager;
     }
+
+    /**
+     * Get the class name of ConfirmDeviceCredentialActivity. Returns null if the direct caller is
+     * not ConfirmDeviceCredentialActivity.
+     */
+    public String getClassNameIfItIsConfirmDeviceCredentialActivity() {
+        return mClassNameIfItIsConfirmDeviceCredentialActivity;
+    }
 }
diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/AuthContainerView.java b/packages/SystemUI/src/com/android/systemui/biometrics/AuthContainerView.java
index 802a550c4d29..3e245a959819 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/AuthContainerView.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/AuthContainerView.java
@@ -801,6 +801,11 @@ public class AuthContainerView extends LinearLayout
         }
     }
 
+    @Override
+    public String getClassNameIfItIsConfirmDeviceCredentialActivity() {
+        return  mConfig.mPromptInfo.getClassNameIfItIsConfirmDeviceCredentialActivity();
+    }
+
     @Override
     public String getOpPackageName() {
         return mConfig.mOpPackageName;
diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/AuthController.java b/packages/SystemUI/src/com/android/systemui/biometrics/AuthController.java
index d5289a49be51..99ebb505ea93 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/AuthController.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/AuthController.java
@@ -26,6 +26,7 @@ import android.app.ActivityManager;
 import android.app.ActivityTaskManager;
 import android.app.TaskStackListener;
 import android.content.BroadcastReceiver;
+import android.content.ComponentName;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
@@ -249,18 +250,21 @@ public class AuthController implements CoreStartable, CommandQueue.Callbacks,
         mExecution.assertIsMainThread();
         if (mCurrentDialog != null) {
             try {
-                mCurrentDialog.dismissWithoutCallback(true /* animate */);
-                mCurrentDialog = null;
-
-                for (Callback cb : mCallbacks) {
-                    cb.onBiometricPromptDismissed();
-                }
-
-                if (mReceiver != null) {
-                    mReceiver.onDialogDismissed(
-                            BiometricPrompt.DISMISSED_REASON_USER_CANCEL,
-                            null /* credentialAttestation */);
-                    mReceiver = null;
+                if (isOwnerInBackground()) {
+                    Log.w(TAG, "Evicting client due to top activity is not : "
+                            + mCurrentDialog.getOpPackageName());
+                    mCurrentDialog.dismissWithoutCallback(true /* animate */);
+                    mCurrentDialog = null;
+
+                    for (Callback cb : mCallbacks) {
+                        cb.onBiometricPromptDismissed();
+                    }
+                    if (mReceiver != null) {
+                        mReceiver.onDialogDismissed(
+                                BiometricPrompt.DISMISSED_REASON_USER_CANCEL,
+                                null /* credentialAttestation */);
+                        mReceiver = null;
+		    }
                 }
             } catch (RemoteException e) {
                 Log.e(TAG, "Remote exception", e);
@@ -268,6 +272,45 @@ public class AuthController implements CoreStartable, CommandQueue.Callbacks,
         }
     }
 
+    private boolean isOwnerInBackground() {
+        if (mCurrentDialog != null) {
+            final String clientPackage = mCurrentDialog.getOpPackageName();
+
+            final List<ActivityManager.RunningTaskInfo> runningTasks =
+                    mActivityTaskManager.getTasks(1);
+            if (runningTasks == null || runningTasks.isEmpty()) {
+                Log.w(TAG, "No running tasks reported");
+                return false;
+            }
+
+            final boolean isSystemApp = Utils.isSystem(mContext, clientPackage);
+
+            final ComponentName topActivity = runningTasks.get(0).topActivity;
+            final String topPackage =  topActivity.getPackageName();
+            final boolean topPackageEqualsToClient =
+                    topPackage == null
+                            || topActivity.getPackageName().contentEquals(clientPackage);
+
+            // b/339532378: If it's ConfirmDeviceCredentialActivity, we need to check further on
+            // class name.
+            final String clientClassNameForCDCA =
+                    mCurrentDialog.getClassNameIfItIsConfirmDeviceCredentialActivity();
+            final boolean isClientCDCA = clientClassNameForCDCA != null;
+            final String topClassName = topActivity.getClassName();
+            final boolean isCDCAWithWrongTopClass =
+                    isClientCDCA
+                            && !(topClassName == null
+                                    || topClassName.contentEquals(clientClassNameForCDCA));
+
+            final boolean isInBackground =
+                    !(isSystemApp || topPackageEqualsToClient) || isCDCAWithWrongTopClass;
+
+            Log.w(TAG, "isInBackground " + isInBackground);
+            return isInBackground;
+        }
+        return false;
+    }
+
     /**
      * Whether all fingerprint authentictors have been registered.
      */
diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/AuthDialog.java b/packages/SystemUI/src/com/android/systemui/biometrics/AuthDialog.java
index 3cfc6f280110..c30d058db5a0 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/AuthDialog.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/AuthDialog.java
@@ -159,6 +159,12 @@ public interface AuthDialog extends Dumpable {
     /** The requestId of the underlying operation within the framework. */
     long getRequestId();
 
+    /**
+     * Get the class name of ConfirmDeviceCredentialActivity. Returns null if the direct caller is
+     * not ConfirmDeviceCredentialActivity.
+     */
+    String getClassNameIfItIsConfirmDeviceCredentialActivity();
+
     /**
      * Animate to credential UI. Typically called after biometric is locked out.
      */
-- 
2.34.1

