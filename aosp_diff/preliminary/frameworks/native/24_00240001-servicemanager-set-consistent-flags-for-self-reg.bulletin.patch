From fea775468179d34ae0a601010c97399a1e4f3a7d Mon Sep 17 00:00:00 2001
From: Steven Moreland <smoreland@google.com>
Date: Fri, 6 Dec 2024 23:55:35 +0000
Subject: [PATCH] servicemanager: set consistent flags for self-reg

SM has special flags set to become a context object, but
these were not set when it registers as itself.

Bug: 382775095
Test: boot w/ harsher checks
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:6ac542d1d0420f97ddef52991533662e96760fa9)
Merged-In: I0fb567cbcca67a2fc6c088f652c8af570b8d7e53
Change-Id: I0fb567cbcca67a2fc6c088f652c8af570b8d7e53
---
 cmds/servicemanager/main.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/cmds/servicemanager/main.cpp b/cmds/servicemanager/main.cpp
index 8c1beaca20..d8cc8e6a20 100644
--- a/cmds/servicemanager/main.cpp
+++ b/cmds/servicemanager/main.cpp
@@ -122,6 +122,7 @@ int main(int argc, char** argv) {
     ps->setCallRestriction(ProcessState::CallRestriction::FATAL_IF_NOT_ONEWAY);
 
     sp<ServiceManager> manager = sp<ServiceManager>::make(std::make_unique<Access>());
+    manager->setRequestingSid(true);
     if (!manager->addService("manager", manager, false /*allowIsolated*/, IServiceManager::DUMP_FLAG_PRIORITY_DEFAULT).isOk()) {
         LOG(ERROR) << "Could not self register servicemanager";
     }
-- 
2.48.1.262.g85cc9f2d1e-goog

