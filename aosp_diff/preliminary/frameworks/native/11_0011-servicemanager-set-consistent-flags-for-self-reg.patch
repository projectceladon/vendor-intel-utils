From 4f8e6b437f1a74fbb435dcb778e62f7a0ff0677e Mon Sep 17 00:00:00 2001
From: Steven Moreland <smoreland@google.com>
Date: Fri, 6 Dec 2024 23:55:35 +0000
Subject: [PATCH] servicemanager: set consistent flags for self-reg

SM has special flags set to become a context object, but
these were not set when it registers as itself.

Bug: 382775095
Test: boot w/ harsher checks
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:5075f8244827f9403a70843749be8e13bd7b06a6)
Merged-In: I0fb567cbcca67a2fc6c088f652c8af570b8d7e53
Change-Id: I0fb567cbcca67a2fc6c088f652c8af570b8d7e53
---
 cmds/servicemanager/main.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/cmds/servicemanager/main.cpp b/cmds/servicemanager/main.cpp
index bc9cb1609d..3e9b7b938f 100644
--- a/cmds/servicemanager/main.cpp
+++ b/cmds/servicemanager/main.cpp
@@ -128,6 +128,7 @@ int main(int argc, char** argv) {
     IPCThreadState::self()->disableBackgroundScheduling(true);
 
     sp<ServiceManager> manager = sp<ServiceManager>::make(std::make_unique<Access>());
+    manager->setRequestingSid(true);
     if (!manager->addService("manager", manager, false /*allowIsolated*/, IServiceManager::DUMP_FLAG_PRIORITY_DEFAULT).isOk()) {
         LOG(ERROR) << "Could not self register servicemanager";
     }
-- 
2.34.1

