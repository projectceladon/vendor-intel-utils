From f4e439c22354f0aa868a982bc88bcc9de3bc37f7 Mon Sep 17 00:00:00 2001
From: Hui Peng <phui@google.com>
Date: Mon, 28 Aug 2023 15:59:32 -0700
Subject: [PATCH] Reject access to secure services authenticated from temp
 bonding [2]

Reject access to service running on rfcomm

this is a backport of
I10fcc2dcd78fc22ffbe3c425669fc9889b94a166

Bug: 294854926
Test: m com.android.btservices
Ignore-AOSP-First: security
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:9878a84e7eebb49ba994a9bbdd2258ecf4b3abb8)
Merged-In: I10fcc2dcd78fc22ffbe3c425669fc9889b94a166
Change-Id: I10fcc2dcd78fc22ffbe3c425669fc9889b94a166
---
 system/stack/btm/btm_sec.cc | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/system/stack/btm/btm_sec.cc b/system/stack/btm/btm_sec.cc
index 92ede3616a..d19a952b61 100644
--- a/system/stack/btm/btm_sec.cc
+++ b/system/stack/btm/btm_sec.cc
@@ -1898,6 +1898,11 @@ tBTM_STATUS btm_sec_mx_access_request(const RawAddress& bd_addr,
                                security_required, p_callback, p_ref_data);
     } else /* rc == BTM_SUCCESS */
     {
+      if (access_secure_service_from_temp_bond(p_dev_rec,
+          is_originator, security_required)) {
+        LOG_ERROR("Trying to access a secure rfcomm service from a temp bonding, reject");
+        rc = BTM_FAILED_ON_SECURITY;
+      }
       if (p_callback) {
         LOG_DEBUG("Notifying client that security access has been granted");
         (*p_callback)(&bd_addr, transport, p_ref_data, rc);
-- 
2.42.0.820.g83a721a137-goog

