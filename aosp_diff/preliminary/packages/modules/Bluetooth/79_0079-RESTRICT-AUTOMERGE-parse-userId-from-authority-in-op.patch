From e08c0a0aff552d0b2b221c37d583aeabf661ce62 Mon Sep 17 00:00:00 2001
From: Billy Huang <billyhuang@google.com>
Date: Fri, 7 Mar 2025 14:09:29 -0800
Subject: [PATCH] RESTRICT AUTOMERGE parse userId from authority in opp in the
 same way as ContentProvider

Ensures that userId determination is consistent with ContentProvider

Bug: 395647005
Bug: 395643490
Flag: EXEMPT fix for vulnerability
Test: m com.google.android.bt
Test: atest BluetoothJavaUnitTests:com.android.bluetooth.opp.BluetoothOppSendFileInfoTest
Ignore-AOSP-First: fix for undisclosed vulnerability
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:05aa8869c2b6cbd15aba2d8e2cbdddf934b72f03)
(cherry picked from https://googleplex-android-review.googlesource.com/q/commit:9dffd1fdd141bfc3b4420b2500cd5895276c2977)
Merged-In: Iacb9b1fc1fe48d9b8512f6e80bcc6eeb2a5bedbd
Change-Id: Iacb9b1fc1fe48d9b8512f6e80bcc6eeb2a5bedbd
---
 .../opp/BluetoothOppSendFileInfo.java         | 23 ++++++++++++++++++-
 android/app/tests/unit/Android.bp             |  1 +
 .../opp/BluetoothOppSendFileInfoTest.java     |  4 +++-
 3 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/android/app/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java b/android/app/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java
index 7ce134341a..971de621e7 100644
--- a/android/app/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java
+++ b/android/app/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java
@@ -262,8 +262,29 @@ public class BluetoothOppSendFileInfo {
         return new BluetoothOppSendFileInfo(fileName, contentType, length, is, 0);
     }
 
+   /**
+     * Determine if the given {@link Uri} is a content uri for another user.
+     *
+     * <p>RFC 2396 s.3.2. states that <tt>'@'</tt> is reserved in the authority component. Its
+     * encoded form should be interpreted as data within the authority component. However,
+     * ContentProvider APIs use the decoded {@link Uri#getAuthority()} with {@link
+     * ContentProvider#getUserIdFromAuthority(String, int)} to determine the <tt>userId</tt> in the
+     * userInfo, rather than {@link Uri#getUserInfo()}. An encoded <tt>'@'</tt>, which is
+     * <tt>'%40'</tt>, is interpreted by ContentProvider as the separator for userInfo and host.
+     *
+     * <p>As an unbundled module, Bluetooth cannot access ContentProvider#getUserIdFromAuthority, so
+     * parse userInfo here from the authority.
+     */
     private static boolean isContentUriForOtherUser(Uri uri) {
-        String uriUserId = uri.getUserInfo();
+        String authority = uri.getAuthority();
+        if (authority == null) {
+            return false;
+        }
+        int atIndex = authority.lastIndexOf('@');
+        if (atIndex == -1) {
+            return false;
+        }
+        String uriUserId = authority.substring(0, atIndex);
         return !TextUtils.isEmpty(uriUserId)
                 && !Objects.equals(uriUserId, String.valueOf(myUserId()));
     }
diff --git a/android/app/tests/unit/Android.bp b/android/app/tests/unit/Android.bp
index 196b7a4c7c..be445069b0 100755
--- a/android/app/tests/unit/Android.bp
+++ b/android/app/tests/unit/Android.bp
@@ -19,6 +19,7 @@ java_defaults {
 
     static_libs: [
         "androidx.media_media",
+	"TestParameterInjector",
         "androidx.test.ext.truth",
         "androidx.test.rules",
         "mockito-target",
diff --git a/android/app/tests/unit/src/com/android/bluetooth/opp/BluetoothOppSendFileInfoTest.java b/android/app/tests/unit/src/com/android/bluetooth/opp/BluetoothOppSendFileInfoTest.java
index 756836afaa..b99981ec3b 100644
--- a/android/app/tests/unit/src/com/android/bluetooth/opp/BluetoothOppSendFileInfoTest.java
+++ b/android/app/tests/unit/src/com/android/bluetooth/opp/BluetoothOppSendFileInfoTest.java
@@ -35,6 +35,8 @@ import android.util.Log;
 
 import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.runner.AndroidJUnit4;
+import com.google.testing.junit.testparameterinjector.TestParameter;
+import com.google.testing.junit.testparameterinjector.TestParameterInjector;
 
 import com.android.bluetooth.BluetoothMethodProxy;
 
@@ -48,7 +50,7 @@ import org.mockito.MockitoAnnotations;
 import java.io.FileInputStream;
 import java.io.IOException;
 
-@RunWith(AndroidJUnit4.class)
+@RunWith(TestParameterInjector.class)
 public class BluetoothOppSendFileInfoTest {
     Context mContext;
     MatrixCursor mCursor;
-- 
2.34.1

