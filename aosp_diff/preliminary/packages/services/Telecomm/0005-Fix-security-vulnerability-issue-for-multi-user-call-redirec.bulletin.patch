From 5b763ee4c498b1625130379c435e1c1844fb4ec6 Mon Sep 17 00:00:00 2001
From: Grace Jia <xiaotonj@google.com>
Date: Thu, 25 Aug 2022 14:47:19 -0700
Subject: [PATCH] Fix security vulnerability issue for multi user call
 redirections.

Currently we won't check if the PhoneAccountHandle provided by a
CallRedirectionService has multi-user capability or belong to the same
user as the current user. Add the check and disconnect the call if this
is an unexpected cross-user call redirection.

Bug: 235098883
Test: CallsManagerTest, manual test with test app provided in
b/235098883.

Change-Id: Ia8b9468aa2bb8e3157c227e2617ff6a52e0af119
Merged-In: Ia8b9468aa2bb8e3157c227e2617ff6a52e0af119
(cherry picked from commit f29ab7e1ec0e480e2d39d289d5aa3fc95aed2142)
(cherry picked from commit 735b84a90e5305915836329d4abca672fcc87126)
(cherry picked from commit 799347b6f65da163673b4f8358783f3087ff08a2)
(cherry picked from commit bfb817b9950178a430132e678faef18ea69ecea0)
Merged-In: Ia8b9468aa2bb8e3157c227e2617ff6a52e0af119
---
 src/com/android/server/telecom/CallsManager.java | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/com/android/server/telecom/CallsManager.java b/src/com/android/server/telecom/CallsManager.java
index cd13a928..73cdd5b1 100755
--- a/src/com/android/server/telecom/CallsManager.java
+++ b/src/com/android/server/telecom/CallsManager.java
@@ -2097,7 +2097,7 @@ public class CallsManager extends Call.ListenerBase
                 && !phoneAccount.hasCapabilities(PhoneAccount.CAPABILITY_MULTI_USER)) {
             // Check if the phoneAccountHandle belongs to the current user
             if (phoneAccountHandle != null &&
-                    !phoneAccountHandle.getUserHandle().equals(mCurrentUserHandle)) {
+                    !phoneAccountHandle.getUserHandle().equals(call.getInitiatingUser())) {
                 phoneAccountHandle = null;
             }
         }
-- 
2.39.0.rc1.256.g54fd8350bd-goog

