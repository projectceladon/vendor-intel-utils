From 523ec03a3914ad8bde0f73d503633734101942f4 Mon Sep 17 00:00:00 2001
From: "Li, HaihongX" <haihongx.li@intel.com>
Date: Mon, 8 Aug 2022 16:38:47 +0800
Subject: [PATCH] Compile goldfish-opengl in celadon

Comment the license to compile successfully

Tracked-On:
Signed-off-by: Li, HaihongX <haihongx.li@intel.com>
---
 Android.bp                                  | 10 ++++--
 Android.mk                                  |  6 ++--
 android-emu/Android.bp                      |  2 +-
 shared/GoldfishAddressSpace/Android.bp      |  2 +-
 shared/gralloc_cb/Android.bp                |  2 +-
 shared/qemupipe/Android.bp                  |  2 +-
 system/codecs/c2/decoders/avcdec/Android.bp |  2 +-
 system/codecs/c2/decoders/base/Android.bp   |  2 +-
 system/codecs/c2/decoders/vpxdec/Android.bp |  2 +-
 system/codecs/c2/service/Android.bp         |  2 +-
 system/codecs/c2/store/Android.bp           |  2 +-
 system/hwc2/Android.mk                      |  2 --
 system/hwc2/include/drmhwcgralloc.h         | 40 +++++++++++++++++++++
 13 files changed, 61 insertions(+), 15 deletions(-)
 create mode 100644 system/hwc2/include/drmhwcgralloc.h

diff --git a/Android.bp b/Android.bp
index b4f361f4..4bcb959e 100644
--- a/Android.bp
+++ b/Android.bp
@@ -14,10 +14,10 @@
  * limitations under the License.
  */
 
-soong_namespace {}
+//soong_namespace {}
 
 package {
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 // Added automatically by a large-scale-change that took the approach of
@@ -34,6 +34,7 @@ package {
 // to attach the license to, and including a comment whether the files may be
 // used in the current project.
 // See: http://go/android-license-faq
+/*
 license {
     name: "device_generic_goldfish-opengl_license",
     visibility: [":__subpackages__"],
@@ -47,3 +48,8 @@ license {
         "LICENSE",
     ],
 }
+*/
+
+//optional_subdirs = [
+//    "*"
+//]
diff --git a/Android.mk b/Android.mk
index 3444354a..5a736d40 100644
--- a/Android.mk
+++ b/Android.mk
@@ -16,7 +16,7 @@ GOLDFISH_OPENGL_PATH := $(call my-dir)
 #
 # Variable controlling whether the build for goldfish-opengl
 # libraries (including their Android.mk's) should be triggered.
-GOLDFISH_OPENGL_SHOULD_BUILD := false
+GOLDFISH_OPENGL_SHOULD_BUILD := true
 
 # In the host build, some libraries have name collisions with
 # other libraries, so we have this variable here to control
@@ -35,7 +35,7 @@ EMUGL_COMMON_INCLUDES := $(GOLDFISH_OPENGL_PATH)/host/include/libOpenglRender $(
 EMUGL_COMMON_CFLAGS := -DWITH_GLES2
 
 # Whether or not to build the Vulkan library.
-GFXSTREAM := false
+GFXSTREAM := true
 
 # Host build
 ifeq (true,$(GOLDFISH_OPENGL_BUILD_FOR_HOST))
@@ -68,6 +68,8 @@ EMUGL_COMMON_CFLAGS += \
 
 endif # GOLDFISH_OPENGL_BUILD_FOR_HOST
 
+BUILD_EMULATOR_OPENGL := true
+
 ifeq (true,$(BUILD_EMULATOR_OPENGL)) # Guest build
 
 GOLDFISH_OPENGL_SHOULD_BUILD := true
diff --git a/android-emu/Android.bp b/android-emu/Android.bp
index b83cab95..0d8690da 100644
--- a/android-emu/Android.bp
+++ b/android-emu/Android.bp
@@ -5,7 +5,7 @@ package {
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
     //   SPDX-license-identifier-GPL-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+    //default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_shared {
diff --git a/shared/GoldfishAddressSpace/Android.bp b/shared/GoldfishAddressSpace/Android.bp
index 11e2450c..5f9f63cc 100644
--- a/shared/GoldfishAddressSpace/Android.bp
+++ b/shared/GoldfishAddressSpace/Android.bp
@@ -4,7 +4,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_static {
diff --git a/shared/gralloc_cb/Android.bp b/shared/gralloc_cb/Android.bp
index 2e5976ae..66dd23c5 100644
--- a/shared/gralloc_cb/Android.bp
+++ b/shared/gralloc_cb/Android.bp
@@ -20,7 +20,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_headers {
diff --git a/shared/qemupipe/Android.bp b/shared/qemupipe/Android.bp
index 478328cf..9eed8038 100644
--- a/shared/qemupipe/Android.bp
+++ b/shared/qemupipe/Android.bp
@@ -20,7 +20,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_headers {
diff --git a/system/codecs/c2/decoders/avcdec/Android.bp b/system/codecs/c2/decoders/avcdec/Android.bp
index 78ffd820..09959d88 100644
--- a/system/codecs/c2/decoders/avcdec/Android.bp
+++ b/system/codecs/c2/decoders/avcdec/Android.bp
@@ -4,7 +4,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_shared {
diff --git a/system/codecs/c2/decoders/base/Android.bp b/system/codecs/c2/decoders/base/Android.bp
index 58e26a30..533dc188 100644
--- a/system/codecs/c2/decoders/base/Android.bp
+++ b/system/codecs/c2/decoders/base/Android.bp
@@ -6,7 +6,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_shared {
diff --git a/system/codecs/c2/decoders/vpxdec/Android.bp b/system/codecs/c2/decoders/vpxdec/Android.bp
index 7be2d50f..3f5089ce 100644
--- a/system/codecs/c2/decoders/vpxdec/Android.bp
+++ b/system/codecs/c2/decoders/vpxdec/Android.bp
@@ -4,7 +4,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-Apache-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_shared {
diff --git a/system/codecs/c2/service/Android.bp b/system/codecs/c2/service/Android.bp
index 40570a7e..44cc93a1 100644
--- a/system/codecs/c2/service/Android.bp
+++ b/system/codecs/c2/service/Android.bp
@@ -4,7 +4,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-BSD
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_binary {
diff --git a/system/codecs/c2/store/Android.bp b/system/codecs/c2/store/Android.bp
index 56b18953..7ff79332 100644
--- a/system/codecs/c2/store/Android.bp
+++ b/system/codecs/c2/store/Android.bp
@@ -4,7 +4,7 @@ package {
     // all of the 'license_kinds' from "device_generic_goldfish-opengl_license"
     // to get the below license kinds:
     //   SPDX-license-identifier-GPL-2.0
-    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
+//    default_applicable_licenses: ["device_generic_goldfish-opengl_license"],
 }
 
 cc_library_shared {
diff --git a/system/hwc2/Android.mk b/system/hwc2/Android.mk
index 4d207ff9..91c1f0fe 100644
--- a/system/hwc2/Android.mk
+++ b/system/hwc2/Android.mk
@@ -76,7 +76,6 @@ LOCAL_SHARED_LIBRARIES += libOpenglSystemCommon lib_renderControl_enc
 LOCAL_SHARED_LIBRARIES += libui
 LOCAL_SRC_FILES := $(emulator_hwcomposer2_src_files)
 LOCAL_C_INCLUDES := $(emulator_hwcomposer_c_includes)
-LOCAL_C_INCLUDES += external/drm_hwcomposer
 LOCAL_C_INCLUDES += external/minigbm/cros_gralloc
 LOCAL_MODULE_RELATIVE_PATH := $(emulator_hwcomposer_relative_path)
 
@@ -97,7 +96,6 @@ LOCAL_SHARED_LIBRARIES += libui
 LOCAL_SHARED_LIBRARIES += libdrm
 LOCAL_C_INCLUDES := $(emulator_hwcomposer_c_includes)
 LOCAL_C_INCLUDES += external/libdrm
-LOCAL_C_INCLUDES += external/drm_hwcomposer
 LOCAL_C_INCLUDES += external/minigbm/cros_gralloc
 LOCAL_MODULE := emulatorDrmTest
 LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
diff --git a/system/hwc2/include/drmhwcgralloc.h b/system/hwc2/include/drmhwcgralloc.h
new file mode 100644
index 00000000..fc0af64e
--- /dev/null
+++ b/system/hwc2/include/drmhwcgralloc.h
@@ -0,0 +1,40 @@
+/*
+ * Copyright (C) 2015 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#ifndef ANDROID_DRMHWCGRALLOC_H_
+#define ANDROID_DRMHWCGRALLOC_H_
+
+#include <stdint.h>
+
+#define HWC_DRM_BO_MAX_PLANES 4
+typedef struct hwc_drm_bo {
+  uint32_t width;
+  uint32_t height;
+  uint32_t format;     /* DRM_FORMAT_* from drm_fourcc.h */
+  uint32_t hal_format; /* HAL_PIXEL_FORMAT_* */
+  uint32_t usage;
+  uint32_t pitches[HWC_DRM_BO_MAX_PLANES];
+  uint32_t offsets[HWC_DRM_BO_MAX_PLANES];
+  uint32_t prime_fds[HWC_DRM_BO_MAX_PLANES];
+  uint32_t gem_handles[HWC_DRM_BO_MAX_PLANES];
+  uint64_t modifiers[HWC_DRM_BO_MAX_PLANES];
+  uint32_t fb_id;
+  bool with_modifiers;
+  int acquire_fence_fd;
+  void *priv;
+} hwc_drm_bo_t;
+
+#endif  // ANDROID_DRMHWCGRALLOC_H_
-- 
2.37.1

