From 7e5a2afacfac5e941b0e4c204b87deb499226619 Mon Sep 17 00:00:00 2001
From: Priyanka Bose <priyanka.bose@intel.com>
Date: Mon, 12 Dec 2022 03:44:17 +0000
Subject: [PATCH] Libavc Fix

Signed-off-by: Priyanka Bose <priyanka.bose@intel.com>
---
 common/x86/ih264_ihadamard_scaling_avx2.c   | 4 ++--
 common/x86/ih264_iquant_itrans_recon_avx2.c | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/common/x86/ih264_ihadamard_scaling_avx2.c b/common/x86/ih264_ihadamard_scaling_avx2.c
index 3f4ec8f..40f2dfa 100644
--- a/common/x86/ih264_ihadamard_scaling_avx2.c
+++ b/common/x86/ih264_ihadamard_scaling_avx2.c
@@ -107,7 +107,7 @@ void ih264_ihadamard_scaling_4x4_avx2(WORD16* pi2_src,
     __m256i src,r0_r1,r2_r3,r3_r2,r1_r3,r0_r2;
     __m256i src_r0_r1, src_r2_r3;
     __m256i temp0, temp1,tmp0, tmp1, tmp2, tmp3;
-    __m256i add_rshift = _mm256_set1_epi32((1 << (5 - u4_qp_div_6)));
+    __m256i add_rshift = _mm256_set1_epi32((u4_qp_div_6 < 6) ? (1 << (5 - u4_qp_div_6)) : 0);
     __m256i mult_val = _mm256_set1_epi32(pu2_iscal_mat[0] * pu2_weigh_mat[0]);
     __m256i zero =  _mm256_setzero_si256();
 
@@ -167,7 +167,7 @@ void ih264_ihadamard_scaling_4x4_avx2(WORD16* pi2_src,
     //Scaling
     if(u4_qp_div_6 >= 6)
     {
-        src_r0_r1 = _mm256_slli_epi16(src_r0_r1, u4_qp_div_6 - 6);
+        src_r0_r1 = _mm256_slli_epi32(src_r0_r1, u4_qp_div_6 - 6);
         src_r2_r3 = _mm256_slli_epi32(src_r2_r3, u4_qp_div_6 - 6);
     }
     else
diff --git a/common/x86/ih264_iquant_itrans_recon_avx2.c b/common/x86/ih264_iquant_itrans_recon_avx2.c
index 31e15a4..ad06901 100644
--- a/common/x86/ih264_iquant_itrans_recon_avx2.c
+++ b/common/x86/ih264_iquant_itrans_recon_avx2.c
@@ -123,7 +123,7 @@ void ih264_iquant_itrans_recon_4x4_avx2(WORD16 *pi2_src,
     __m256i zero_8x32b = _mm256_setzero_si256();          // all bits reset to zero
     __m256i temp0, temp1, temp2, temp3, temp4, temp5, temp6, temp7;
     __m256i resq_r0, resq_r1, resq_r2, resq_r3;
-    __m256i add_rshift = _mm256_set1_epi32((1 << (3 - u4_qp_div_6)));
+    __m256i add_rshift = _mm256_set1_epi32((u4_qp_div_6 < 4) ? (1 << (3 - u4_qp_div_6)) : 0);
     __m256i value_32 = _mm256_set1_epi32(32);
     __m128i value_32_128 = _mm_set1_epi32(32);
     __m128i r0,r1,r2,r3,t0,t1,t2,t3,t4,t5,t6,t7,sign_reg_128, de_r0_r1,de_r2_r3,r0_r1,r2_r3,scale_r0_r1,scale_r2_r3;
-- 
2.37.3

