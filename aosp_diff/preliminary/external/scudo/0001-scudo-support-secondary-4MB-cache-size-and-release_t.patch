From d9ce7058921de9dc302fd67a9aaf8a687bdecea2 Mon Sep 17 00:00:00 2001
From: "Liu, Kai1" <kai1.liu@intel.com>
Date: Wed, 12 Jul 2023 09:52:25 +0800
Subject: [PATCH] scudo: support secondary 4MB cache size and
 release_to_os_ms=5000

---
 standalone/allocator_config.h | 12 ++++++------
 standalone/primary64.h        |  2 +-
 2 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/standalone/allocator_config.h b/standalone/allocator_config.h
index 8e103f2..0e70238 100644
--- a/standalone/allocator_config.h
+++ b/standalone/allocator_config.h
@@ -94,16 +94,16 @@ struct AndroidConfig {
   static const uptr PrimaryRegionSizeLog = 18U;
   typedef uptr PrimaryCompactPtrT;
 #endif
-  static const s32 PrimaryMinReleaseToOsIntervalMs = 1000;
-  static const s32 PrimaryMaxReleaseToOsIntervalMs = 1000;
+  static const s32 PrimaryMinReleaseToOsIntervalMs = 5000;
+  static const s32 PrimaryMaxReleaseToOsIntervalMs = 5000;
 
   typedef MapAllocatorCache<AndroidConfig> SecondaryCache;
   static const u32 SecondaryCacheEntriesArraySize = 256U;
   static const u32 SecondaryCacheQuarantineSize = 32U;
-  static const u32 SecondaryCacheDefaultMaxEntriesCount = 32U;
-  static const uptr SecondaryCacheDefaultMaxEntrySize = 2UL << 20;
-  static const s32 SecondaryCacheMinReleaseToOsIntervalMs = 0;
-  static const s32 SecondaryCacheMaxReleaseToOsIntervalMs = 1000;
+  static const u32 SecondaryCacheDefaultMaxEntriesCount = 64U;
+  static const uptr SecondaryCacheDefaultMaxEntrySize = 4UL << 20;
+  static const s32 SecondaryCacheMinReleaseToOsIntervalMs = 5000;
+  static const s32 SecondaryCacheMaxReleaseToOsIntervalMs = 5000;
 
   template <class A>
   using TSDRegistryT = TSDRegistrySharedT<A, 8U, 2U>; // Shared, max 8 TSDs.
diff --git a/standalone/primary64.h b/standalone/primary64.h
index 94375fc..4c0df52 100644
--- a/standalone/primary64.h
+++ b/standalone/primary64.h
@@ -185,7 +185,7 @@ public:
         continue;
       RegionInfo *Region = getRegionInfo(I);
       ScopedLock L(Region->Mutex);
-      TotalReleasedBytes += releaseToOSMaybe(Region, I, /*Force=*/true);
+      TotalReleasedBytes += releaseToOSMaybe(Region, I, /*Force=*/false);
     }
     return TotalReleasedBytes;
   }
-- 
2.33.1

