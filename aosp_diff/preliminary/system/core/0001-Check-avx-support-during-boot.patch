From 540dbc97d26abf1805839cc9f262c3ce1723e630 Mon Sep 17 00:00:00 2001
From: ahs <amrita.h.s@intel.com>
Date: Wed, 21 Oct 2020 09:17:30 +0530
Subject: [PATCH] Check avx support during boot

Tracked-On:
Signed-off-by: ahs <amrita.h.s@intel.com>
---
 rootdir/checkavx.sh | 8 ++++++++
 rootdir/init.rc     | 4 ++++
 2 files changed, 12 insertions(+)
 create mode 100755 rootdir/checkavx.sh

diff --git a/rootdir/checkavx.sh b/rootdir/checkavx.sh
new file mode 100755
index 000000000..3d611bc0d
--- /dev/null
+++ b/rootdir/checkavx.sh
@@ -0,0 +1,8 @@
+#!/system/bin/sh
+
+IS_AVX2=`cat /proc/cpuinfo | grep -w "avx2" | wc -l`
+if [ $IS_AVX2 -gt 1 ]
+   then	
+     setprop dalvik.vm.isa.x86.variant kabylake
+     setprop dalvik.vm.isa.x86_64.variant kabylake
+fi     
diff --git a/rootdir/init.rc b/rootdir/init.rc
index 510d1e911..1050ff747 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -803,6 +803,10 @@ on post-fs-data
     # Enable FUSE by default
     setprop persist.sys.fuse true
 
+    # AHS
+    chmod 744 /checkavx.sh
+    exec - system system -- /system/bin/sh /checkavx.sh
+
 # Switch between sdcardfs and FUSE depending on persist property
 # TODO: Move this to ro property before launch because FDE devices
 # interact with persistent properties differently during boot
-- 
2.17.1

