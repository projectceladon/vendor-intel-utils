From 5a4fa77d6600ff3f9f105fb5e9919ff718de67a4 Mon Sep 17 00:00:00 2001
From: Balaji M <m.balaji@intel.com>
Date: Wed, 13 Jan 2021 10:54:35 +0530
Subject: [PATCH] adb : dbc : not working

Do not merge

Tracked-On:
Signed-off-by: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
---
 adb/daemon/main.cpp |  1 +
 adb/daemon/usb.cpp  | 17 ++++++++++++++---
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/adb/daemon/main.cpp b/adb/daemon/main.cpp
index 544dcb90b..d612577fa 100644
--- a/adb/daemon/main.cpp
+++ b/adb/daemon/main.cpp
@@ -237,6 +237,7 @@ int adbd_main(int server_port) {
 
 #if defined(__ANDROID__)
     if ((access(USB_FFS_ADB_EP0, F_OK) == 0) || (access(USB_DBC_ADB_PATH,F_OK) == 0)) {
+	    LOG(INFO) << "Prabhat : adb daemon main.\n";
         // Listen on USB.
         usb_init();
         is_usb = true;
diff --git a/adb/daemon/usb.cpp b/adb/daemon/usb.cpp
index 5aeaccedb..b7a70aae6 100644
--- a/adb/daemon/usb.cpp
+++ b/adb/daemon/usb.cpp
@@ -169,6 +169,7 @@ struct ScopedAioContext {
     aio_context_t context_ = 0;
 };
 
+
 struct UsbFfsConnection : public Connection {
     UsbFfsConnection(unique_fd control, unique_fd read, unique_fd write,
                      std::promise<void> destruction_notifier)
@@ -178,7 +179,7 @@ struct UsbFfsConnection : public Connection {
           control_fd_(std::move(control)),
           read_fd_(std::move(read)),
           write_fd_(std::move(write)) {
-        LOG(INFO) << "UsbFfsConnection constructed";
+        LOG(INFO) << "Prabhat : UsbFfsConnection constructed";
         worker_event_fd_.reset(eventfd(0, EFD_CLOEXEC));
         if (worker_event_fd_ == -1) {
             PLOG(FATAL) << "failed to create eventfd";
@@ -739,6 +740,7 @@ struct UsbFfsConnection : public Connection {
 };
 
 static void usb_dbc_open_thread() {
+	LOG(INFO) << "Prabhat : adb daemon usb dbc open.\n";
     adb_thread_setname("usb dbc open");
 
     while (true) {
@@ -755,6 +757,7 @@ static void usb_dbc_open_thread() {
 }
 
 static void usb_ffs_open_thread() {
+	LOG(INFO) << "Prabhat : adb daemon usb ffs open.\n";
     adb_thread_setname("usb ffs open");
 
     while (true) {
@@ -779,8 +782,16 @@ static void usb_ffs_open_thread() {
 }
 
 void usb_init() {
-    if (access(USB_DBC_ADB_PATH,F_OK) == 0)
+    int err_no = access(USB_DBC_ADB_PATH,F_OK);
+
+    LOG(INFO) << "Prabhat : USB_DBC_ADB_PATH err_no : %d : " << err_no;
+
+    if (err_no == 0) {
+	LOG(INFO) << "Prabhat : adb daemon usb init : " << USB_DBC_ADB_PATH;
         std::thread(usb_dbc_open_thread).detach();
-    else
+    }
+    else {
+	    LOG(INFO) << "Prabhat : adb daemon usb init : USB_FFS.\n";
         std::thread(usb_ffs_open_thread).detach();
+    }
 }
-- 
2.17.1

