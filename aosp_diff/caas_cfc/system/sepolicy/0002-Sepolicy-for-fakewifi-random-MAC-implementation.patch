From 65231aef8651b8aeb908622af30552bf23285f50 Mon Sep 17 00:00:00 2001
From: Aiswarya Cyriac <aiswarya.cyriac@intel.com>
Date: Fri, 11 Feb 2022 09:41:08 +0530
Subject: [PATCH] Sepolicy for fakewifi random MAC implementation

Tracked-On: OAM-100226
Signed-off-by: Aiswarya Cyriac <aiswarya.cyriac@intel.com>
---
 prebuilts/api/30.0/private/compat/29.0/29.0.ignore.cil | 3 ++-
 prebuilts/api/30.0/private/platform_app.te             | 2 ++
 prebuilts/api/30.0/private/property_contexts           | 1 +
 prebuilts/api/30.0/private/system_app.te               | 4 ++++
 prebuilts/api/30.0/private/untrusted_app.te            | 1 +
 prebuilts/api/30.0/private/untrusted_app_29.te         | 1 +
 prebuilts/api/30.0/public/property.te                  | 1 +
 private/compat/29.0/29.0.ignore.cil                    | 3 ++-
 private/platform_app.te                                | 2 ++
 private/property_contexts                              | 1 +
 private/system_app.te                                  | 4 ++++
 private/untrusted_app.te                               | 1 +
 private/untrusted_app_29.te                            | 1 +
 public/property.te                                     | 1 +
 14 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/prebuilts/api/30.0/private/compat/29.0/29.0.ignore.cil b/prebuilts/api/30.0/private/compat/29.0/29.0.ignore.cil
index 87da98e9c..b9dea1239 100644
--- a/prebuilts/api/30.0/private/compat/29.0/29.0.ignore.cil
+++ b/prebuilts/api/30.0/private/compat/29.0/29.0.ignore.cil
@@ -130,4 +130,5 @@
     vendor_socket_hook_prop
     vendor_socket_hook_prop
     virtual_ab_prop
-    p9fs2))
+    p9fs2
+    wifi_fakewifi_prop))
diff --git a/prebuilts/api/30.0/private/platform_app.te b/prebuilts/api/30.0/private/platform_app.te
index 3beec38e0..81f228a41 100644
--- a/prebuilts/api/30.0/private/platform_app.te
+++ b/prebuilts/api/30.0/private/platform_app.te
@@ -100,3 +100,5 @@ allow platform_app app_data_file:lnk_file create_file_perms;
 
 # app domains which access /dev/fuse should not run as platform_app
 neverallow platform_app fuse_device:chr_file *;
+
+allow platform_app sysfs_net:dir search;
diff --git a/prebuilts/api/30.0/private/property_contexts b/prebuilts/api/30.0/private/property_contexts
index a4fab1f22..8bc69340d 100644
--- a/prebuilts/api/30.0/private/property_contexts
+++ b/prebuilts/api/30.0/private/property_contexts
@@ -268,3 +268,4 @@ init.userspace_reboot.watchdog.timeoutmillis u:object_r:userspace_reboot_config_
 
 # surfaceflinger-settable
 graphics.display.kernel_idle_timer.enabled u:object_r:surfaceflinger_display_prop:s0 exact bool
+persist.wifi.fakewifi.mac u:object_r:wifi_fakewifi_prop:s0 exact string
diff --git a/prebuilts/api/30.0/private/system_app.te b/prebuilts/api/30.0/private/system_app.te
index 06dac78ce..6b6fd0093 100644
--- a/prebuilts/api/30.0/private/system_app.te
+++ b/prebuilts/api/30.0/private/system_app.te
@@ -163,3 +163,7 @@ neverallow system_app fuse_device:chr_file *;
 # bug reports, but not reads.
 neverallow system_app shell_data_file:dir { no_w_dir_perms open search read };
 neverallow system_app shell_data_file:file { open read ioctl lock };
+
+allow system_app sysfs_net:dir search;
+allow system_app wifi_fakewifi_prop:file { getattr map open read };
+allow system_app wifi_fakewifi_prop:property_service set;
diff --git a/prebuilts/api/30.0/private/untrusted_app.te b/prebuilts/api/30.0/private/untrusted_app.te
index 6e7a99cd8..5c0b809b2 100644
--- a/prebuilts/api/30.0/private/untrusted_app.te
+++ b/prebuilts/api/30.0/private/untrusted_app.te
@@ -14,3 +14,4 @@ app_domain(untrusted_app)
 untrusted_app_domain(untrusted_app)
 net_domain(untrusted_app)
 bluetooth_domain(untrusted_app)
+allow untrusted_app sysfs_net:dir search;
diff --git a/prebuilts/api/30.0/private/untrusted_app_29.te b/prebuilts/api/30.0/private/untrusted_app_29.te
index 344ae89bd..4035c1e32 100644
--- a/prebuilts/api/30.0/private/untrusted_app_29.te
+++ b/prebuilts/api/30.0/private/untrusted_app_29.te
@@ -17,3 +17,4 @@ bluetooth_domain(untrusted_app_29)
 
 # allow binding to netlink route sockets and sending RTM_GETLINK messages.
 allow untrusted_app_29 self:netlink_route_socket { bind nlmsg_readpriv };
+allow untrusted_app_29 sysfs_net:dir search;
diff --git a/prebuilts/api/30.0/public/property.te b/prebuilts/api/30.0/public/property.te
index 43b09db8d..adf652826 100644
--- a/prebuilts/api/30.0/public/property.te
+++ b/prebuilts/api/30.0/public/property.te
@@ -26,6 +26,7 @@ system_internal_prop(userspace_reboot_test_prop)
 system_internal_prop(system_adbd_prop)
 system_internal_prop(adbd_prop)
 system_internal_prop(traced_perf_enabled_prop)
+system_internal_prop(wifi_fakewifi_prop)
 
 compatible_property_only(`
     # DO NOT ADD ANY PROPERTIES HERE
diff --git a/private/compat/29.0/29.0.ignore.cil b/private/compat/29.0/29.0.ignore.cil
index 87da98e9c..b9dea1239 100644
--- a/private/compat/29.0/29.0.ignore.cil
+++ b/private/compat/29.0/29.0.ignore.cil
@@ -130,4 +130,5 @@
     vendor_socket_hook_prop
     vendor_socket_hook_prop
     virtual_ab_prop
-    p9fs2))
+    p9fs2
+    wifi_fakewifi_prop))
diff --git a/private/platform_app.te b/private/platform_app.te
index 3beec38e0..81f228a41 100644
--- a/private/platform_app.te
+++ b/private/platform_app.te
@@ -100,3 +100,5 @@ allow platform_app app_data_file:lnk_file create_file_perms;
 
 # app domains which access /dev/fuse should not run as platform_app
 neverallow platform_app fuse_device:chr_file *;
+
+allow platform_app sysfs_net:dir search;
diff --git a/private/property_contexts b/private/property_contexts
index a4fab1f22..8bc69340d 100644
--- a/private/property_contexts
+++ b/private/property_contexts
@@ -268,3 +268,4 @@ init.userspace_reboot.watchdog.timeoutmillis u:object_r:userspace_reboot_config_
 
 # surfaceflinger-settable
 graphics.display.kernel_idle_timer.enabled u:object_r:surfaceflinger_display_prop:s0 exact bool
+persist.wifi.fakewifi.mac u:object_r:wifi_fakewifi_prop:s0 exact string
diff --git a/private/system_app.te b/private/system_app.te
index 06dac78ce..6b6fd0093 100644
--- a/private/system_app.te
+++ b/private/system_app.te
@@ -163,3 +163,7 @@ neverallow system_app fuse_device:chr_file *;
 # bug reports, but not reads.
 neverallow system_app shell_data_file:dir { no_w_dir_perms open search read };
 neverallow system_app shell_data_file:file { open read ioctl lock };
+
+allow system_app sysfs_net:dir search;
+allow system_app wifi_fakewifi_prop:file { getattr map open read };
+allow system_app wifi_fakewifi_prop:property_service set;
diff --git a/private/untrusted_app.te b/private/untrusted_app.te
index 6e7a99cd8..5c0b809b2 100644
--- a/private/untrusted_app.te
+++ b/private/untrusted_app.te
@@ -14,3 +14,4 @@ app_domain(untrusted_app)
 untrusted_app_domain(untrusted_app)
 net_domain(untrusted_app)
 bluetooth_domain(untrusted_app)
+allow untrusted_app sysfs_net:dir search;
diff --git a/private/untrusted_app_29.te b/private/untrusted_app_29.te
index 344ae89bd..4035c1e32 100644
--- a/private/untrusted_app_29.te
+++ b/private/untrusted_app_29.te
@@ -17,3 +17,4 @@ bluetooth_domain(untrusted_app_29)
 
 # allow binding to netlink route sockets and sending RTM_GETLINK messages.
 allow untrusted_app_29 self:netlink_route_socket { bind nlmsg_readpriv };
+allow untrusted_app_29 sysfs_net:dir search;
diff --git a/public/property.te b/public/property.te
index 43b09db8d..adf652826 100644
--- a/public/property.te
+++ b/public/property.te
@@ -26,6 +26,7 @@ system_internal_prop(userspace_reboot_test_prop)
 system_internal_prop(system_adbd_prop)
 system_internal_prop(adbd_prop)
 system_internal_prop(traced_perf_enabled_prop)
+system_internal_prop(wifi_fakewifi_prop)
 
 compatible_property_only(`
     # DO NOT ADD ANY PROPERTIES HERE
-- 
2.35.1

