From e158066bce0a120cff9dd5a3af812420115a7c18 Mon Sep 17 00:00:00 2001
From: Hongcheng Xie <hongcheng.xie@intel.com>
Date: Tue, 5 Mar 2019 10:18:37 +0800
Subject: [PATCH] Add warning for AaaS Demo

Change-Id: I0fd673e9b8799514d9c7242bb6dd2d563cffbac0
Tracked-On:
Signed-off-by: Zhuangzhi Li <zhuangzhi.li@intel.com>
---
 core/res/res/layout/early_access.xml               | 26 ++++++++++++++++++++++
 core/res/res/values/symbols.xml                    |  1 +
 .../android/server/am/ActivityManagerService.java  | 16 +++++++++++++
 services/java/com/android/server/SystemServer.java |  3 +++
 4 files changed, 46 insertions(+)
 create mode 100644 core/res/res/layout/early_access.xml

diff --git a/core/res/res/layout/early_access.xml b/core/res/res/layout/early_access.xml
new file mode 100644
index 0000000..b791a4b
--- /dev/null
+++ b/core/res/res/layout/early_access.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2006 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<TextView xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="wrap_content" android:layout_height="wrap_content"
+    android:textAppearance="?android:attr/textAppearanceLarge"
+    android:gravity="left|bottom"
+    android:padding="3dp"
+    android:background="@drawable/safe_mode_background"
+    android:textColor="#ffff0000"
+    android:text="Powered by Celadon. Demo purpose, still in early development."
+    android:textSize="15dp"
+/>
diff --git a/core/res/res/values/symbols.xml b/core/res/res/values/symbols.xml
index afb67f9..d70dcd6 100644
--- a/core/res/res/values/symbols.xml
+++ b/core/res/res/values/symbols.xml
@@ -2057,6 +2057,7 @@
   <java-symbol type="layout" name="am_compat_mode_dialog" />
   <java-symbol type="layout" name="launch_warning" />
   <java-symbol type="layout" name="safe_mode" />
+  <java-symbol type="layout" name="early_access" />
   <java-symbol type="layout" name="simple_list_item_2_single_choice" />
   <java-symbol type="layout" name="app_error_dialog" />
   <java-symbol type="plurals" name="wifi_available" />
diff --git a/services/core/java/com/android/server/am/ActivityManagerService.java b/services/core/java/com/android/server/am/ActivityManagerService.java
index 91ae156..0df7473 100644
--- a/services/core/java/com/android/server/am/ActivityManagerService.java
+++ b/services/core/java/com/android/server/am/ActivityManagerService.java
@@ -8524,6 +8524,22 @@ public class ActivityManagerService extends IActivityManager.Stub
                 Context.WINDOW_SERVICE)).addView(v, lp);
     }
 
+    public final void showEarlyAccessWarning() {
+        View v = LayoutInflater.from(mContext).inflate(
+                com.android.internal.R.layout.early_access, null);
+        WindowManager.LayoutParams lp = new WindowManager.LayoutParams();
+        lp.type = WindowManager.LayoutParams.TYPE_SECURE_SYSTEM_OVERLAY;
+        lp.width = WindowManager.LayoutParams.WRAP_CONTENT;
+        lp.height = WindowManager.LayoutParams.WRAP_CONTENT;
+        lp.gravity = Gravity.BOTTOM | Gravity.RIGHT;
+        lp.format = v.getBackground().getOpacity();
+        lp.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE
+                | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE;
+        lp.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_SHOW_FOR_ALL_USERS;
+        ((WindowManager)mContext.getSystemService(
+                Context.WINDOW_SERVICE)).addView(v, lp);
+    }
+
     @Override
     public void noteWakeupAlarm(IIntentSender sender, WorkSource workSource, int sourceUid,
             String sourcePkg, String tag) {
diff --git a/services/java/com/android/server/SystemServer.java b/services/java/com/android/server/SystemServer.java
index 133b82f..f288046 100644
--- a/services/java/com/android/server/SystemServer.java
+++ b/services/java/com/android/server/SystemServer.java
@@ -1949,6 +1949,9 @@ public final class SystemServer {
             mActivityManagerService.showSafeModeOverlay();
         }
 
+        // Show Android new dessert early access warning
+        mActivityManagerService.showEarlyAccessWarning();
+
         // Update the configuration for this context by hand, because we're going
         // to start using it before the config change done in wm.systemReady() will
         // propagate to it.
-- 
2.7.4

