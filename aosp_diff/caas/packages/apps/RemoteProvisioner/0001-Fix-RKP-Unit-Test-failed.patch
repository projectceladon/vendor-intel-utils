From e5ff9502792db386c6078f943ec88c10dca04e26 Mon Sep 17 00:00:00 2001
From: tangweix <weix.tang@intel.com>
Date: Tue, 8 Nov 2022 14:21:18 +0800
Subject: [PATCH] Fix: RKP Unit Test failed.

Skip the test when ethernet is connected.

Change-Id: I4c778945ff3f0bc3a6bfa597834145a836740703
---
 .../unittest/ServerToSystemTest.java          | 21 +++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/tests/unittests/src/com/android/remoteprovisioner/unittest/ServerToSystemTest.java b/tests/unittests/src/com/android/remoteprovisioner/unittest/ServerToSystemTest.java
index 1d077ec..b665fa0 100644
--- a/tests/unittests/src/com/android/remoteprovisioner/unittest/ServerToSystemTest.java
+++ b/tests/unittests/src/com/android/remoteprovisioner/unittest/ServerToSystemTest.java
@@ -17,6 +17,7 @@
 package com.android.remoteprovisioner.unittest;
 
 import static android.hardware.security.keymint.SecurityLevel.TRUSTED_ENVIRONMENT;
+import static android.net.NetworkCapabilities.TRANSPORT_ETHERNET;
 import static android.security.keystore.KeyProperties.KEY_ALGORITHM_EC;
 import static android.security.keystore.KeyProperties.PURPOSE_SIGN;
 import static android.security.keystore.KeyProperties.SECURITY_LEVEL_TRUSTED_ENVIRONMENT;
@@ -31,7 +32,9 @@ import static org.junit.Assert.fail;
 import android.Manifest;
 import android.app.ActivityThread;
 import android.content.Context;
+import android.content.pm.PackageManager;
 import android.net.ConnectivityManager;
+import android.net.Network;
 import android.net.NetworkInfo;
 import android.os.ServiceManager;
 import android.os.SystemProperties;
@@ -135,6 +138,9 @@ public class ServerToSystemTest {
     private static int sCurve = 0;
 
     private Duration mDuration;
+        /** Whether the device running these tests supports ethernet. */
+    private boolean mHasEthernet;
+    private ConnectivityManager mCm;
 
     // Helper class that sets rkp_only to true if it's not already set, then restores the state on
     // close. Intended to be used in a try expression: try (RkpOnlyContext c = new RkpOnlyContext())
@@ -466,6 +472,10 @@ public class ServerToSystemTest {
 
     @Test
     public void testRetryWithoutNetworkTee() throws Exception {
+        mCm = sContext.getSystemService(ConnectivityManager.class);
+        mHasEthernet = sContext.getPackageManager()
+                .hasSystemFeature(PackageManager.FEATURE_ETHERNET);
+        Assume.assumeFalse("not testable, since ethernet is connected", hasEthernetConnection());
         setAirplaneMode(true);
         try (ForceRkpOnlyContext c = new ForceRkpOnlyContext()) {
             assertPoolStatus(0, 0, 0, 0, mDuration);
@@ -483,6 +493,17 @@ public class ServerToSystemTest {
         }
     }
 
+    private boolean hasEthernetConnection() {
+        if (!mHasEthernet) return false;
+        Network[] networks = mCm.getAllNetworks();
+        for (Network network : networks) {
+            if (mCm.getNetworkCapabilities(network).hasTransport(TRANSPORT_ETHERNET)) {
+                return true;
+            }
+        }
+        return false;
+    }
+
     @Test
     public void testRetryNeverWhenDeviceNotRegistered() throws Exception {
         final NanoHTTPD server = new NanoHTTPD("localhost", 0) {
-- 
2.25.1

