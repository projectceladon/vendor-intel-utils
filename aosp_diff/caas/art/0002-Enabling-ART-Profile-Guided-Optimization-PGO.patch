From d5ac3ea7d73a01c215ac283d87f4afe5e367b040 Mon Sep 17 00:00:00 2001
From: Priyanka Bose <priyanka.bose@intel.com>
Date: Wed, 13 May 2020 01:29:18 +0530
Subject: [PATCH] Enabling ART Profile Guided Optimization(PGO)

Change-Id: I2b5a94da466641908ae5b5d8ee0ae8bec716e9f8
Signed-off-by: Priyanka Bose <priyanka.bose@intel.com>
---
 runtime/Android.bp | 52 +++++++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 51 insertions(+), 1 deletion(-)

diff --git a/runtime/Android.bp b/runtime/Android.bp
index a7b94f5..f600fa6 100644
--- a/runtime/Android.bp
+++ b/runtime/Android.bp
@@ -449,6 +449,46 @@ libart_static_cc_defaults {
 }
 
 cc_defaults {
+     name: "libart-pgo-defaults",
+     pgo: {
+         instrumentation: true,
+         benchmarks: ["art_runtime", "dex2oat",],
+     },
+     target: {
+         android_arm64: {
+             pgo: {
+                 profile_file: "art/art-runtime_arm_arm64.profdata",
+             },
+         },
+         android_arm: {
+             pgo: {
+                 profile_file: "art/art-runtime_arm_arm64.profdata",
+             },
+         },
+         android_x86_64: {
+             pgo: {
+                 profile_file: "art/libart-x86-x86_64.profdata.2019-06-06",
+             },
+         },
+         android_x86: {
+             pgo: {
+                 profile_file: "art/libart-x86-x86_64.profdata.2019-06-06",
+             },
+         },
+	 android_mips64: {
+             pgo: {
+                 profile_file: "art/art-runtime_mips_mips64.profdata",
+             },
+         },
+         android_mips: {
+             pgo: {
+                 profile_file: "art/art-runtime_mips_mips64.profdata",
+             },
+         },
+     },
+}
+
+cc_defaults {
     name: "libart_static_defaults",
     defaults: [
         "libart_static_base_defaults",
@@ -521,7 +561,9 @@ gensrcs {
 
 art_cc_library {
     name: "libart",
-    defaults: ["libart_defaults"],
+    defaults: ["libart_defaults",
+               "libart-pgo-defaults",
+    ],
     // Leave the symbols in the shared library so that stack unwinders can
     // produce meaningful name resolution.
     strip: {
@@ -540,6 +582,14 @@ art_cc_library {
     export_shared_lib_headers: [
         "libdexfile",
     ],
+    pgo: {
+         // Additional cflags just for dex2oat during PGO instrumentation
+        cflags: [
+        // Ignore frame-size increase resulting from instrumentation.
+	    "-Wno-frame-larger-than=",
+	    "-DART_PGO_INSTRUMENTATION",
+        ],
+    },
     target: {
         android: {
             lto: {
-- 
2.7.4

