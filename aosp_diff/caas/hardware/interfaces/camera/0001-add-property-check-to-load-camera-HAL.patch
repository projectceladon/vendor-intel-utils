From b1e2f4f645e3b0aaf0216461f6f0f925f8dc3d72 Mon Sep 17 00:00:00 2001
From: gkdeepa <g.k.deepa@intel.com>
Date: Mon, 11 Oct 2021 15:36:21 +0530
Subject: [PATCH] add property check to load camera HAL

Tracked-On:
---
 .../2.4/default/ExternalCameraProviderImpl_2_4.cpp        | 2 ++
 .../provider/2.4/default/LegacyCameraProviderImpl_2_4.cpp | 8 ++++++++
 2 files changed, 10 insertions(+)

diff --git a/camera/provider/2.4/default/ExternalCameraProviderImpl_2_4.cpp b/camera/provider/2.4/default/ExternalCameraProviderImpl_2_4.cpp
index 64a51f614..23653b336 100644
--- a/camera/provider/2.4/default/ExternalCameraProviderImpl_2_4.cpp
+++ b/camera/provider/2.4/default/ExternalCameraProviderImpl_2_4.cpp
@@ -213,6 +213,8 @@ void ExternalCameraProviderImpl_2_4::addExternalCamera(const char* devName) {
     ALOGI("ExtCam: adding %s to External Camera HAL!", devName);
     Mutex::Autolock _l(mLock);
     std::string deviceName;
+    //set the camera property as External usb cam usage
+    property_set("vendor.camera.external","USBV");
     std::string cameraId = std::to_string(mCfg.cameraIdOffset +
                                           std::atoi(devName + kDevicePrefixLen));
     if (mPreferredHal3MinorVersion == 6) {
diff --git a/camera/provider/2.4/default/LegacyCameraProviderImpl_2_4.cpp b/camera/provider/2.4/default/LegacyCameraProviderImpl_2_4.cpp
index 4cff1b79a..6a799afc7 100644
--- a/camera/provider/2.4/default/LegacyCameraProviderImpl_2_4.cpp
+++ b/camera/provider/2.4/default/LegacyCameraProviderImpl_2_4.cpp
@@ -57,6 +57,14 @@ bool matchDeviceName(const hidl_string& deviceName, std::string* deviceVersion,
         if (cameraId != nullptr) {
             *cameraId = sm[2];
         }
+        //get camera property to check if external camera is detected
+        char mode[PROPERTY_VALUE_MAX];
+        if(property_get("vendor.camera.external", mode, nullptr) > 0){
+            if (!strcmp(mode, "USBV")){
+                ALOGE("Donot load legacy camera as USB is PT and video nodes with guest");
+                return false;
+            }
+        }
         return true;
     }
     return false;
-- 
2.17.1

