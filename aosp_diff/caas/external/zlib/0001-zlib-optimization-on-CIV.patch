From 09b43fff3b478aab0c9dc2180c4d848b01f2712d Mon Sep 17 00:00:00 2001
From: Shwetha B <shwetha.b@intel.com>
Date: Sat, 6 Jan 2024 18:16:43 +0530
Subject: [PATCH] zlib optimization on CIV

Tracked-On: OAM-114487
Signed-off-by: Shwetha B <shwetha.b@intel.com>
---
 Android.bp | 1 +
 BUILD.gn   | 6 +++++-
 deflate.c  | 2 +-
 3 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/Android.bp b/Android.bp
index 3be6ff8..565c91e 100644
--- a/Android.bp
+++ b/Android.bp
@@ -47,6 +47,7 @@ cflags_android_x86 = [
     // Android's x86/x86-64 ABI includes SSE2 and SSSE3.
     "-UCPU_NO_SIMD",
     "-DADLER32_SIMD_SSSE3",
+    "-DFASTEST",
 ]
 
 // This optimization is applicable to arm64 and x86-64.
diff --git a/BUILD.gn b/BUILD.gn
index b85067a..8e762f3 100644
--- a/BUILD.gn
+++ b/BUILD.gn
@@ -94,7 +94,9 @@ source_set("zlib_adler32_simd") {
     ]
 
     if (!is_win || is_clang) {
-      cflags = [ "-mssse3" ]
+      cflags = [ "-mssse3",
+		 "-march=core-avx2",
+		]
     }
   }
 
@@ -184,6 +186,7 @@ source_set("zlib_inflate_chunk_simd") {
 
   if (use_x86_x64_optimizations || use_arm_neon_optimizations) {
     include_dirs = [ "." ]
+    cflags_c = [ "-march=core-avx2" ]
 
     sources = [
       "contrib/optimizations/chunkcopy.h",
@@ -226,6 +229,7 @@ source_set("zlib_crc32_simd") {
       cflags = [
         "-msse4.2",
         "-mpclmul",
+	"-march=core-avx2",
       ]
     }
   }
diff --git a/deflate.c b/deflate.c
index 413590f..5b36cee 100644
--- a/deflate.c
+++ b/deflate.c
@@ -61,7 +61,7 @@
 
 #ifdef FASTEST
 /* See http://crbug.com/1113596 */
-#error "FASTEST is not supported in Chromium's zlib."
+//#error "FASTEST is not supported in Chromium's zlib."
 #endif
 
 const char deflate_copyright[] =
-- 
2.43.0

