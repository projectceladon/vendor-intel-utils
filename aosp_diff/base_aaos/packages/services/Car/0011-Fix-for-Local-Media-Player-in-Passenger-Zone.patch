From 5028d9dffc8f28d33afa6201c03ba6ba1b093812 Mon Sep 17 00:00:00 2001
From: Ankit Agrawal <ankit.agarwal@intel.com>
Date: Tue, 27 Jun 2023 10:48:38 +0530
Subject: [PATCH] Fix for Local Media Player in Passenger Zone.

Currently MultiDisplay launcher does not have capability
to show launcher icons for media services app, as these apps
does not have any launcher category, So it does not show icon in
launcher app.

Querying all MediaBrowsingService apps and adding them in launcher.

Tracked-On: OAM-106796
Signed-off-by: Ankit Agrawal <ankit.agarwal@intel.com>
---
 ...preinstalled-packages-product-car-base.xml |  1 +
 .../car/multidisplay/launcher/AppEntry.java   | 23 ++++++++++++++-----
 .../launcher/AppListLiveData.java             | 11 ++++++++-
 .../launcher/PinnedAppListLiveData.java       | 10 +++++++-
 4 files changed, 37 insertions(+), 8 deletions(-)

diff --git a/car_product/build/preinstalled-packages-product-car-base.xml b/car_product/build/preinstalled-packages-product-car-base.xml
index dcd93a843..73e09432b 100644
--- a/car_product/build/preinstalled-packages-product-car-base.xml
+++ b/car_product/build/preinstalled-packages-product-car-base.xml
@@ -66,6 +66,7 @@
     <install-in-user-type package="com.android.car">
         <install-in user-type="FULL" />
         <install-in user-type="SYSTEM" />
+        <install-in user-type="PROFILE" />
     </install-in-user-type>
         <install-in-user-type package="com.android.car.shell">
         <install-in user-type="FULL" />
diff --git a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppEntry.java b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppEntry.java
index 3bc5b647a..873190605 100644
--- a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppEntry.java
+++ b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppEntry.java
@@ -16,6 +16,7 @@
 
 package com.android.car.multidisplay.launcher;
 
+import android.car.Car;
 import android.content.ComponentName;
 import android.content.Intent;
 import android.content.pm.PackageManager;
@@ -29,12 +30,22 @@ public  class AppEntry {
     private Drawable mIcon;
     private Intent mLaunchIntent;
 
-    AppEntry(ResolveInfo info, PackageManager packageManager) {
-        mLabel = info.loadLabel(packageManager).toString();
-        mIcon = info.loadIcon(packageManager);
-        mLaunchIntent = new Intent();
-        mLaunchIntent.setComponent(new ComponentName(info.activityInfo.packageName,
-                info.activityInfo.name));
+    AppEntry(ResolveInfo info, PackageManager packageManager, boolean mediaApp) {
+        if(mediaApp) {
+            mLabel = info.serviceInfo.loadLabel(packageManager).toString();
+            mIcon = info.serviceInfo.loadIcon(packageManager);
+            String packageName = info.serviceInfo.packageName;
+            String className = info.serviceInfo.name;
+            ComponentName componentName = new ComponentName(packageName, className);
+            mLaunchIntent = new Intent(Car.CAR_INTENT_ACTION_MEDIA_TEMPLATE);
+            mLaunchIntent.putExtra(Car.CAR_EXTRA_MEDIA_COMPONENT, componentName.flattenToString());
+        } else {
+            mLabel = info.loadLabel(packageManager).toString();
+            mIcon = info.loadIcon(packageManager);
+            mLaunchIntent = new Intent();
+            mLaunchIntent.setComponent(new ComponentName(info.activityInfo.packageName,
+                    info.activityInfo.name));
+        }
     }
 
     String getLabel() {
diff --git a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppListLiveData.java b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppListLiveData.java
index 8e2e34e3e..6eaaa0746 100644
--- a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppListLiveData.java
+++ b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/AppListLiveData.java
@@ -21,6 +21,7 @@ import android.content.Intent;
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 import android.os.AsyncTask;
+import android.service.media.MediaBrowserService;
 
 import androidx.lifecycle.LiveData;
 
@@ -52,10 +53,18 @@ class AppListLiveData extends LiveData<List<AppEntry>> {
                 List<AppEntry> entries = new ArrayList<>();
                 if (apps != null) {
                     for (ResolveInfo app : apps) {
-                        AppEntry entry = new AppEntry(app, mPackageManager);
+                        AppEntry entry = new AppEntry(app, mPackageManager, false);
                         entries.add(entry);
                     }
                 }
+
+                List<ResolveInfo> mediaServices = mPackageManager.queryIntentServices(
+                        new Intent(MediaBrowserService.SERVICE_INTERFACE),
+                        PackageManager.GET_RESOLVED_FILTER);
+                for (ResolveInfo info : mediaServices) {
+                    AppEntry entry = new AppEntry(info, mPackageManager, true);
+                    entries.add(entry);
+                }
                 return entries;
             }
 
diff --git a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/PinnedAppListLiveData.java b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/PinnedAppListLiveData.java
index 1425ea129..ec966b86b 100644
--- a/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/PinnedAppListLiveData.java
+++ b/tests/MultiDisplaySecondaryHomeTestLauncher/src/com/android/car/multidisplay/launcher/PinnedAppListLiveData.java
@@ -23,6 +23,7 @@ import android.content.SharedPreferences;
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 import android.os.AsyncTask;
+import android.service.media.MediaBrowserService;
 
 import androidx.lifecycle.LiveData;
 
@@ -77,12 +78,19 @@ class PinnedAppListLiveData extends LiveData<List<AppEntry>> {
 
                     if (apps != null) {
                         for (ResolveInfo app : apps) {
-                            final AppEntry entry = new AppEntry(app, mPackageManager);
+                            final AppEntry entry = new AppEntry(app, mPackageManager, false);
                             entries.add(entry);
                         }
                     }
                 }
 
+                List<ResolveInfo> mediaServices = mPackageManager.queryIntentServices(
+                        new Intent(MediaBrowserService.SERVICE_INTERFACE),
+                        PackageManager.GET_RESOLVED_FILTER);
+                for (ResolveInfo info : mediaServices) {
+                    AppEntry entry = new AppEntry(info, mPackageManager, true);
+                    entries.add(entry);
+                }
                 return entries;
             }
 
-- 
2.17.1

