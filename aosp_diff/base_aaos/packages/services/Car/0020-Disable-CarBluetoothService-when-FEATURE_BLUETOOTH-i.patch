From f5c67051021e61f943765ff3adb46566ceed2b55 Mon Sep 17 00:00:00 2001
From: Gowtham Anandha Babu <gowtham.anandha.babu@intel.com>
Date: Fri, 29 Dec 2023 14:15:45 +0530
Subject: [PATCH] Disable CarBluetoothService when FEATURE_BLUETOOTH is absent

Tracked-On: OAM-114394
Signed-off-by: Gowtham Anandha Babu <gowtham.anandha.babu@intel.com>
---
 .../CarUiPortraitSettings/res/values/config.xml    |  2 +-
 .../SettingsProvider/res/values/defaults.xml       |  2 +-
 service/res/values/config.xml                      |  2 +-
 .../src/com/android/car/CarFeatureController.java  |  2 +-
 service/src/com/android/car/ICarImpl.java          | 11 ++++++++---
 service/src/com/android/car/PerUserCarService.java | 14 ++++++++++++--
 6 files changed, 24 insertions(+), 9 deletions(-)

diff --git a/car_product/car_ui_portrait/apps/CarUiPortraitSettings/res/values/config.xml b/car_product/car_ui_portrait/apps/CarUiPortraitSettings/res/values/config.xml
index eaf603f5b..accdd34c6 100644
--- a/car_product/car_ui_portrait/apps/CarUiPortraitSettings/res/values/config.xml
+++ b/car_product/car_ui_portrait/apps/CarUiPortraitSettings/res/values/config.xml
@@ -17,6 +17,6 @@
 
 <resources>
     <bool name="config_global_force_single_pane">false</bool>
-    <string name="config_homepage_fragment_class" translatable="false">com.android.car.settings.bluetooth.BluetoothSettingsFragment</string>
+    <string name="config_homepage_fragment_class" translatable="false">com.android.car.settings.network.NetworkAndInternetFragment</string>
     <bool name="config_top_level_enable_chevrons">false</bool>
 </resources>
diff --git a/car_product/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml b/car_product/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
index a4377ca12..110aaf380 100644
--- a/car_product/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
+++ b/car_product/overlay/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
@@ -21,7 +21,7 @@
     <!--  default setting for Settings.System.END_BUTTON_BEHAVIOR: 0 for car -->
     <integer name="def_end_button_behavior">0</integer>
 
-    <bool name="def_bluetooth_on">true</bool>
+    <bool name="def_bluetooth_on">false</bool>
     <bool name="def_wifi_on">false</bool>
 
     <!-- Disable system heads-up notifications -->
diff --git a/service/res/values/config.xml b/service/res/values/config.xml
index 0764948de..0e2c011eb 100644
--- a/service/res/values/config.xml
+++ b/service/res/values/config.xml
@@ -73,7 +73,7 @@
     <!--  Configuration to enable or disable the default Bluetooth Device Connection Policy. This
           policy determines when to initiate device connections, but does not control the actual
           connection process. Disable this default to implement your own policy. -->
-    <bool name="useDefaultBluetoothConnectionPolicy">true</bool>
+    <bool name="useDefaultBluetoothConnectionPolicy">false</bool>
 
     <!--  Service responsible for displaying information on the car instrument cluster. -->
     <string name="instrumentClusterRendererService" translatable="false">android.car.cluster/.ClusterRenderingService</string>
diff --git a/service/src/com/android/car/CarFeatureController.java b/service/src/com/android/car/CarFeatureController.java
index bb20e529d..325fd1ad5 100644
--- a/service/src/com/android/car/CarFeatureController.java
+++ b/service/src/com/android/car/CarFeatureController.java
@@ -62,7 +62,6 @@ public final class CarFeatureController implements CarServiceBase {
     private static final HashSet<String> MANDATORY_FEATURES = new HashSet<>(Arrays.asList(
             Car.APP_FOCUS_SERVICE,
             Car.AUDIO_SERVICE,
-            Car.BLUETOOTH_SERVICE,
             Car.CAR_ACTIVITY_SERVICE,
             Car.CAR_BUGREPORT_SERVICE,
             Car.CAR_DEVICE_POLICY_SERVICE,
@@ -88,6 +87,7 @@ public final class CarFeatureController implements CarServiceBase {
 
     private static final HashSet<String> OPTIONAL_FEATURES = new HashSet<>(Arrays.asList(
             CarFeatures.FEATURE_CAR_USER_NOTICE_SERVICE,
+            Car.BLUETOOTH_SERVICE,
             Car.CLUSTER_HOME_SERVICE,
             Car.CAR_NAVIGATION_SERVICE,
             Car.DIAGNOSTIC_SERVICE,
diff --git a/service/src/com/android/car/ICarImpl.java b/service/src/com/android/car/ICarImpl.java
index 63b4fd93e..eee9fc32e 100644
--- a/service/src/com/android/car/ICarImpl.java
+++ b/service/src/com/android/car/ICarImpl.java
@@ -259,8 +259,13 @@ public class ICarImpl extends ICar.Stub {
         mPerUserCarServiceHelper = constructWithTrace(
                 t, PerUserCarServiceHelper.class,
                 () -> new PerUserCarServiceHelper(serviceContext, mCarUserService));
-        mCarBluetoothService = constructWithTrace(t, CarBluetoothService.class,
-                () -> new CarBluetoothService(serviceContext, mPerUserCarServiceHelper));
+        if (mFeatureController.isFeatureEnabled(Car.BLUETOOTH_SERVICE)) {
+            mCarBluetoothService = constructWithTrace(t, CarBluetoothService.class,
+                    () -> new CarBluetoothService(serviceContext,
+						  mPerUserCarServiceHelper));
+	} else {
+	    mCarBluetoothService = null;
+	}
         mCarInputService = constructWithTrace(t, CarInputService.class,
                 () -> new CarInputService(serviceContext, mHal.getInputHal(), mCarUserService,
                         mCarOccupantZoneService));
@@ -386,7 +391,7 @@ public class ICarImpl extends ICar.Stub {
         allServices.add(mClusterNavigationService);
         addServiceIfNonNull(allServices, mInstrumentClusterService);
         allServices.add(mPerUserCarServiceHelper);
-        allServices.add(mCarBluetoothService);
+        addServiceIfNonNull(allServices, mCarBluetoothService);
         allServices.add(mCarProjectionService);
         addServiceIfNonNull(allServices, mCarDiagnosticService);
         addServiceIfNonNull(allServices, mCarStorageMonitoringService);
diff --git a/service/src/com/android/car/PerUserCarService.java b/service/src/com/android/car/PerUserCarService.java
index 6a9291a85..a6a62c7ae 100644
--- a/service/src/com/android/car/PerUserCarService.java
+++ b/service/src/com/android/car/PerUserCarService.java
@@ -48,6 +48,7 @@ public class PerUserCarService extends Service {
     private LocationManagerProxy mLocationManagerProxy;
     private @Nullable PerUserCarDevicePolicyService mPerUserCarDevicePolicyService;
     private PerUserCarServiceBinder mPerUserCarServiceBinder;
+    private boolean mIsFeatureBluetooth;
 
     @Override
     public IBinder onBind(Intent intent) {
@@ -72,7 +73,15 @@ public class PerUserCarService extends Service {
         Slogf.i(TAG, "created for user %d", context.getUserId());
 
         mPerUserCarServiceBinder = new PerUserCarServiceBinder();
-        mCarBluetoothUserService = new CarBluetoothUserService(this);
+        mIsFeatureBluetooth = context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH);
+        Slogf.i(TAG, "mIsFeatureBluetooth " + mIsFeatureBluetooth);
+        if (mIsFeatureBluetooth) {
+            mCarBluetoothUserService = new CarBluetoothUserService(this);
+        } else if (DBG) {
+            Slogf.d(TAG, "Not setting mCarBluetoothUserService because device doesn't have %s",
+                    PackageManager.FEATURE_BLUETOOTH);
+            mCarBluetoothUserService = null;
+        }
 
         if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_DEVICE_ADMIN)) {
             mPerUserCarDevicePolicyService = PerUserCarDevicePolicyService.getInstance(context);
@@ -101,7 +110,8 @@ public class PerUserCarService extends Service {
         try (IndentingPrintWriter pw = new IndentingPrintWriter(writer)) {
             pw.println("CarBluetoothUserService");
             pw.increaseIndent();
-            mCarBluetoothUserService.dump(pw);
+	    if (mCarBluetoothUserService !=  null)
+                mCarBluetoothUserService.dump(pw);
             pw.decreaseIndent();
             pw.println();
 
-- 
2.17.1

