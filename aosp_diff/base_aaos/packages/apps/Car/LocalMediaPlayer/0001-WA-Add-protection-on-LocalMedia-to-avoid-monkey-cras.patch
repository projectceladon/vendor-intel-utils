From 4685ee7579cab0c4fd21cb58c7d0cdd2e2fb7e72 Mon Sep 17 00:00:00 2001
From: xubing <bing.xu@intel.com>
Date: Mon, 17 Jul 2023 16:03:14 +0800
Subject: [PATCH] [WA]Add protection on LocalMedia to avoid monkey crash.

Signed-off-by: xubing <bing.xu@intel.com>
---
 src/com/android/car/media/localmediaplayer/DataModel.java | 4 ++++
 src/com/android/car/media/localmediaplayer/Player.java    | 5 +++++
 2 files changed, 9 insertions(+)

diff --git a/src/com/android/car/media/localmediaplayer/DataModel.java b/src/com/android/car/media/localmediaplayer/DataModel.java
index 30bf471..f9fc46d 100644
--- a/src/com/android/car/media/localmediaplayer/DataModel.java
+++ b/src/com/android/car/media/localmediaplayer/DataModel.java
@@ -352,6 +352,10 @@ public class DataModel {
                             if (pathColumn != -1) {
                                 path.putString(PATH_KEY, cursor.getString(pathColumn));
                             }
+                            String media = cursor.getString(keyColumn);
+                            if (media == null || media.length() == 0){
+                                continue;
+                            }
 
                             MediaDescription.Builder builder = new MediaDescription.Builder()
                                     .setMediaId(cursor.getString(keyColumn))
diff --git a/src/com/android/car/media/localmediaplayer/Player.java b/src/com/android/car/media/localmediaplayer/Player.java
index ea47595..bfa7ace 100644
--- a/src/com/android/car/media/localmediaplayer/Player.java
+++ b/src/com/android/car/media/localmediaplayer/Player.java
@@ -490,6 +490,11 @@ public class Player extends MediaSession.Callback {
     }
 
     private void playCurrentQueueIndex() throws IOException {
+        //Check the index to avoid OutOfBoundsException
+        if (mCurrentQueueIdx > (mQueue.size() - 1)) {
+            stopPlayback();
+            return;
+        }
         MediaDescription next = mQueue.get(mCurrentQueueIdx).getDescription();
         String path = next.getExtras().getString(DataModel.PATH_KEY);
         MediaMetadata metadata = mDataModel.getMetadata(next.getMediaId());
-- 
2.34.1

