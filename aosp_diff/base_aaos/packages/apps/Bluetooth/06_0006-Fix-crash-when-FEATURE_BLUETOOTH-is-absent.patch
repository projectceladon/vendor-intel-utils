From 957a1c65d087eac0a8c2376d8f3ec4b3cb76fb4f Mon Sep 17 00:00:00 2001
From: Gowtham Anandha Babu <gowtham.anandha.babu@intel.com>
Date: Fri, 29 Dec 2023 01:53:22 +0530
Subject: [PATCH] Fix crash when FEATURE_BLUETOOTH is absent

Tracked-On: OAM-114394
Signed-off-by: Gowtham Anandha Babu <gowtham.anandha.babu@intel.com>
---
 .../android/bluetooth/btservice/Config.java   | 21 ++++++++++++-------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/src/com/android/bluetooth/btservice/Config.java b/src/com/android/bluetooth/btservice/Config.java
index 41535377a..b3681f3e6 100644
--- a/src/com/android/bluetooth/btservice/Config.java
+++ b/src/com/android/bluetooth/btservice/Config.java
@@ -30,6 +30,8 @@ import android.provider.Settings;
 import android.text.TextUtils;
 import android.util.Log;
 
+import android.content.pm.PackageManager;
+
 import com.android.bluetooth.R;
 import com.android.bluetooth.a2dp.A2dpService;
 import com.android.bluetooth.a2dpsink.A2dpSinkService;
@@ -122,7 +124,7 @@ public class Config {
             return;
         }
         List<String> enabledProfiles =
-                getSystemConfigEnabledProfilesForPackage(ctx.getPackageName());
+                getSystemConfigEnabledProfilesForPackage(ctx, ctx.getPackageName());
 
         ArrayList<Class> profiles = new ArrayList<>(PROFILE_SERVICES_AND_FLAGS.length);
         for (ProfileConfig config : PROFILE_SERVICES_AND_FLAGS) {
@@ -208,18 +210,21 @@ public class Config {
         return false;
     }
 
-    private static List<String> getSystemConfigEnabledProfilesForPackage(String packageName) {
+    private static List<String> getSystemConfigEnabledProfilesForPackage(Context context, String packageName) {
         IBinder b = ServiceManager.getService(BluetoothAdapter.BLUETOOTH_MANAGER_SERVICE);
         if (b == null) {
             Log.e(TAG, "Bluetooth binder is null");
         }
 
-        IBluetoothManager managerService = IBluetoothManager.Stub.asInterface(b);
-        try {
-            return managerService.getSystemConfigEnabledProfilesForPackage(packageName);
-        } catch (RemoteException e) {
+	if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH)) {
+            IBluetoothManager managerService = IBluetoothManager.Stub.asInterface(b);
+            try {
+                return managerService.getSystemConfigEnabledProfilesForPackage(packageName);
+            } catch (RemoteException e) {
+                return null;
+            }
+	} else {
             return null;
-        }
-
+	}
     }
 }
-- 
2.17.1

