From 41c126750a09cdbedcae789d13a9e04180a474fe Mon Sep 17 00:00:00 2001
From: Kaushlendra Kumar <kaushlendra.kumar@intel.com>
Date: Mon, 24 Jul 2023 17:14:27 +0530
Subject: [PATCH] zlib: optimization for Antutu memory Benchmark

Signed-off-by: Kaushlendra Kumar <kaushlendra.kumar@intel.com>
---
 Android.bp | 1 +
 BUILD.gn   | 7 ++++++-
 deflate.c  | 2 +-
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/Android.bp b/Android.bp
index ae055c0..3ae7ffe 100644
--- a/Android.bp
+++ b/Android.bp
@@ -72,6 +72,7 @@ cflags_android_x86 = [
     // reports that the processor really does have the instruction.
     "-mpclmul",
     "-DCRC32_SIMD_SSE42_PCLMUL",
+    "-DFASTEST",
 ]
 srcs_x86 = [
     "crc_folding.c",
diff --git a/BUILD.gn b/BUILD.gn
index d64cb38..036c86f 100644
--- a/BUILD.gn
+++ b/BUILD.gn
@@ -81,7 +81,9 @@ source_set("zlib_adler32_simd") {
     ]
 
     if (!is_win || is_clang) {
-      cflags = [ "-mssse3" ]
+      cflags = [ "-mssse3",
+                 "-march=core-avx2", 
+               ]
     }
   }
 
@@ -171,6 +173,7 @@ source_set("zlib_inflate_chunk_simd") {
 
   if (use_x86_x64_optimizations || use_arm_neon_optimizations) {
     include_dirs = [ "." ]
+    cflags_c = [ "-march=core-avx2" ]
 
     sources = [
       "contrib/optimizations/chunkcopy.h",
@@ -211,6 +214,7 @@ source_set("zlib_crc32_simd") {
       cflags = [
         "-msse4.2",
         "-mpclmul",
+        "-march=core-avx2",
       ]
     }
   }
@@ -243,6 +247,7 @@ source_set("zlib_x86_simd") {
       cflags = [
         "-msse4.2",
         "-mpclmul",
+        "-march=core-avx2",
       ]
     }
   }
diff --git a/deflate.c b/deflate.c
index fc7ae45..2c40f0e 100644
--- a/deflate.c
+++ b/deflate.c
@@ -62,7 +62,7 @@
 
 #ifdef FASTEST
 /* See http://crbug.com/1113596 */
-#error "FASTEST is not supported in Chromium's zlib."
+//#error "FASTEST is not supported in Chromium's zlib."
 #endif
 
 const char deflate_copyright[] =
-- 
2.40.1

