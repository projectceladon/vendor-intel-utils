From 1c371b05d2175c0189b55995bb3afa26555715de Mon Sep 17 00:00:00 2001
From: "ji, zhenlong z" <zhenlong.z.ji@intel.com>
Date: Tue, 24 Mar 2020 11:53:26 +0800
Subject: [PATCH] backport some sepolicy rules from Q

Change-Id: I803f6967af43b72dd87cc76918f735139c85a1c9
Signed-off-by: ji, zhenlong z <zhenlong.z.ji@intel.com>
---
 prebuilts/api/28.0/private/system_server.te | 2 ++
 prebuilts/api/28.0/public/domain.te         | 6 ------
 private/system_server.te                    | 2 ++
 public/domain.te                            | 6 ------
 4 files changed, 4 insertions(+), 12 deletions(-)

diff --git a/prebuilts/api/28.0/private/system_server.te b/prebuilts/api/28.0/private/system_server.te
index b037fe4a6..3862bf425 100644
--- a/prebuilts/api/28.0/private/system_server.te
+++ b/prebuilts/api/28.0/private/system_server.te
@@ -9,6 +9,8 @@ typeattribute system_server mlstrustedsubject;
 # Define a type for tmpfs-backed ashmem regions.
 tmpfs_domain(system_server)
 
+allow appdomain system_server_tmpfs:file { getattr map read write };
+
 # Create a socket for connections from crash_dump.
 type_transition system_server system_data_file:sock_file system_ndebug_socket "ndebugsocket";
 
diff --git a/prebuilts/api/28.0/public/domain.te b/prebuilts/api/28.0/public/domain.te
index e9337b654..760708201 100644
--- a/prebuilts/api/28.0/public/domain.te
+++ b/prebuilts/api/28.0/public/domain.te
@@ -1289,12 +1289,6 @@ neverallow * ~{
 # /system/bin/mydaemon -- u:object_r:mydaemon_exec:s0
 neverallow * domain:file { execute execute_no_trans entrypoint };
 
-# Do not allow access to the generic debugfs label. This is too broad.
-# Instead, if access to part of debugfs is desired, it should have a
-# more specific label.
-# TODO: fix system_server and dumpstate
-neverallow { domain -init -vendor_init -system_server -dumpstate } debugfs:file no_rw_file_perms;
-
 # Profiles contain untrusted data and profman parses that. We should only run
 # in from installd forked processes.
 neverallow {
diff --git a/private/system_server.te b/private/system_server.te
index b037fe4a6..3862bf425 100644
--- a/private/system_server.te
+++ b/private/system_server.te
@@ -9,6 +9,8 @@ typeattribute system_server mlstrustedsubject;
 # Define a type for tmpfs-backed ashmem regions.
 tmpfs_domain(system_server)
 
+allow appdomain system_server_tmpfs:file { getattr map read write };
+
 # Create a socket for connections from crash_dump.
 type_transition system_server system_data_file:sock_file system_ndebug_socket "ndebugsocket";
 
diff --git a/public/domain.te b/public/domain.te
index e9337b654..760708201 100644
--- a/public/domain.te
+++ b/public/domain.te
@@ -1289,12 +1289,6 @@ neverallow * ~{
 # /system/bin/mydaemon -- u:object_r:mydaemon_exec:s0
 neverallow * domain:file { execute execute_no_trans entrypoint };
 
-# Do not allow access to the generic debugfs label. This is too broad.
-# Instead, if access to part of debugfs is desired, it should have a
-# more specific label.
-# TODO: fix system_server and dumpstate
-neverallow { domain -init -vendor_init -system_server -dumpstate } debugfs:file no_rw_file_perms;
-
 # Profiles contain untrusted data and profman parses that. We should only run
 # in from installd forked processes.
 neverallow {
-- 
2.20.1

