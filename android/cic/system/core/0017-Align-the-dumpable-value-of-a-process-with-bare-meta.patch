From 284ace56f18dbdaa268a101957a024665c8bce89 Mon Sep 17 00:00:00 2001
From: "ji, zhenlong z" <zhenlong.z.ji@intel.com>
Date: Mon, 13 Apr 2020 13:32:13 +0800
Subject: [PATCH] Align the dumpable value of a process with bare metal android

Change-Id: I64364c25ba7e7730bbc32296c185ee54a5d83b28
Signed-off-by: ji, zhenlong z <zhenlong.z.ji@intel.com>
---
 debuggerd/handler/debuggerd_handler.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/debuggerd/handler/debuggerd_handler.cpp b/debuggerd/handler/debuggerd_handler.cpp
index 05e6efa60..d137ecc9b 100644
--- a/debuggerd/handler/debuggerd_handler.cpp
+++ b/debuggerd/handler/debuggerd_handler.cpp
@@ -527,6 +527,12 @@ static void debuggerd_signal_handler(int signal_number, siginfo_t* info, void* c
   // and then wait for it to terminate.
   futex_wait(&thread_info.pseudothread_tid, child_pid);
 
+  // We cannot set the dumpable value to SUID_DUMP_ROOT(2), change this value to
+  // SUID_DUMP_DISABLE(0).
+  if (orig_dumpable == 2) {
+    orig_dumpable = 0;
+  }
+
   // Restore PR_SET_DUMPABLE to its original value.
   if (prctl(PR_SET_DUMPABLE, orig_dumpable) != 0) {
     fatal_errno("failed to restore dumpable");
-- 
2.20.1

