From a41cc1dc70e64cddbf8a146be15425616326c988 Mon Sep 17 00:00:00 2001
From: sgnanase <sundar.gnanasekaran@intel.com>
Date: Fri, 14 May 2021 00:39:05 +0530
Subject: [PATCH] Revert "INTERNAL: Add importBuffer & freeBuffer support"

Change-Id: Ie24b5fd0ff05caa81a40982a7fe409e61dac8100
This reverts commit 537fae57f6d0cda28c1960e65c297583fc16e1ef.
---
 src/egl/Android.mk                      |  1 -
 src/egl/drivers/dri2/egl_dri2.h         |  3 ---
 src/egl/drivers/dri2/platform_android.c | 29 +++----------------------
 3 files changed, 3 insertions(+), 30 deletions(-)

diff --git a/src/egl/Android.mk b/src/egl/Android.mk
index 59cc2ac2c2e..d60520e9a7e 100644
--- a/src/egl/Android.mk
+++ b/src/egl/Android.mk
@@ -75,7 +75,6 @@ endif
 
 ifeq ($(strip $(BOARD_USES_GRALLOC1)),true)
 	LOCAL_CFLAGS += -DHAVE_GRALLOC1
-	LOCAL_C_INCLUDES += $(INTEL_MINIGBM)/cros_gralloc
 endif
 
 ifeq ($(filter $(MESA_ANDROID_MAJOR_VERSION), 4 5 6 7),)
diff --git a/src/egl/drivers/dri2/egl_dri2.h b/src/egl/drivers/dri2/egl_dri2.h
index d2450e35dc5..cfdbfe7c0a9 100644
--- a/src/egl/drivers/dri2/egl_dri2.h
+++ b/src/egl/drivers/dri2/egl_dri2.h
@@ -71,7 +71,6 @@ struct zwp_linux_dmabuf_v1;
 
 #ifdef HAVE_GRALLOC1
 #include <hardware/gralloc1.h>
-#include <i915_private_android_types.h>
 #endif
 
 #include "eglconfig.h"
@@ -269,8 +268,6 @@ struct dri2_egl_display
    GRALLOC1_PFN_LOCK_FLEX pfn_lockflex;
    GRALLOC1_PFN_GET_FORMAT pfn_getFormat;
    GRALLOC1_PFN_UNLOCK pfn_unlock;
-   GRALLOC1_PFN_IMPORT_BUFFER pfn_importBuffer;
-   GRALLOC1_PFN_FREE_BUFFER pfn_freeBuffer;
 #endif
 #endif
 
diff --git a/src/egl/drivers/dri2/platform_android.c b/src/egl/drivers/dri2/platform_android.c
index 3662f1c59d1..744b5497fa5 100644
--- a/src/egl/drivers/dri2/platform_android.c
+++ b/src/egl/drivers/dri2/platform_android.c
@@ -69,13 +69,12 @@ struct droid_yuv_format {
 /* This enumeration can be deleted if Android defined it in
  * system/core/include/system/graphics.h
  */
-#ifndef HAVE_GRALLOC1
 enum {
    HAL_PIXEL_FORMAT_NV12_Y_TILED_INTEL = 0x100,
    HAL_PIXEL_FORMAT_NV12 = 0x10F,
    HAL_PIXEL_FORMAT_P010_INTEL = 0x110
 };
-#endif
+
 /* The following table is used to look up a DRI image FourCC based
  * on native format and information contained in android_ycbcr struct. */
 static const struct droid_yuv_format droid_yuv_formats[] = {
@@ -880,23 +879,12 @@ droid_create_image_from_prime_fds_yuv(_EGLDisplay *disp, _EGLContext *ctx,
 
    memset(&ycbcr, 0, sizeof(ycbcr));
 
-   buffer_handle_t bufferHandle;
-
    if (dri2_dpy->gralloc_version == HARDWARE_MODULE_API_VERSION(1, 0)) {
-     if (!dri2_dpy->pfn_importBuffer) {
-        _eglLog(_EGL_WARNING, "Gralloc does not support importBuffer");
-        return NULL;
-     }
-     ret = dri2_dpy->pfn_importBuffer(dri2_dpy->gralloc1_dvc, buf->handle, &bufferHandle);
-     if (ret) {
-        _eglLog(_EGL_WARNING, "Gralloc importBuffer failed");
-        return NULL;
-     }
      if (!dri2_dpy->pfn_lockflex) {
         _eglLog(_EGL_WARNING, "Gralloc does not support lockflex");
         return NULL;
      }
-     ret = dri2_dpy->pfn_lockflex(dri2_dpy->gralloc1_dvc, bufferHandle,
+     ret = dri2_dpy->pfn_lockflex(dri2_dpy->gralloc1_dvc, buf->handle,
                                        0, 0, &accessRegion, &outFlexLayout, -1);
      if (ret) {
         _eglLog(_EGL_WARNING, "gralloc->lockflex failed: %d", ret);
@@ -908,16 +896,7 @@ droid_create_image_from_prime_fds_yuv(_EGLDisplay *disp, _EGLContext *ctx,
         return NULL;
      }
      int outReleaseFence = 0;
-     dri2_dpy->pfn_unlock(dri2_dpy->gralloc1_dvc, bufferHandle, &outReleaseFence);
-     if (!dri2_dpy->pfn_freeBuffer) {
-        _eglLog(_EGL_WARNING, "Gralloc does not support freeBuffer");
-        return NULL;
-     }
-     ret = dri2_dpy->pfn_freeBuffer(dri2_dpy->gralloc1_dvc, (void*)bufferHandle);
-     if (ret) {
-        _eglLog(_EGL_WARNING, "Gralloc freeBuffer failed");
-        return NULL;
-     }
+     dri2_dpy->pfn_unlock(dri2_dpy->gralloc1_dvc, buf->handle, &outReleaseFence);
    } else {
 #endif
    if (!dri2_dpy->gralloc->lock_ycbcr) {
@@ -1760,8 +1739,6 @@ dri2_initialize_android(const _EGLDriver *drv, _EGLDisplay *disp)
       } else {
         dri2_dpy->gralloc1_dvc = (gralloc1_device_t *)device;
         dri2_dpy->pfn_lockflex = (GRALLOC1_PFN_LOCK_FLEX)dri2_dpy->gralloc1_dvc->getFunction(dri2_dpy->gralloc1_dvc, GRALLOC1_FUNCTION_LOCK_FLEX);
-        dri2_dpy->pfn_importBuffer = (GRALLOC1_PFN_IMPORT_BUFFER)dri2_dpy->gralloc1_dvc->getFunction(dri2_dpy->gralloc1_dvc,GRALLOC1_FUNCTION_IMPORT_BUFFER);
-        dri2_dpy->pfn_freeBuffer = (GRALLOC1_PFN_FREE_BUFFER)dri2_dpy->gralloc1_dvc->getFunction(dri2_dpy->gralloc1_dvc, GRALLOC1_FUNCTION_FREE_BUFFER);
         dri2_dpy->pfn_getFormat = (GRALLOC1_PFN_GET_FORMAT)dri2_dpy->gralloc1_dvc->getFunction(dri2_dpy->gralloc1_dvc, GRALLOC1_FUNCTION_GET_FORMAT);
         dri2_dpy->pfn_unlock = (GRALLOC1_PFN_UNLOCK)dri2_dpy->gralloc1_dvc->getFunction(dri2_dpy->gralloc1_dvc, GRALLOC1_FUNCTION_UNLOCK);
       }
-- 
2.30.0

