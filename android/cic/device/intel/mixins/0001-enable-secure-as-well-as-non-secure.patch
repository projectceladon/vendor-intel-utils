From 07ff303cf4afe0af8bfb84637a0f48bf0a531dc9 Mon Sep 17 00:00:00 2001
From: sgnanase <sundar.gnanasekaran@intel.com>
Date: Tue, 31 Mar 2020 01:31:13 +0530
Subject: [PATCH] [CIC] Enable Secure as well as non-secure installation/boot

Tracked-On: OAM-90560
Signed-off-by: sgnanase <sundar.gnanasekaran@intel.com>
---
 .../cic/addon/pre-requisites/bt               | 12 +++----
 .../addon/pre-requisites/customize-android    | 28 +++-------------
 .../cic/addon/pre-requisites/secure           | 32 +++++++++----------
 groups/device-specific/cic/addon/setup-aic    | 28 +++++++++++++++-
 4 files changed, 54 insertions(+), 46 deletions(-)

diff --git a/groups/device-specific/cic/addon/pre-requisites/bt b/groups/device-specific/cic/addon/pre-requisites/bt
index a7b5e032..e6d92d9e 100755
--- a/groups/device-specific/cic/addon/pre-requisites/bt
+++ b/groups/device-specific/cic/addon/pre-requisites/bt
@@ -3,12 +3,12 @@
 
 if [[ $1 == "mediation" ]]; then
 
-## Remove trusty from android
+## Remove BT from android
 echo '
-RUN ["/system/bin/sh", "-c","\
-rm -rf /system/vendor/etc/permissions/android.hardware.bluetooth.xml && \
-rm -rf /system/vendor/etc/permissions/android.hardware.bluetooth_le.xml && \
-echo"]
-' >> $AIC_WORK_DIR/update/Dockerfile
+#Remove BT
+rm -rf /system/vendor/etc/permissions/android.hardware.bluetooth.xml
+rm -rf /system/vendor/etc/permissions/android.hardware.bluetooth_le.xml
+
+' >> $AIC_WORK_DIR/update/customize-android
 
 fi
diff --git a/groups/device-specific/cic/addon/pre-requisites/customize-android b/groups/device-specific/cic/addon/pre-requisites/customize-android
index d99b827e..5736bf1e 100755
--- a/groups/device-specific/cic/addon/pre-requisites/customize-android
+++ b/groups/device-specific/cic/addon/pre-requisites/customize-android
@@ -85,7 +85,7 @@ fi
 #By default, nothing to be set, keep it like this:
 ############################CUSTOMIZED CONTENT############################
 
-DOCKER_FILE_PATH=update/Dockerfile
+DOCKER_FILE_PATH=update/customize-android
 
 function remove_files {
 files=$1
@@ -98,18 +98,12 @@ else
    return
 fi
 
-#Add the head
-echo 'RUN ["/system/bin/sh", "-c","\' >> $DOCKER_FILE_PATH
-
 #Add the content
 for file in $files
 do
-    echo "rm -rf $file && \\" >> $DOCKER_FILE_PATH
+    echo "rm -rf $file " >> $DOCKER_FILE_PATH
 done
 
-#Add the tail
-echo "echo\"]" >> $DOCKER_FILE_PATH
-
 }
 
 function set_properties {
@@ -123,48 +117,36 @@ else
    return
 fi
 
-#Add the head
-echo 'RUN ["/system/bin/sh", "-c","\' >> $DOCKER_FILE_PATH
-
 #Add the content
 for p in $properties
 do
     key=`echo $p | cut -d '=' -f 1`
 #remove the old if existed. DO NOT indent EOF
 cat >> $DOCKER_FILE_PATH << EOF
-sed -i \"s|$key=.*||g\" /system/build.prop && \\
+sed -i \"s|$key=.*||g\" /system/build.prop
 EOF
 
 #append the new. DO NOT indent EOF
 cat >> $DOCKER_FILE_PATH << EOF
-echo \"$p\" | tee -a /system/build.prop && \\
+echo \"$p\" | tee -a /system/build.prop
 EOF
 
 done
 
-#Add the tail
-echo "echo\"]" >> $DOCKER_FILE_PATH
-
 }
 
 
 function execute_shell {
 cmds="$1"
 
-#Add the head
-echo 'RUN ["/system/bin/sh", "-c","\' >> $DOCKER_FILE_PATH
-
 #Add the content
 while read -r c
 do
     if [[ ! -z $c ]]; then
-        echo "$c && \\" >> $DOCKER_FILE_PATH
+        echo "$c " >> $DOCKER_FILE_PATH
     fi
 done <<<"$cmds"
 
-#Add the tail
-echo "echo\"]" >> $DOCKER_FILE_PATH
-
 }
 
 echo "===customize android -- START"
diff --git a/groups/device-specific/cic/addon/pre-requisites/secure b/groups/device-specific/cic/addon/pre-requisites/secure
index dea03566..b649a331 100755
--- a/groups/device-specific/cic/addon/pre-requisites/secure
+++ b/groups/device-specific/cic/addon/pre-requisites/secure
@@ -49,22 +49,22 @@ if [[ $security == "" || $security == "false" ]]; then
 
 ## Remove trusty from android
 echo '
-RUN ["/system/bin/sh", "-c","\
-sed -i 's/trusty//g' /system/build.prop && \
-rm -rf /vendor/lib/hw/gatekeeper.trusty.so && \
-rm -rf /vendor/lib/hw/keystore.trusty.so && \
-rm -rf /vendor/lib/libtrusty.so && \
-rm -rf /vendor/lib64/hw/gatekeeper.trusty.so && \
-rm -rf /vendor/lib64/hw/keystore.trusty.so && \
-rm -rf /vendor/lib64/libtrusty.so && \
-rm -rf /vendor/etc/init/android.hardware.gatekeeper@1.0-service.rc && \
-rm -rf /vendor/lib/hw/gatekeeper.trusty.so && \
-rm -rf /vendor/lib/hw/android.hardware.gatekeeper@1.0-impl.so && \
-rm -rf /vendor/lib64/hw/gatekeeper.trusty.so && \
-rm -rf /vendor/lib64/hw/android.hardware.gatekeeper@1.0-impl.so && \
-rm -rf /vendor/bin/hw/android.hardware.gatekeeper@1.0-service && \
-echo"]
-' >> $AIC_WORK_DIR/update/Dockerfile
+#Disable trusty
+sed -i 's/trusty//g' /system/build.prop
+rm -rf /vendor/lib/hw/gatekeeper.trusty.so
+rm -rf /vendor/lib/hw/keystore.trusty.so
+rm -rf /vendor/lib/libtrusty.so
+rm -rf /vendor/lib64/hw/gatekeeper.trusty.so
+rm -rf /vendor/lib64/hw/keystore.trusty.so
+rm -rf /vendor/lib64/libtrusty.so
+rm -rf /vendor/etc/init/android.hardware.gatekeeper@1.0-service.rc
+rm -rf /vendor/lib/hw/gatekeeper.trusty.so
+rm -rf /vendor/lib/hw/android.hardware.gatekeeper@1.0-impl.so
+rm -rf /vendor/lib64/hw/gatekeeper.trusty.so
+rm -rf /vendor/lib64/hw/android.hardware.gatekeeper@1.0-impl.so
+rm -rf /vendor/bin/hw/android.hardware.gatekeeper@1.0-service
+
+' >> $AIC_WORK_DIR/update/customize-android
 
     ## Remove KF and tos from ubuntu
     sudo rm -rf /boot/efi/EFI/ubuntu/tos.img
diff --git a/groups/device-specific/cic/addon/setup-aic b/groups/device-specific/cic/addon/setup-aic
index 2274fe2a..de1558aa 100755
--- a/groups/device-specific/cic/addon/setup-aic
+++ b/groups/device-specific/cic/addon/setup-aic
@@ -4,6 +4,8 @@
 unset SECURE=$SECURE WIFI_MT=$WIFI_MT WIFI_PT=$WIFI_PT BT_MT=$BT_MT BT_PT=$BT_PT AUDIO_MT=$AUDIO_MT AUDIO_PT=$AUDIO_PT >& /dev/null
 export AIC_WORK_DIR=${PWD}
 
+rm -f $AIC_WORK_DIR/update/customize-android && touch $AIC_WORK_DIR/update/customize-android && chmod 777 $AIC_WORK_DIR/update/customize-android
+
 USAGE="
 
 ./setup-aic -s/-ns -m [audio,wifi,bt] -p [audio,wifi,bt]
@@ -158,6 +160,7 @@ sudo rm -rf $AIC_WORK_DIR/workdir/data*
 echo 'FROM android_base' > $AIC_WORK_DIR/update/Dockerfile
 echo ' ' >> $AIC_WORK_DIR/update/Dockerfile
 echo 'COPY ./root/ /' >> $AIC_WORK_DIR/update/Dockerfile
+echo 'COPY ./customize-android /' >> $AIC_WORK_DIR/update/Dockerfile
 echo ' ' >> $AIC_WORK_DIR/update/Dockerfile
 
 #Install Feature set packages / modules
@@ -187,9 +190,31 @@ fi
 #Install CIC
 cd $AIC_WORK_DIR
 echo "Installing CIC -- START"
-./aic install -e -d none
+if [[ $SECURE == "false" ]]; then
+  ./aic install -e -u -d none
+else
+  ./aic install -e -d none
+fi
 echo "Installing CIC -- DONE"
 
+#Update sepolicy mode
+a=`grep GRUB_CMDLINE_LINUX /etc/default/grub | grep -i 'androidboot.selinux=permissive'`
+b=`grep GRUB_CMDLINE_LINUX /etc/default/grub | grep -i 'androidboot.selinux=enforcing'`
+
+if [[ $SECURE == "true" ]]; then
+  if [ ! -z "$a" ]; then
+    sudo sed -i 's/androidboot.selinux=permissive//g' /etc/default/grub
+  fi
+fi
+if [[ $SECURE == "false" ]]; then
+  if [[ -z "$a" && -z "$b" ]]; then
+    echo 'GRUB_CMDLINE_LINUX="$GRUB_CMDLINE_LINUX androidboot.selinux=permissive"' | sudo tee -a /etc/default/grub
+  fi
+  if [ ! -z "$b" ]; then
+    sudo sed -i 's/androidboot.selinux=enforcing/androidboot.selinux=permissive/g' /etc/default/grub
+  fi
+fi
+
 #Check env path
 AIC_WORK_DIR_PATH=$AIC_WORK_DIR/workdir
 a=`grep -rn AIC_WORK_DIR /etc/environment`
@@ -241,6 +266,7 @@ if [[ $AUDIO_PT == "true" ]]; then
   sudo rm -rf /etc/profile.d/create_pasocket.sh
 fi
 
+sudo update-grub
 echo ""
 echo "Reboot required for changes to be reflected !!"
 read -p "Press Enter key to reboot: "
