From 9df49e48eb6eacbafb3f889f4537570a054b3d51 Mon Sep 17 00:00:00 2001
From: sgnanase <sundar.gnanasekaran@intel.com>
Date: Thu, 13 May 2021 15:46:36 +0530
Subject: [PATCH] [PATCH] CIC TGL NPI Patches

Resolve compilation issues

Change-Id: Id7360d0da3b87493193d480fc0c78c65dc1fc104
Tracked-On: OAM-97081
Signed-off-by: sgnanase <sundar.gnanasekaran@intel.com>
---
 groups/audio/aic/product.mk                |  1 +
 groups/device-specific/cic/AndroidBoard.mk |  9 +++++----
 groups/device-specific/cic/BoardConfig.mk  |  5 +++++
 groups/device-specific/cic/cic.mk          |  7 +++++--
 groups/device-specific/cic/init.rc         | 12 ++++++------
 groups/device-specific/cic/manifest.xml    | 22 ++--------------------
 groups/device-specific/cic/product.mk      |  4 ++--
 groups/graphics/aic_mdc/BoardConfig.mk     |  2 +-
 8 files changed, 27 insertions(+), 35 deletions(-)

diff --git a/groups/audio/aic/product.mk b/groups/audio/aic/product.mk
index 7fe7ddc..9fd607a 100755
--- a/groups/audio/aic/product.mk
+++ b/groups/audio/aic/product.mk
@@ -1,6 +1,7 @@
 PRODUCT_PACKAGES += \
     android.hardware.audio@2.0-service \
     android.hardware.audio@2.0-impl \
+    android.hardware.audio@4.0-impl \
     android.hardware.audio.effect@2.0-impl \
     android.hardware.broadcastradio@1.0-impl \
     android.hardware.soundtrigger@2.0-impl \
diff --git a/groups/device-specific/cic/AndroidBoard.mk b/groups/device-specific/cic/AndroidBoard.mk
index 1d166b0..5be461c 100644
--- a/groups/device-specific/cic/AndroidBoard.mk
+++ b/groups/device-specific/cic/AndroidBoard.mk
@@ -20,6 +20,7 @@ ifneq ($(TARGET_LOOP_MOUNT_SYSTEM_IMAGES), true)
 	$(hide) chmod -R g-w $(PRODUCT_OUT)/docker/android/root
 else
 	$(hide) zcat $(PRODUCT_OUT)/ramdisk.img | (cd $(PRODUCT_OUT)/docker/android/root && cpio -idm)
+	$(hide) (cd $(PRODUCT_OUT)/docker/android/root && rm init && ln -s /system/bin/init init)
 	$(hide) rm -rf $(PRODUCT_OUT)/docker/android/root/etc
 	$(hide) cp -r $(PRODUCT_OUT)/system/etc $(PRODUCT_OUT)/docker/android/root
 	$(hide) rm -rf $(PRODUCT_OUT)/docker/aic-manager/images
@@ -30,7 +31,7 @@ endif
 	$(hide) ln -t $(PRODUCT_OUT)/docker/aic-manager/images $(PRODUCT_OUT)/system.img
 endif
 
-TARGET_AIC_FILE_NAME := $(TARGET_PRODUCT)-aic-$(BUILD_NUMBER).tar.gz
+TARGET_AIC_FILE_NAME := $(TARGET_PRODUCT)-aic-$(FILE_NAME_TAG).tar.gz
 
 .PHONY: addon
 addon:
@@ -55,12 +56,12 @@ aic: .KATI_NINJA_POOL := console
 aic: multidroid
 	@echo Make AIC docker images...
 ifneq ($(TARGET_LOOP_MOUNT_SYSTEM_IMAGES), true)
-	$(HOST_OUT_EXECUTABLES)/aic-build -b $(BUILD_NUMBER)
+	$(HOST_OUT_EXECUTABLES)/aic-build -b $(FILE_NAME_TAG)
 else
-	BUILD_VARIANT=loop_mount $(HOST_OUT_EXECUTABLES)/aic-build -b $(BUILD_NUMBER)
+	BUILD_VARIANT=loop_mount $(HOST_OUT_EXECUTABLES)/aic-build -b $(FILE_NAME_TAG)
 endif
 ifneq (,$(filter cic cic_dev,$(TARGET_PRODUCT)))
-	tar cvzf $(PRODUCT_OUT)/$(TARGET_AIC_FILE_NAME) -C $(PRODUCT_OUT) aic android.tar.gz aic-manager.tar.gz cfc ia_hwc pre-requisites sof_audio README-CIC INFO cic.sh setup-aic $(VBMETA_IMG) kf4cic.efi verity_metadata -C docker update
+	tar cvzf $(PRODUCT_OUT)/$(TARGET_AIC_FILE_NAME) -C $(PRODUCT_OUT) aic android.tar.gz aic-manager.tar.gz cfc ia_hwc pre-requisites sof_audio README-CIC INFO cic.sh setup-aic $(VBMETA_IMG) kf4cic.efi -C docker update
 	@echo Make debian binaries...
 	$(hide) (rm -rf $(PRODUCT_OUT)/cic && mkdir -p $(PRODUCT_OUT)/cic/opt/cic && mkdir -p $(PRODUCT_OUT)/cic/etc/profile.d)
 	$(hide) (cd $(PRODUCT_OUT)/cic/opt/cic && tar xvf ../../../$(TARGET_AIC_FILE_NAME) aic android.tar.gz aic-manager.tar.gz pre-requisites setup-aic INFO cic.sh cfc update)
diff --git a/groups/device-specific/cic/BoardConfig.mk b/groups/device-specific/cic/BoardConfig.mk
index 72fe24c..7eb34b6 100644
--- a/groups/device-specific/cic/BoardConfig.mk
+++ b/groups/device-specific/cic/BoardConfig.mk
@@ -5,6 +5,11 @@ TARGET_NO_KERNEL := true
 # Container related configurations
 ANDROID_AS_GUEST := true
 
+BUILD_BROKEN_USES_BUILD_HOST_STATIC_LIBRARY := true
+BUILD_BROKEN_USES_BUILD_HOST_SHARED_LIBRARY := true
+BUILD_BROKEN_USES_BUILD_HOST_EXECUTABLE := true
+BUILD_BROKEN_USES_BUILD_COPY_HEADERS := true
+
 TARGET_COPY_OUT_VENDOR := system/vendor
 DEVICE_MATRIX_FILE   := $(INTEL_PATH_DEVICE_CIC)/compatibility_matrix.xml
 DEVICE_PACKAGE_OVERLAYS += $(INTEL_PATH_DEVICE_CIC)/overlay
diff --git a/groups/device-specific/cic/cic.mk b/groups/device-specific/cic/cic.mk
index 693345d..68e06a1 100644
--- a/groups/device-specific/cic/cic.mk
+++ b/groups/device-specific/cic/cic.mk
@@ -47,10 +47,13 @@ PRODUCT_COPY_FILES += \
     $(LOCAL_PATH)/init.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/hw/init.$(TARGET_PRODUCT).rc \
     $(LOCAL_PATH)/init.rc:root/init.$(TARGET_PRODUCT).rc \
     $(LOCAL_PATH)/ueventd.rc:$(TARGET_COPY_OUT_VENDOR)/ueventd.rc \
-    $(LOCAL_PATH)/manifest.xml:$(TARGET_COPY_OUT_VENDOR)/manifest.xml \
     out/target/product/$(TARGET_PRODUCT)/system/bin/sdcard-fuse:system/bin/sdcard \
 
-PRODUCT_PACKAGES += android.hardware.health@2.0-service.intel
+DEVICE_MANIFEST_FILE := $(LOCAL_PATH)/manifest.xml
+
+PRODUCT_PACKAGES += \
+    android.hardware.health@2.1-service \
+    android.hardware.health@2.1-impl
 
 PRODUCT_NAME := cic
 PRODUCT_DEVICE := cic
diff --git a/groups/device-specific/cic/init.rc b/groups/device-specific/cic/init.rc
index 05e2793..7b1d007 100644
--- a/groups/device-specific/cic/init.rc
+++ b/groups/device-specific/cic/init.rc
@@ -1,14 +1,14 @@
 on early-init
 
     # Create symbol link for binder device
-    chmod 0666 /binderfs/binder${ro.boot.container.id}
-    symlink /binderfs/binder${ro.boot.container.id} /dev/binder
+    chmod 0666 /binderfs/binder
+    symlink /binderfs/binder /dev/binder
 
-    chmod 0666 /binderfs/vndbinder${ro.boot.container.id}
-    symlink /binderfs/vndbinder${ro.boot.container.id} /dev/vndbinder
+    chmod 0666 /binderfs/vndbinder
+    symlink /binderfs/vndbinder /dev/vndbinder
 
-    chmod 0666 /binderfs/hwbinder${ro.boot.container.id}
-    symlink /binderfs/hwbinder${ro.boot.container.id} /dev/hwbinder
+    chmod 0666 /binderfs/hwbinder
+    symlink /binderfs/hwbinder /dev/hwbinder
 
     # Mount debugfs and make it writable so that debuggerd can
     # create stack traces, required with newer kernels
diff --git a/groups/device-specific/cic/manifest.xml b/groups/device-specific/cic/manifest.xml
index faa2eb7..ef64c9d 100644
--- a/groups/device-specific/cic/manifest.xml
+++ b/groups/device-specific/cic/manifest.xml
@@ -46,7 +46,7 @@
     <hal format="hidl">
         <name>android.hardware.audio</name>
         <transport>hwbinder</transport>
-        <version>2.0</version>
+        <version>4.0</version>
         <interface>
             <name>IDevicesFactory</name>
             <instance>default</instance>
@@ -107,24 +107,6 @@
             <instance>default</instance>
         </interface>
     </hal>
-    <hal format="hidl">
-        <name>android.hardware.wifi</name>
-        <transport>hwbinder</transport>
-        <version>1.0</version>
-        <interface>
-            <name>IWifi</name>
-            <instance>default</instance>
-        </interface>
-    </hal>
-    <hal format="hidl">
-        <name>android.hardware.wifi.supplicant</name>
-        <transport>hwbinder</transport>
-        <version>1.0</version>
-        <interface>
-            <name>ISupplicant</name>
-            <instance>default</instance>
-        </interface>
-    </hal>
     <hal format="hidl">
         <name>android.hardware.camera.provider</name>
         <transport arch="32+64">passthrough</transport>
@@ -164,6 +146,6 @@
         </interface>
     </hal>
     <sepolicy>
-        <version>27.0</version>
+        <version>30.0</version>
     </sepolicy>
 </manifest>
diff --git a/groups/device-specific/cic/product.mk b/groups/device-specific/cic/product.mk
index da0b551..2cba6d8 100644
--- a/groups/device-specific/cic/product.mk
+++ b/groups/device-specific/cic/product.mk
@@ -1,4 +1,4 @@
-PRODUCT_PACKAGES += \
+PRODUCT_HOST_PACKAGES += \
     docker \
     cpio \
     aic-build \
@@ -17,7 +17,7 @@ PRODUCT_PACKAGES += \
     android.hardware.keymaster@3.0-service \
 
 ifeq ($(TARGET_DM_VERITY_SUPPORT), true)
-PRODUCT_PACKAGES += build_verity_img.py
+PRODUCT_HOST_PACKAGES += build_verity_img.py
 endif
 
 PRODUCT_PROPERTY_OVERRIDES += \
diff --git a/groups/graphics/aic_mdc/BoardConfig.mk b/groups/graphics/aic_mdc/BoardConfig.mk
index 624d935..8499220 100644
--- a/groups/graphics/aic_mdc/BoardConfig.mk
+++ b/groups/graphics/aic_mdc/BoardConfig.mk
@@ -26,7 +26,7 @@ TARGET_USE_PRIVATE_LIBDRM := false
 endif
 
 BOARD_USE_MESA := true
-BOARD_GPU_DRIVERS := i965
+BOARD_GPU_DRIVERS := i965 iris
 BOARD_USES_MINIGBM := true
 INTEL_MINIGBM := external/minigbm-intel
 BOARD_USES_GRALLOC1 := true
-- 
2.30.0

