From 6e7bd2238bd39ff551963da4e07139a8e65a1835 Mon Sep 17 00:00:00 2001
From: sgnanase <sundar.gnanasekaran@intel.com>
Date: Thu, 13 May 2021 16:05:59 +0530
Subject: [PATCH] [PATCH] CIC TGL NPI Patches

Resolve compilation issues

Change-Id: Id7360d0da3b87493193d480fc0c78c65dc1fc105
Tracked-On: OAM-97081
Signed-off-by: sgnanase <sundar.gnanasekaran@intel.com>
---
 cic/AndroidBoard.mk                           |  9 ++++----
 cic/BoardConfig.mk                            |  7 +++++-
 cic/cic.mk                                    |  7 ++++--
 cic/device.mk                                 |  9 +++-----
 cic/init.rc                                   | 12 +++++-----
 cic/manifest.xml                              | 22 ++-----------------
 cic/mixins.spec                               |  2 +-
 cic_dev/BoardConfig.mk                        |  2 +-
 cic_dev/device.mk                             |  1 +
 sepolicy/app.te                               |  2 +-
 sepolicy/bootanim.te                          |  2 +-
 sepolicy/domain.te                            |  2 +-
 sepolicy/file.te                              |  8 +++----
 sepolicy/genfs_contexts                       |  6 ++---
 sepolicy/hal_graphics_composer_default.te     |  4 ++--
 sepolicy/init.te                              |  2 +-
 sepolicy/neuralnetworks/hal_neuralnetworks.te |  2 +-
 sepolicy/surfaceflinger.te                    |  2 +-
 sepolicy/system_server.te                     |  2 +-
 sepolicy/vold.te                              |  2 +-
 20 files changed, 47 insertions(+), 58 deletions(-)

diff --git a/cic/AndroidBoard.mk b/cic/AndroidBoard.mk
index d2317db..92ced56 100644
--- a/cic/AndroidBoard.mk
+++ b/cic/AndroidBoard.mk
@@ -61,6 +61,7 @@ ifneq ($(TARGET_LOOP_MOUNT_SYSTEM_IMAGES), true)
 	$(hide) chmod -R g-w $(PRODUCT_OUT)/docker/android/root
 else
 	$(hide) zcat $(PRODUCT_OUT)/ramdisk.img | (cd $(PRODUCT_OUT)/docker/android/root && cpio -idm)
+	$(hide) (cd $(PRODUCT_OUT)/docker/android/root && rm init && ln -s /system/bin/init init)
 	$(hide) rm -rf $(PRODUCT_OUT)/docker/android/root/etc
 	$(hide) cp -r $(PRODUCT_OUT)/system/etc $(PRODUCT_OUT)/docker/android/root
 	$(hide) rm -rf $(PRODUCT_OUT)/docker/aic-manager/images
@@ -71,7 +72,7 @@ endif
 	$(hide) ln -t $(PRODUCT_OUT)/docker/aic-manager/images $(PRODUCT_OUT)/system.img
 endif
 
-TARGET_AIC_FILE_NAME := $(TARGET_PRODUCT)-aic-$(BUILD_NUMBER).tar.gz
+TARGET_AIC_FILE_NAME := $(TARGET_PRODUCT)-aic-$(FILE_NAME_TAG).tar.gz
 
 .PHONY: addon
 addon:
@@ -96,12 +97,12 @@ aic: .KATI_NINJA_POOL := console
 aic: multidroid
 	@echo Make AIC docker images...
 ifneq ($(TARGET_LOOP_MOUNT_SYSTEM_IMAGES), true)
-	$(HOST_OUT_EXECUTABLES)/aic-build -b $(BUILD_NUMBER)
+	$(HOST_OUT_EXECUTABLES)/aic-build -b $(FILE_NAME_TAG)
 else
-	BUILD_VARIANT=loop_mount $(HOST_OUT_EXECUTABLES)/aic-build -b $(BUILD_NUMBER)
+	BUILD_VARIANT=loop_mount $(HOST_OUT_EXECUTABLES)/aic-build -b $(FILE_NAME_TAG)
 endif
 ifneq (,$(filter cic cic_dev,$(TARGET_PRODUCT)))
-	tar cvzf $(PRODUCT_OUT)/$(TARGET_AIC_FILE_NAME) -C $(PRODUCT_OUT) aic android.tar.gz aic-manager.tar.gz cfc ia_hwc pre-requisites sof_audio README-CIC INFO cic.sh setup-aic $(VBMETA_IMG) kf4cic.efi verity_metadata -C docker update
+	tar cvzf $(PRODUCT_OUT)/$(TARGET_AIC_FILE_NAME) -C $(PRODUCT_OUT) aic android.tar.gz aic-manager.tar.gz cfc ia_hwc pre-requisites sof_audio README-CIC INFO cic.sh setup-aic $(VBMETA_IMG) kf4cic.efi -C docker update
 	@echo Make debian binaries...
 	$(hide) (rm -rf $(PRODUCT_OUT)/cic && mkdir -p $(PRODUCT_OUT)/cic/opt/cic && mkdir -p $(PRODUCT_OUT)/cic/etc/profile.d)
 	$(hide) (cd $(PRODUCT_OUT)/cic/opt/cic && tar xvf ../../../$(TARGET_AIC_FILE_NAME) aic android.tar.gz aic-manager.tar.gz pre-requisites setup-aic INFO cic.sh cfc update)
diff --git a/cic/BoardConfig.mk b/cic/BoardConfig.mk
index 8740b34..ee4a364 100644
--- a/cic/BoardConfig.mk
+++ b/cic/BoardConfig.mk
@@ -89,6 +89,11 @@ TARGET_NO_KERNEL := true
 # Container related configurations
 ANDROID_AS_GUEST := true
 
+BUILD_BROKEN_USES_BUILD_HOST_STATIC_LIBRARY := true
+BUILD_BROKEN_USES_BUILD_HOST_SHARED_LIBRARY := true
+BUILD_BROKEN_USES_BUILD_HOST_EXECUTABLE := true
+BUILD_BROKEN_USES_BUILD_COPY_HEADERS := true
+
 TARGET_COPY_OUT_VENDOR := system/vendor
 DEVICE_MATRIX_FILE   := $(INTEL_PATH_DEVICE_CIC)/compatibility_matrix.xml
 DEVICE_PACKAGE_OVERLAYS += $(INTEL_PATH_DEVICE_CIC)/overlay
@@ -135,7 +140,7 @@ TARGET_USE_PRIVATE_LIBDRM := false
 endif
 
 BOARD_USE_MESA := true
-BOARD_GPU_DRIVERS := i965
+BOARD_GPU_DRIVERS := i965 iris
 BOARD_USES_MINIGBM := true
 INTEL_MINIGBM := external/minigbm-intel
 BOARD_USES_GRALLOC1 := true
diff --git a/cic/cic.mk b/cic/cic.mk
index fde2556..367a73a 100644
--- a/cic/cic.mk
+++ b/cic/cic.mk
@@ -45,10 +45,13 @@ PRODUCT_COPY_FILES += \
     $(LOCAL_PATH)/init.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/hw/init.$(TARGET_PRODUCT).rc \
     $(LOCAL_PATH)/init.rc:root/init.$(TARGET_PRODUCT).rc \
     $(LOCAL_PATH)/ueventd.rc:$(TARGET_COPY_OUT_VENDOR)/ueventd.rc \
-    $(LOCAL_PATH)/manifest.xml:$(TARGET_COPY_OUT_VENDOR)/manifest.xml \
     out/target/product/$(TARGET_PRODUCT)/system/bin/sdcard-fuse:system/bin/sdcard \
 
-PRODUCT_PACKAGES += android.hardware.health@2.0-service.intel
+DEVICE_MANIFEST_FILE := $(LOCAL_PATH)/manifest.xml
+
+PRODUCT_PACKAGES += \
+    android.hardware.health@2.1-service \
+    android.hardware.health@2.1-impl
 
 PRODUCT_NAME := cic
 PRODUCT_DEVICE := cic
diff --git a/cic/device.mk b/cic/device.mk
index 511ca7a..c9baecc 100644
--- a/cic/device.mk
+++ b/cic/device.mk
@@ -9,16 +9,13 @@ TARGET_UEFI_ARCH := x86_64
 # bootloader policy
 KERNELFLINGER_SSL_LIBRARY := boringssl
 
-##############################################################
-# Source: device/intel/mixins/groups/loop-mount/true/product.mk
-##############################################################
-TARGET_LOOP_MOUNT_SYSTEM_IMAGES := true
 ##############################################################
 # Source: device/intel/mixins/groups/audio/aic/product.mk
 ##############################################################
 PRODUCT_PACKAGES += \
     android.hardware.audio@2.0-service \
     android.hardware.audio@2.0-impl \
+    android.hardware.audio@4.0-impl \
     android.hardware.audio.effect@2.0-impl \
     android.hardware.broadcastradio@1.0-impl \
     android.hardware.soundtrigger@2.0-impl \
@@ -51,7 +48,7 @@ PRODUCT_PACKAGES += \
 ##############################################################
 # Source: device/intel/mixins/groups/device-specific/cic/product.mk
 ##############################################################
-PRODUCT_PACKAGES += \
+PRODUCT_HOST_PACKAGES += \
     docker \
     cpio \
     aic-build \
@@ -70,7 +67,7 @@ PRODUCT_PACKAGES += \
     android.hardware.keymaster@3.0-service \
 
 ifeq ($(TARGET_DM_VERITY_SUPPORT), true)
-PRODUCT_PACKAGES += build_verity_img.py
+PRODUCT_HOST_PACKAGES += build_verity_img.py
 endif
 
 PRODUCT_PROPERTY_OVERRIDES += \
diff --git a/cic/init.rc b/cic/init.rc
index a6162fa..ab2de7f 100644
--- a/cic/init.rc
+++ b/cic/init.rc
@@ -14,14 +14,14 @@ on boot
 on early-init
 
     # Create symbol link for binder device
-    chmod 0666 /binderfs/binder${ro.boot.container.id}
-    symlink /binderfs/binder${ro.boot.container.id} /dev/binder
+    chmod 0666 /binderfs/binder
+    symlink /binderfs/binder /dev/binder
 
-    chmod 0666 /binderfs/vndbinder${ro.boot.container.id}
-    symlink /binderfs/vndbinder${ro.boot.container.id} /dev/vndbinder
+    chmod 0666 /binderfs/vndbinder
+    symlink /binderfs/vndbinder /dev/vndbinder
 
-    chmod 0666 /binderfs/hwbinder${ro.boot.container.id}
-    symlink /binderfs/hwbinder${ro.boot.container.id} /dev/hwbinder
+    chmod 0666 /binderfs/hwbinder
+    symlink /binderfs/hwbinder /dev/hwbinder
 
     # Mount debugfs and make it writable so that debuggerd can
     # create stack traces, required with newer kernels
diff --git a/cic/manifest.xml b/cic/manifest.xml
index 87bef6d..46b22f1 100644
--- a/cic/manifest.xml
+++ b/cic/manifest.xml
@@ -46,7 +46,7 @@
     <hal format="hidl">
         <name>android.hardware.audio</name>
         <transport>hwbinder</transport>
-        <version>2.0</version>
+        <version>4.0</version>
         <interface>
             <name>IDevicesFactory</name>
             <instance>default</instance>
@@ -97,24 +97,6 @@
             <instance>default</instance>
         </interface>
     </hal>
-    <hal format="hidl">
-        <name>android.hardware.wifi</name>
-        <transport>hwbinder</transport>
-        <version>1.0</version>
-        <interface>
-            <name>IWifi</name>
-            <instance>default</instance>
-        </interface>
-    </hal>
-    <hal format="hidl">
-        <name>android.hardware.wifi.supplicant</name>
-        <transport>hwbinder</transport>
-        <version>1.0</version>
-        <interface>
-            <name>ISupplicant</name>
-            <instance>default</instance>
-        </interface>
-    </hal>
     <hal format="hidl">
         <name>android.hardware.camera.provider</name>
         <transport arch="32+64">passthrough</transport>
@@ -154,6 +136,6 @@
         </interface>
     </hal>
     <sepolicy>
-        <version>27.0</version>
+        <version>30.0</version>
     </sepolicy>
 </manifest>
diff --git a/cic/mixins.spec b/cic/mixins.spec
index cf49954..50fac4a 100644
--- a/cic/mixins.spec
+++ b/cic/mixins.spec
@@ -10,7 +10,7 @@ product.mk: device.mk
 boot-arch: project-celadon(uefi_arch=x86_64,use_cic=true)
 allow-missing-dependencies: true
 sepolicy: enforcing
-loop-mount: true
+loop-mount: false
 audio: aic
 cpu-arch: x86_64
 debug-unresponsive: false
diff --git a/cic_dev/BoardConfig.mk b/cic_dev/BoardConfig.mk
index 8248614..8a896e8 100644
--- a/cic_dev/BoardConfig.mk
+++ b/cic_dev/BoardConfig.mk
@@ -130,7 +130,7 @@ TARGET_USE_PRIVATE_LIBDRM := false
 endif
 
 BOARD_USE_MESA := true
-BOARD_GPU_DRIVERS := i965
+BOARD_GPU_DRIVERS := i965 iris
 BOARD_USES_MINIGBM := true
 INTEL_MINIGBM := external/minigbm-intel
 BOARD_USES_GRALLOC1 := true
diff --git a/cic_dev/device.mk b/cic_dev/device.mk
index 73bef8c..a11a7e3 100644
--- a/cic_dev/device.mk
+++ b/cic_dev/device.mk
@@ -15,6 +15,7 @@ KERNELFLINGER_SSL_LIBRARY := boringssl
 PRODUCT_PACKAGES += \
     android.hardware.audio@2.0-service \
     android.hardware.audio@2.0-impl \
+    android.hardware.audio@4.0-impl \
     android.hardware.audio.effect@2.0-impl \
     android.hardware.broadcastradio@1.0-impl \
     android.hardware.soundtrigger@2.0-impl \
diff --git a/sepolicy/app.te b/sepolicy/app.te
index 21830d3..a01d1f8 100644
--- a/sepolicy/app.te
+++ b/sepolicy/app.te
@@ -1,3 +1,3 @@
-allow { appdomain -isolated_app } sysfs_app_readable:file r_file_perms;
+#allow { appdomain -isolated_app } sysfs_app_readable:file r_file_perms;
 allow appdomain hal_graphics_allocator_default_tmpfs:file { read write map };
 allow appdomain gpu_device:dir r_dir_perms;
diff --git a/sepolicy/bootanim.te b/sepolicy/bootanim.te
index 8c4d71c..071d631 100644
--- a/sepolicy/bootanim.te
+++ b/sepolicy/bootanim.te
@@ -1 +1 @@
-allow bootanim sysfs_app_readable:file r_file_perms;
+#allow bootanim sysfs_app_readable:file r_file_perms;
diff --git a/sepolicy/domain.te b/sepolicy/domain.te
index fed09be..1220a87 100644
--- a/sepolicy/domain.te
+++ b/sepolicy/domain.te
@@ -1,4 +1,4 @@
-allow domain sysfs_app_readable:dir search;
+#allow domain sysfs_app_readable:dir search;
 allow domain binderfs:chr_file rw_file_perms;
 allow domain gpu_device:dir r_dir_perms;
 allow domain binderfs:dir search;
diff --git a/sepolicy/file.te b/sepolicy/file.te
index 2a2076d..c9ccb19 100644
--- a/sepolicy/file.te
+++ b/sepolicy/file.te
@@ -1,8 +1,8 @@
-type sysfs_app_readable, fs_type, sysfs_type;
-type binderfs, fs_type, mlstrustedobject;
+#type sysfs_app_readable, fs_type, sysfs_type;
+#type binderfs, fs_type, mlstrustedobject;
 typeattribute hal_graphics_allocator_default_tmpfs mlstrustedobject;
-type binfmt_misc, fs_type;
-type proc_slabinfo, fs_type, proc_type;
+#type binfmt_misc, fs_type;
+#type proc_slabinfo, fs_type, proc_type;
 type ethernet_data_file, file_type, data_file_type, core_data_file_type;
 type prop_data_file, file_type, data_file_type, core_data_file_type;
 type ipc_audio_data_file, file_type, data_file_type;
diff --git a/sepolicy/genfs_contexts b/sepolicy/genfs_contexts
index 8e90451..b34c26c 100644
--- a/sepolicy/genfs_contexts
+++ b/sepolicy/genfs_contexts
@@ -1,5 +1,5 @@
-genfscon sysfs /devices/pci0000:00/0000:00:02.0/ u:object_r:sysfs_app_readable:s0
+#genfscon sysfs /devices/pci0000:00/0000:00:02.0/ u:object_r:sysfs_app_readable:s0
 
 
-genfscon binder / u:object_r:binderfs:s0
-genfscon proc /slabinfo u:object_r:proc_slabinfo:s0
+#genfscon binder / u:object_r:binderfs:s0
+#genfscon proc /slabinfo u:object_r:proc_slabinfo:s0
diff --git a/sepolicy/hal_graphics_composer_default.te b/sepolicy/hal_graphics_composer_default.te
index 3451395..8946eb9 100644
--- a/sepolicy/hal_graphics_composer_default.te
+++ b/sepolicy/hal_graphics_composer_default.te
@@ -1,5 +1,5 @@
-allow hal_graphics_composer_default sysfs_app_readable:file r_file_perms;
+#allow hal_graphics_composer_default sysfs_app_readable:file r_file_perms;
 allow hal_graphics_composer_default rootfs:sock_file create_file_perms;
 allow hal_graphics_composer_default rootfs:dir create_dir_perms;
 allow hal_graphics_composer_default kernel:unix_stream_socket connectto;
-allow hal_graphics_composer_default debugfs:file r_file_perms;
+#allow hal_graphics_composer_default debugfs:file r_file_perms;
diff --git a/sepolicy/init.te b/sepolicy/init.te
index 7f185cf..84b87c4 100644
--- a/sepolicy/init.te
+++ b/sepolicy/init.te
@@ -17,7 +17,7 @@ allow init binfmt_miscfs:dir mounton;
 allow init binfmt_miscfs:file write;
 
 # write /dev/cpuctl/cpu.rt_period_us
-allow init cpuctl_device:file create_file_perms;
+#allow init cpuctl_device:file create_file_perms;
 
 # restorecon /dev/__properties__
 allow init device:dir relabelfrom;
diff --git a/sepolicy/neuralnetworks/hal_neuralnetworks.te b/sepolicy/neuralnetworks/hal_neuralnetworks.te
index 6f5ae6d..09b69fe 100644
--- a/sepolicy/neuralnetworks/hal_neuralnetworks.te
+++ b/sepolicy/neuralnetworks/hal_neuralnetworks.te
@@ -9,7 +9,7 @@ allow hal_neuralnetworks_default self:process execmem;
 
 allow hal_neuralnetworks_default vendor_data_file:file { read write };
 
-allow shell hal_neuralnetworks_hwservice:hwservice_manager find;
+#allow shell hal_neuralnetworks_hwservice:hwservice_manager find;
 
 # allow hal_neuralnetworks to access libusb
 allow hal_neuralnetworks_default usb_device:dir r_dir_perms;
diff --git a/sepolicy/surfaceflinger.te b/sepolicy/surfaceflinger.te
index ee5e902..28bef98 100644
--- a/sepolicy/surfaceflinger.te
+++ b/sepolicy/surfaceflinger.te
@@ -1,2 +1,2 @@
-allow surfaceflinger sysfs_app_readable:file r_file_perms;
+#allow surfaceflinger sysfs_app_readable:file r_file_perms;
 allow surfaceflinger hal_graphics_allocator_default_tmpfs:file { read write map };
diff --git a/sepolicy/system_server.te b/sepolicy/system_server.te
index 66202e7..b9eef78 100644
--- a/sepolicy/system_server.te
+++ b/sepolicy/system_server.te
@@ -1,4 +1,4 @@
-allow system_server sysfs_app_readable:file r_file_perms;
+#allow system_server sysfs_app_readable:file r_file_perms;
 allow system_server hal_graphics_allocator_default_tmpfs:file { read write map };
 allow system_server shell_data_file:file map;
 allow system_server rootfs:fifo_file { rw_file_perms setattr };
diff --git a/sepolicy/vold.te b/sepolicy/vold.te
index 1278092..7a0c0bb 100644
--- a/sepolicy/vold.te
+++ b/sepolicy/vold.te
@@ -1,2 +1,2 @@
-allow vold nsfs:file r_file_perms;
+#allow vold nsfs:file r_file_perms;
 allow vold tmpfs:blk_file rw_file_perms;
-- 
2.30.0

