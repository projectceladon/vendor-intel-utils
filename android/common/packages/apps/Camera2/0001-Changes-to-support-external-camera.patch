From a8d268d5c7e47e6691864e9ab7b5fc2713779260 Mon Sep 17 00:00:00 2001
From: "Nikumbh, Mayur NimbaX" <mayur.nimbax.nikumbh@intel.com>
Date: Tue, 12 Nov 2019 11:00:57 +0530
Subject: [PATCH] Changes to support external camera

- Remove DisableCameraReceiver as it disables all camera
activities if camera is not plugged in during first boot.
- If camera device path has /, replace it with _ as / is
not allowed in file uri path.
- If no front camera found, return external camera facing
id.

Change-Id: I3871c7c97561eedbbc82c89cf09be68d5cfcc228
Tracked-On: OAM-88515
Signed-off-by: Nikumbh, Mayur NimbaX <mayur.nimbax.nikumbh@intel.com>
---
 AndroidManifest.xml                                            | 6 ------
 src/com/android/camera/PermissionsActivity.java                | 4 ++--
 src/com/android/camera/one/v2/Camera2OneCameraManagerImpl.java | 3 ++-
 src/com/android/camera/settings/SettingsManager.java           | 1 +
 4 files changed, 5 insertions(+), 9 deletions(-)

diff --git AndroidManifest.xml AndroidManifest.xml
index 5fb8838..e562c02 100644
--- AndroidManifest.xml
+++ AndroidManifest.xml
@@ -151,12 +151,6 @@
             android:theme="@style/Theme.CameraSettings"
             android:configChanges="keyboardHidden|orientation|screenSize">
         </activity>
-
-        <receiver android:name="com.android.camera.DisableCameraReceiver">
-            <intent-filter>
-                <action android:name="android.intent.action.BOOT_COMPLETED" />
-            </intent-filter>
-        </receiver>
     </application>
 
 </manifest>
diff --git src/com/android/camera/PermissionsActivity.java src/com/android/camera/PermissionsActivity.java
index 3fda04a..765b140 100644
--- src/com/android/camera/PermissionsActivity.java
+++ src/com/android/camera/PermissionsActivity.java
@@ -113,7 +113,7 @@ public class PermissionsActivity extends QuickActivity {
             mFlagHasMicrophonePermission = true;
         }
 
-        if (checkSelfPermission(Manifest.permission.READ_EXTERNAL_STORAGE)
+        if (checkSelfPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
                 != PackageManager.PERMISSION_GRANTED) {
             mNumPermissionsToRequest++;
             mShouldRequestStoragePermission = true;
@@ -156,7 +156,7 @@ public class PermissionsActivity extends QuickActivity {
             permissionsRequestIndex++;
         }
         if (mShouldRequestStoragePermission) {
-            permissionsToRequest[permissionsRequestIndex] = Manifest.permission.READ_EXTERNAL_STORAGE;
+            permissionsToRequest[permissionsRequestIndex] = Manifest.permission.WRITE_EXTERNAL_STORAGE;
             mIndexPermissionRequestStorage = permissionsRequestIndex;
             permissionsRequestIndex++;
         }
diff --git src/com/android/camera/one/v2/Camera2OneCameraManagerImpl.java src/com/android/camera/one/v2/Camera2OneCameraManagerImpl.java
index a4b5a9b..634e4d4 100644
--- src/com/android/camera/one/v2/Camera2OneCameraManagerImpl.java
+++ src/com/android/camera/one/v2/Camera2OneCameraManagerImpl.java
@@ -145,6 +145,7 @@ public class Camera2OneCameraManagerImpl implements OneCameraManager {
         String cameraId = findFirstCameraIdFacing(CameraCharacteristics.LENS_FACING_FRONT);
         if (cameraId == null) {
             Log.w(TAG, "No front-facing camera found.");
+            cameraId = findFirstCameraIdFacing(CameraCharacteristics.LENS_FACING_EXTERNAL);
         }
         return cameraId;
     }
@@ -167,4 +168,4 @@ public class Camera2OneCameraManagerImpl implements OneCameraManager {
         return null;
     }
 
-}
\ No newline at end of file
+}
diff --git src/com/android/camera/settings/SettingsManager.java src/com/android/camera/settings/SettingsManager.java
index c5c494e..807d3cd 100644
--- src/com/android/camera/settings/SettingsManager.java
+++ src/com/android/camera/settings/SettingsManager.java
@@ -157,6 +157,7 @@ public class SettingsManager {
     }
 
     public static String getCameraSettingScope(String cameraIdValue) {
+        cameraIdValue = cameraIdValue.replaceAll("/", "_");
         return CAMERA_SCOPE_PREFIX + cameraIdValue;
     }
 
-- 
2.7.4

