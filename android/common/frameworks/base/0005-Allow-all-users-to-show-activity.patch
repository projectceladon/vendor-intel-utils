From 30197bacf6eb0552a91b991974361711d10cfe5d Mon Sep 17 00:00:00 2001
From: Hongcheng Xie <hongcheng.xie@intel.com>
Date: Fri, 9 Oct 2020 10:16:40 +0800
Subject: [PATCH] Allow all users to show activity

Change-Id: I824b4c1f17888a5cc45707cdecb8c4a7b4c61b26
Tracked-On: ACP-1301
Signed-off-by: Hongcheng Xie <hongcheng.xie@intel.com>
---
 .../java/com/android/server/wm/ActivityRecord.java     | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/services/core/java/com/android/server/wm/ActivityRecord.java b/services/core/java/com/android/server/wm/ActivityRecord.java
index 3e9377ed0664..c4cfd64de5a3 100644
--- a/services/core/java/com/android/server/wm/ActivityRecord.java
+++ b/services/core/java/com/android/server/wm/ActivityRecord.java
@@ -295,6 +295,7 @@ import com.android.internal.R;
 import com.android.internal.annotations.VisibleForTesting;
 import com.android.internal.app.ResolverActivity;
 import com.android.internal.content.ReferrerIntent;
+import com.android.internal.os.RoSystemProperties;
 import com.android.internal.util.ToBooleanFunction;
 import com.android.internal.util.XmlUtils;
 import com.android.internal.util.function.pooled.PooledConsumer;
@@ -1518,7 +1519,12 @@ final class ActivityRecord extends WindowToken implements WindowManagerService.A
         }
 
         mTargetSdk = info.applicationInfo.targetSdkVersion;
-        mShowForAllUsers = (info.flags & FLAG_SHOW_FOR_ALL_USERS) != 0;
+        if (RoSystemProperties.SUPPORT_CONCURRENT_USER) {
+            // Temp show for all users to support concurrent users
+            mShowForAllUsers = true;
+        } else {
+            mShowForAllUsers = (info.flags & FLAG_SHOW_FOR_ALL_USERS) != 0;
+        }
         setOrientation(info.screenOrientation);
         mRotationAnimationHint = info.rotationAnimation;
 
@@ -5605,7 +5611,7 @@ final class ActivityRecord extends WindowToken implements WindowManagerService.A
             return false;
         }
 
-        return (info.flags & FLAG_SHOW_FOR_ALL_USERS) != 0
+        return mShowForAllUsers
                 || (mStackSupervisor.isCurrentProfileLocked(mUserId)
                 && mAtmService.mAmInternal.isUserRunning(mUserId, 0 /* flags */));
     }
-- 
2.17.1

