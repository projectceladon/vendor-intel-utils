From e1ce278e7c190791ebed0f528f6dd0b37d136edf Mon Sep 17 00:00:00 2001
From: Marc Mao <marc.mao@intel.com>
Date: Thu, 5 Sep 2019 15:43:52 +0800
Subject: [PATCH] Add layer task info support

Change-Id: Iccc00e51adc7ead3b79adb64ae6b5f245413750d
Tracked-On:
Signed-off-by: Marc Mao <marc.mao@intel.com>
---
 .../surfaceflinger/DisplayHardware/ComposerHal.cpp   | 11 +++++++++++
 .../surfaceflinger/DisplayHardware/ComposerHal.h     | 10 ++++++++++
 services/surfaceflinger/DisplayHardware/HWC2.cpp     |  8 ++++++++
 services/surfaceflinger/DisplayHardware/HWC2.h       |  4 ++++
 services/surfaceflinger/Layer.cpp                    | 12 ++++++++++++
 5 files changed, 45 insertions(+)

diff --git a/services/surfaceflinger/DisplayHardware/ComposerHal.cpp b/services/surfaceflinger/DisplayHardware/ComposerHal.cpp
index 37ba4339c..a1d9687c9 100644
--- a/services/surfaceflinger/DisplayHardware/ComposerHal.cpp
+++ b/services/surfaceflinger/DisplayHardware/ComposerHal.cpp
@@ -788,6 +788,17 @@ Error Composer::setLayerInfo(Display display, Layer layer, uint32_t type,
     return Error::NONE;
 }
 
+#ifdef SUPPORT_LAYER_TASK_INFO
+Error Composer::setLayerTaskInfo(Display display, Layer layer, uint32_t stackId,
+                             uint32_t taskId, uint32_t userId, uint32_t index)
+{
+    mWriter.selectDisplay(display);
+    mWriter.selectLayer(layer);
+    mWriter.setLayerTaskInfo(stackId, taskId, userId, index);
+    return Error::NONE;
+}
+#endif
+
 Error Composer::execute()
 {
     // prepare input command queue
diff --git a/services/surfaceflinger/DisplayHardware/ComposerHal.h b/services/surfaceflinger/DisplayHardware/ComposerHal.h
index beee53966..836c93587 100644
--- a/services/surfaceflinger/DisplayHardware/ComposerHal.h
+++ b/services/surfaceflinger/DisplayHardware/ComposerHal.h
@@ -33,6 +33,8 @@
 #include <ui/GraphicBuffer.h>
 #include <utils/StrongPointer.h>
 
+#define SUPPORT_LAYER_TASK_INFO 1
+
 namespace android {
 
 namespace Hwc2 {
@@ -175,6 +177,10 @@ public:
                                         const std::vector<IComposerClient::Rect>& visible) = 0;
     virtual Error setLayerZOrder(Display display, Layer layer, uint32_t z) = 0;
     virtual Error setLayerInfo(Display display, Layer layer, uint32_t type, uint32_t appId) = 0;
+#ifdef SUPPORT_LAYER_TASK_INFO
+    virtual Error setLayerTaskInfo(Display display, Layer layer, uint32_t stackId, uint32_t taskId,
+                                   uint32_t userId, uint32_t index) = 0;
+#endif
 
     // Composer HAL 2.2
     virtual Error setLayerPerFrameMetadata(
@@ -369,6 +375,10 @@ public:
                                 const std::vector<IComposerClient::Rect>& visible) override;
     Error setLayerZOrder(Display display, Layer layer, uint32_t z) override;
     Error setLayerInfo(Display display, Layer layer, uint32_t type, uint32_t appId) override;
+#ifdef SUPPORT_LAYER_TASK_INFO
+    Error setLayerTaskInfo(Display display, Layer layer, uint32_t stackId, uint32_t taskId,
+                           uint32_t userId, uint32_t index) override;
+#endif
 
     // Composer HAL 2.2
     Error setLayerPerFrameMetadata(
diff --git a/services/surfaceflinger/DisplayHardware/HWC2.cpp b/services/surfaceflinger/DisplayHardware/HWC2.cpp
index 61758b63f..e99fcbf6d 100644
--- a/services/surfaceflinger/DisplayHardware/HWC2.cpp
+++ b/services/surfaceflinger/DisplayHardware/HWC2.cpp
@@ -965,4 +965,12 @@ Error Layer::setInfo(uint32_t type, uint32_t appId)
   return static_cast<Error>(intError);
 }
 
+#ifdef SUPPORT_LAYER_TASK_INFO
+Error Layer::setTaskInfo(uint32_t stackId, uint32_t taskId, uint32_t userId, uint32_t index)
+{
+  auto intError = mComposer.setLayerTaskInfo(mDisplayId, mId, stackId, taskId, userId, index);
+  return static_cast<Error>(intError);
+}
+#endif
+
 } // namespace HWC2
diff --git a/services/surfaceflinger/DisplayHardware/HWC2.h b/services/surfaceflinger/DisplayHardware/HWC2.h
index 29d7a47ad..e8ee8df1b 100644
--- a/services/surfaceflinger/DisplayHardware/HWC2.h
+++ b/services/surfaceflinger/DisplayHardware/HWC2.h
@@ -334,6 +334,10 @@ public:
             const android::Region& region);
     [[clang::warn_unused_result]] Error setZOrder(uint32_t z);
     [[clang::warn_unused_result]] Error setInfo(uint32_t type, uint32_t appId);
+#ifdef SUPPORT_LAYER_TASK_INFO
+    [[clang::warn_unused_result]] Error setTaskInfo(uint32_t stackId, uint32_t taskId,
+            uint32_t userId, uint32_t index);
+#endif
 
 private:
     // These are references to data owned by HWC2::Device, which will outlive
diff --git a/services/surfaceflinger/Layer.cpp b/services/surfaceflinger/Layer.cpp
index 220da1d40..a0130b0c0 100644
--- a/services/surfaceflinger/Layer.cpp
+++ b/services/surfaceflinger/Layer.cpp
@@ -587,6 +587,18 @@ void Layer::setGeometry(const sp<const DisplayDevice>& displayDevice, uint32_t z
     ALOGE_IF(error != HWC2::Error::None, "[%s] Failed to set Z %u: %s (%d)", mName.string(), z,
              to_string(error).c_str(), static_cast<int32_t>(error));
 
+#ifdef SUPPORT_LAYER_TASK_INFO
+    uint32_t stackId, taskId, userId, index;
+    const char* task = strstr(mName.string(), "-s");
+    if (task && sscanf(task, "-s%d-t%d-u%d#%d", &stackId, &taskId, &userId, &index) == 4)
+    {
+        error = hwcLayer->setTaskInfo(stackId, taskId, userId, index);
+        ALOGE_IF(error != HWC2::Error::None, "[%s] Failed to set TaskInfo <%u, %u, %u, %u>: %s (%d)",
+                mName.string(), stackId, taskId, userId, index,
+                to_string(error).c_str(), static_cast<int32_t>(error));
+    }
+#endif
+
     int type = s.type;
     int appId = s.appId;
     sp<Layer> parent = mDrawingParent.promote();
-- 
2.17.1

