From f3396e0c764ab455d9b631005889a1854a7e00e0 Mon Sep 17 00:00:00 2001
From: Hongcheng Xie <hongcheng.xie@intel.com>
Date: Mon, 29 Jun 2020 20:40:05 +0800
Subject: [PATCH] Always allow access permission when selinux disabled

Change-Id: Iffd7aa26837b1b65c4e511007a169c69412897c5
Signed-off-by: Hongcheng Xie <hongcheng.xie@intel.com>
---
 cmds/servicemanager/Access.cpp | 15 +++++++++++++++
 cmds/servicemanager/Android.bp |  1 +
 2 files changed, 16 insertions(+)

diff --git a/cmds/servicemanager/Access.cpp b/cmds/servicemanager/Access.cpp
index b7e520f2f..25a1d130e 100644
--- a/cmds/servicemanager/Access.cpp
+++ b/cmds/servicemanager/Access.cpp
@@ -124,6 +124,13 @@ bool Access::canList(const CallingContext& ctx) {
 
 bool Access::actionAllowed(const CallingContext& sctx, const char* tctx, const char* perm,
         const std::string& tname) {
+#ifdef _DISALBE_SELINUX_
+    (void) sctx;
+    (void) tctx;
+    (void) perm;
+    (void) tname;
+    return true;
+#else
     const char* tclass = "service_manager";
 
     AuditCallbackData data = {
@@ -133,9 +140,16 @@ bool Access::actionAllowed(const CallingContext& sctx, const char* tctx, const c
 
     return 0 == selinux_check_access(sctx.sid.c_str(), tctx, tclass, perm,
         reinterpret_cast<void*>(&data));
+#endif
 }
 
 bool Access::actionAllowedFromLookup(const CallingContext& sctx, const std::string& name, const char *perm) {
+#ifdef _DISALBE_SELINUX_
+    (void) sctx;
+    (void) name;
+    (void) perm;
+    return true;
+#else
     char *tctx = nullptr;
     if (selabel_lookup(getSehandle(), &tctx, name.c_str(), SELABEL_CTX_ANDROID_SERVICE) != 0) {
         LOG(ERROR) << "SELinux: No match for " << name << " in service_contexts.\n";
@@ -145,6 +159,7 @@ bool Access::actionAllowedFromLookup(const CallingContext& sctx, const std::stri
     bool allowed = actionAllowed(sctx, tctx, perm, name);
     freecon(tctx);
     return allowed;
+#endif
 }
 
 }  // android
diff --git a/cmds/servicemanager/Android.bp b/cmds/servicemanager/Android.bp
index 7277e85d9..3358ae193 100644
--- a/cmds/servicemanager/Android.bp
+++ b/cmds/servicemanager/Android.bp
@@ -5,6 +5,7 @@ cc_defaults {
         "-Wall",
         "-Wextra",
         "-Werror",
+        "-Wno-unused-function",
     ],
 
     srcs: [
-- 
2.17.1

