From 50f1c9c9553f92bd64867e3375a3d7714f08bd78 Mon Sep 17 00:00:00 2001
From: Xihua Chen <xihua.chen@intel.com>
Date: Wed, 2 Sep 2020 16:27:05 +0800
Subject: [PATCH] Set factory reset flag to volume

Change-Id: I2144aea7fb559ebb9b3010e2bf21e3ac25fd4b14
Tracked-On:
Signed-off-by: Xihua Chen <xihua.chen@intel.com>
---
 core/java/android/os/RecoverySystem.java               | 10 ++++++++++
 .../java/com/android/server/MasterClearReceiver.java   |  2 +-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/core/java/android/os/RecoverySystem.java b/core/java/android/os/RecoverySystem.java
index 3e8e8854634..1c935c33c96 100644
--- a/core/java/android/os/RecoverySystem.java
+++ b/core/java/android/os/RecoverySystem.java
@@ -69,6 +69,8 @@ import java.util.zip.ZipInputStream;
 import sun.security.pkcs.PKCS7;
 import sun.security.pkcs.SignerInfo;
 
+import android.os.FileUtils;
+
 /**
  * RecoverySystem contains methods for interacting with the Android
  * recovery system (the separate partition that can be used to install
@@ -769,6 +771,14 @@ public class RecoverySystem {
             reasonArg = "--reason=" + sanitizeArg(reason);
         }
 
+        Log.d(TAG, "DBG.1 test");
+        try {
+            FileUtils.stringToFile("/opt/boot_reason/boot_reason_factory", "3228679");
+        } catch (IOException e) {
+            Log.d(TAG, "FileUtils.stringToFile failed");
+        }
+        SystemProperties.set("sys.powerctl", "reboot");
+
         final String localeArg = "--locale=" + Locale.getDefault().toLanguageTag() ;
         bootCommand(context, shutdownArg, "--wipe_data", reasonArg, localeArg);
     }
diff --git a/services/core/java/com/android/server/MasterClearReceiver.java b/services/core/java/com/android/server/MasterClearReceiver.java
index 06c46b908b7..27a02afad09 100644
--- a/services/core/java/com/android/server/MasterClearReceiver.java
+++ b/services/core/java/com/android/server/MasterClearReceiver.java
@@ -65,7 +65,7 @@ public class MasterClearReceiver extends BroadcastReceiver {
         final boolean forceWipe = intent.getBooleanExtra(Intent.EXTRA_FORCE_MASTER_CLEAR, false)
                 || intent.getBooleanExtra(Intent.EXTRA_FORCE_FACTORY_RESET, false);
 
-        Slog.w(TAG, "!!! FACTORY RESET !!!");
+        Slog.w(TAG, "DBG.0 !!! FACTORY RESET !!!");
         // The reboot call is blocking, so we need to do it on another thread.
         Thread thr = new Thread("Reboot") {
             @Override
-- 
2.20.1

