From a92d87b1678a4493b4affea9579915197e64099e Mon Sep 17 00:00:00 2001
From: "Chen, Yu" <yu.y.chen@intel.com>
Date: Sat, 22 Oct 2022 19:46:00 +0800
Subject: [FEATURE] Add stack protect build flags

Signed-off-by: Chen, Yu <yu.y.chen@intel.com>
Change-Id: Ifa17544903dc688cf506ea504587d4f778759c5c
Signed-off-by: Marc Mao <marc.mao@intel.com>
---
 android/mesa3d_cross.mk | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/android/mesa3d_cross.mk b/android/mesa3d_cross.mk
index 727aaac32dd..85080c511aa 100644
--- a/android/mesa3d_cross.mk
+++ b/android/mesa3d_cross.mk
@@ -179,12 +179,22 @@ define m-lld-flags-cleaned
     $(m-lld-flags))))))))
 endef
 
+STACK_PROTECT_FLAG := \
+       -ffunction-sections             \
+       -funwind-tables                 \
+       -fstack-protector-strong        \
+       -Wa,--noexecstack               \
+       -D_FORTIFY_SOURCE=2             \
+       -Wstrict-aliasing=2             \
+       -Werror=format-security
+
 define m-cpp-flags
   $(PRIVATE_TARGET_GLOBAL_CFLAGS) \
   $(PRIVATE_TARGET_GLOBAL_CPPFLAGS) \
   $(PRIVATE_ARM_CFLAGS) \
   $(PRIVATE_RTTI_FLAG) \
   $(PRIVATE_CFLAGS) \
+  $(STACK_PROTECT_FLAG) \
   $(PRIVATE_CPPFLAGS) \
   $(PRIVATE_DEBUG_CFLAGS) \
   $(PRIVATE_CFLAGS_NO_OVERRIDE) \
@@ -196,6 +206,7 @@ define m-c-flags
   $(PRIVATE_TARGET_GLOBAL_CONLYFLAGS) \
   $(PRIVATE_ARM_CFLAGS) \
   $(PRIVATE_CFLAGS) \
+  $(STACK_PROTECT_FLAG) \
   $(PRIVATE_CONLYFLAGS) \
   $(PRIVATE_DEBUG_CFLAGS) \
   $(PRIVATE_CFLAGS_NO_OVERRIDE)
-- 
2.25.1

