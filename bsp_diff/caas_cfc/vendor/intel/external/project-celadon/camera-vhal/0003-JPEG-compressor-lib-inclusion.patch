From 9d947676bd2a4ce49d5521a7d45664689c2a51ef Mon Sep 17 00:00:00 2001
From: gkdeepa <g.k.deepa@intel.com>
Date: Tue, 2 Nov 2021 13:54:55 +0530
Subject: [PATCH] JPEG compressor lib inclusion

Tracked-On:
---
 src/CameraSocketServerThread.cpp | 2 +-
 src/NV21JpegCompressor.cpp       | 2 +-
 src/jpeg-stub/Compressor.cpp     | 2 +-
 src/jpeg-stub/JpegStub.cpp       | 3 +--
 4 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/src/CameraSocketServerThread.cpp b/src/CameraSocketServerThread.cpp
index da97a8e..d10159a 100644
--- a/src/CameraSocketServerThread.cpp
+++ b/src/CameraSocketServerThread.cpp
@@ -384,7 +384,7 @@ bool CameraSocketServerThread::threadLoop() {
                 mClientFd = -1;
                 clearBuffer(fbuffer, 640, 480);
                 break;
-            } else if ((event & POLLIN) || (trans_mode == VSOCK) || (trans_mode == TCP) ) {  // preview / record
+            } else if ((event & POLLIN) ) {  // preview / record
                 // data is available in socket => read data
                 if (gIsInFrameI420) {
                     ssize_t size = 0;
diff --git a/src/NV21JpegCompressor.cpp b/src/NV21JpegCompressor.cpp
index 3348959..a320886 100644
--- a/src/NV21JpegCompressor.cpp
+++ b/src/NV21JpegCompressor.cpp
@@ -45,7 +45,7 @@ typedef void (*GetCompressedImageFunc)(JpegStub *stub, void *buff);
 typedef size_t (*GetCompressedSizeFunc)(JpegStub *stub);
 
 NV21JpegCompressor::NV21JpegCompressor() {
-    const char dlName[] = "/system/vendor/lib64/hw/camera.cic_cloud.jpeg.so";
+    const char dlName[] = "/system/vendor/lib64/hw/camera.celadon.jpeg.so";
     if (!mDl) {
         mDl = dlopen(dlName, RTLD_NOW);
     }
diff --git a/src/jpeg-stub/Compressor.cpp b/src/jpeg-stub/Compressor.cpp
index 385937c..4d67ac3 100644
--- a/src/jpeg-stub/Compressor.cpp
+++ b/src/jpeg-stub/Compressor.cpp
@@ -16,7 +16,7 @@
 
 #include "Compressor.h"
 
-// #define LOG_NDEBUG 0
+#define LOG_NDEBUG 0
 #define LOG_TAG "VirtualCamera_JPEGStub_Compressor"
 #include <log/log.h>
 #include <libexif/exif-data.h>
diff --git a/src/jpeg-stub/JpegStub.cpp b/src/jpeg-stub/JpegStub.cpp
index d421a87..a16dbc8 100644
--- a/src/jpeg-stub/JpegStub.cpp
+++ b/src/jpeg-stub/JpegStub.cpp
@@ -16,7 +16,7 @@
 
 #include "JpegStub.h"
 
-// #define LOG_NDEBUG 0
+//#define LOG_NDEBUG 0
 #define LOG_TAG "VirtualCamera_JPEGStub"
 #include <errno.h>
 #include <log/log.h>
@@ -36,7 +36,6 @@ extern "C" void JpegStub_cleanup(JpegStub *stub) {
 extern "C" int JpegStub_compress(JpegStub *stub, const void *buffer, int width, int height,
                                  int quality, ExifData *exifData) {
     Compressor *compressor = reinterpret_cast<Compressor *>(stub->mCompressor);
-
     if (compressor->compress(reinterpret_cast<const unsigned char *>(buffer), width, height,
                              quality, exifData)) {
         ALOGV("%s: Compressed JPEG: %d[%dx%d] -> %zu bytes", __FUNCTION__,
-- 
2.17.1

