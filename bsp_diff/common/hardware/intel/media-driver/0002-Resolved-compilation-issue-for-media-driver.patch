From 7ad061ed5e42e631908071e702ee9534a213d860 Mon Sep 17 00:00:00 2001
From: Ratnesh Kumar Rai <ratnesh.kumar.rai@intel.com>
Date: Mon, 22 Aug 2022 11:08:25 +0530
Subject: [PATCH] Resolved compilation issue for media driver

Changes include:
- Added Android flag to disable error mode similar to
Linux

Change-Id: I456cd1d036783dabca1b18c2bade9f882b56a8a0
Tracked-On: OAM-104545
Signed-off-by: Ratnesh Kumar Rai <ratnesh.kumar.rai@intel.com>
Signed-off-by: yerriswamy <yerriswamy.kt@intel.com>
---
 cmrtlib/linux/hardware/cm_device_os.cpp                     | 6 ++++--
 media_driver/Android.mk                                     | 1 +
 media_softlet/agnostic/common/vp/kdll/hal_kerneldll_next.c  | 3 ++-
 .../linux/common/os/osservice/mos_utilities_specific.cpp    | 2 ++
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/cmrtlib/linux/hardware/cm_device_os.cpp b/cmrtlib/linux/hardware/cm_device_os.cpp
index 36b98c13a..e21292283 100644
--- a/cmrtlib/linux/hardware/cm_device_os.cpp
+++ b/cmrtlib/linux/hardware/cm_device_os.cpp
@@ -495,8 +495,10 @@ CmDevice_RT::CmDevice_RT(
     m_gtpinBufferUP1(nullptr),
     m_gtpinBufferUP2(nullptr),
     m_createOption(createOption),
-    m_driverStoreEnabled(0),
-    m_driFileDescriptor(0)
+    m_driverStoreEnabled(0)
+#ifndef ANDROID
+    ,m_driFileDescriptor(0)
+#endif
 {
 
     // New Surface Manager
diff --git a/media_driver/Android.mk b/media_driver/Android.mk
index e85b86e65..775d1f48f 100644
--- a/media_driver/Android.mk
+++ b/media_driver/Android.mk
@@ -1657,6 +1657,7 @@ LOCAL_C_INCLUDES  = \
     $(LOCAL_PATH)/../media_softlet/linux/common/os/i915_production \
     $(LOCAL_PATH)/../media_softlet/linux/common/os \
     $(LOCAL_PATH)/../media_softlet/linux/common/cp \
+    $(LOCAL_PATH)/../cmrtlib/linux/hardware
 
 
 #LOCAL_CPP_FEATURES := rtti exceptions
diff --git a/media_softlet/agnostic/common/vp/kdll/hal_kerneldll_next.c b/media_softlet/agnostic/common/vp/kdll/hal_kerneldll_next.c
index 69572eb3d..64c9405b4 100644
--- a/media_softlet/agnostic/common/vp/kdll/hal_kerneldll_next.c
+++ b/media_softlet/agnostic/common/vp/kdll/hal_kerneldll_next.c
@@ -3864,6 +3864,7 @@ bool KernelDll_BuildKernel_CmFc(Kdll_State *pState, Kdll_SearchState *pSearchSta
     VP_RENDER_FUNCTION_ENTER;
 
     // Disable pop-up box window for STL assertion to avoid VM hang in auto test.
+#ifndef ANDROID
 #if (!LINUX)
     ::SetErrorMode(SEM_FAILCRITICALERRORS | SEM_NOGPFAULTERRORBOX);
 #if defined(_MSC_VER)
@@ -3876,7 +3877,7 @@ bool KernelDll_BuildKernel_CmFc(Kdll_State *pState, Kdll_SearchState *pSearchSta
     _CrtSetReportFile(_CRT_ASSERT, _CRTDBG_FILE_STDERR);
 #endif
 #endif
-
+#endif
     pSearchState->KernelLink.dwSize  = DL_MAX_SYMBOLS;
     pSearchState->KernelLink.dwCount = 0;
     pSearchState->KernelLink.pLink   = pSearchState->LinkArray;
diff --git a/media_softlet/linux/common/os/osservice/mos_utilities_specific.cpp b/media_softlet/linux/common/os/osservice/mos_utilities_specific.cpp
index 4b799e3f6..566c63c7a 100644
--- a/media_softlet/linux/common/os/osservice/mos_utilities_specific.cpp
+++ b/media_softlet/linux/common/os/osservice/mos_utilities_specific.cpp
@@ -2493,6 +2493,7 @@ void MosUtilities::MosTraceEvent(
                 MOS_FreeMemory(pTraceBuf);
             }
         }
+#ifndef ANDROID
         if (keyword & (1ULL << TR_KEY_CALL_STACK))
         {
             // reserve space for header and stack size field.
@@ -2512,6 +2513,7 @@ void MosUtilities::MosTraceEvent(
                 size_t ret = write(MosUtilitiesSpecificNext::m_mosTraceFd, traceBuf, nLen);
             }
         }
+#endif
     }
     return;
 }
-- 
2.39.0

