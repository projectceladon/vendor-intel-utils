From 55ff470db9d4510a71ca69f2a50dee149c0df711 Mon Sep 17 00:00:00 2001
From: yerriswamy <yerriswamy.kt@intel.com>
Date: Fri, 28 Oct 2022 14:32:50 +0530
Subject: [PATCH] Support media stack on specified render node

Change-Id: Ia65ba0d2d2488e48e79a672d7a99bb6ddaf52a07
Tracked-On: OAM-104415
Signed-off-by: Mao, Marc <marc.mao@intel.com>
Signed-off-by: Ratnesh Kumar Rai <ratnesh.kumar.rai@intel.com>
Signed-off-by: yerriswamy <yerriswamy.kt@intel.com>
---
 va/android/va_android.cpp | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/va/android/va_android.cpp b/va/android/va_android.cpp
index 06f8646..540baf4 100644
--- a/va/android/va_android.cpp
+++ b/va/android/va_android.cpp
@@ -38,10 +38,11 @@
 #include <fcntl.h>
 #include <dlfcn.h>
 #include <errno.h>
+#include <sys/system_properties.h>
+#include <cutils/properties.h>
 
 
 #define CHECK_SYMBOL(func) { if (!func) printf("func %s not found\n", #func); return VA_STATUS_ERROR_UNKNOWN; }
-#define DEVICE_NAME "/dev/dri/renderD128"
 
 static int va_DisplayContextIsValid(
     VADisplayContextP pDisplayContext
@@ -76,13 +77,23 @@ static VAStatus va_DisplayContextGetNumCandidates(
 {
     VADriverContextP const ctx = pDisplayContext->pDriverContext;
     struct drm_state * drm_state = (struct drm_state *)ctx->drm_state;
+    char prop[PROPERTY_VALUE_MAX];
+    char rnode[128];
+
+    int isSuccess =__system_property_get("ro.acg.rnode", prop);
+    if(!isSuccess)
+    {
+        strcpy(prop, "0");
+    }
+    snprintf(rnode, sizeof(rnode), "/dev/dri/renderD%d", atoi(prop) + 128);
+    rnode[sizeof(rnode) - 1] = '\0';
 
     memset(drm_state, 0, sizeof(*drm_state));
-    drm_state->fd = open(DEVICE_NAME, O_RDWR | O_CLOEXEC);
+    drm_state->fd = open(rnode, O_RDWR | O_CLOEXEC);
 
     if (drm_state->fd < 0) {
         fprintf(stderr, "Cannot open DRM device '%s': %d, %s\n",
-                DEVICE_NAME, errno, strerror(errno));
+                rnode, errno, strerror(errno));
         return VA_STATUS_ERROR_UNKNOWN;
     }
     drm_state->auth_type = VA_DRM_AUTH_CUSTOM;
-- 
2.17.1

