From c4736ad02fd0ad6999ce799b83005a27af073bce Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Mon, 9 May 2022 09:14:25 +0800
Subject: [PATCH] drm: drm_file struct kABI compatibility workaround

The recent fix for DRM core
  patches.suse/drm-serialize-drm_file.master-with-a-new-spinlock.patch
introduced a new field in struct drm_file.
Apply the standard workaround to move it at the tail with __GENKSYMS__
for keeping the kABI compatibility; drm_file isn't embedded, so it
should be safe to do that.

Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 include/drm/drm_file.h | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/include/drm/drm_file.h b/include/drm/drm_file.h
index 726cfe0ff5f5..664ea457e66c 100644
--- a/include/drm/drm_file.h
+++ b/include/drm/drm_file.h
@@ -244,9 +244,6 @@ struct drm_file {
 	 */
 	struct drm_master *master;
 
-	/** @master_lock: Serializes @master. */
-	spinlock_t master_lookup_lock;
-
 	/** @pid: Process that opened this file. */
 	struct pid *pid;
 
@@ -362,6 +359,11 @@ struct drm_file {
 #if IS_ENABLED(CONFIG_DRM_LEGACY)
 	unsigned long lock_count; /* DRI1 legacy lock count */
 #endif
+
+#ifndef __GENKSYMS__
+	/** @master_lock: Serializes @master. */
+	spinlock_t master_lookup_lock;
+#endif
 };
 
 /**
-- 
2.38.1

