From 6dc300c6dcb14eacb4190675a100beb803b2f94c Mon Sep 17 00:00:00 2001
From: "Yan, Shaopu" <shaopu.yan@intel.com>
Date: Thu, 28 Sep 2023 05:19:11 +0800
Subject: [PATCH] unify mixin of optee and trusty into tee

Signed-off-by: Yan, Shaopu <shaopu.yan@intel.com>
---
 exempt_groups.txt                             |  2 +-
 groups/aaf/mixinfo.spec                       |  2 +-
 groups/boot-arch/project-celadon/option.spec  |  1 +
 groups/firststage-mount/mixinfo.spec          |  2 +-
 groups/gptbuild/mixinfo.spec                  |  2 +-
 groups/optee/doc.spec                         | 20 -------------------
 groups/optee/false/empty_dir                  |  0
 groups/{optee => tee}/default                 |  0
 groups/{trusty => tee}/doc.spec               | 19 ++++++++++++++----
 groups/tee/false/BoardConfig.mk               |  1 +
 groups/{trusty => tee}/false/product.mk       |  0
 groups/{optee => tee}/mixinfo.spec            |  0
 .../{optee/true => tee/optee}/AndroidBoard.mk |  0
 .../{optee/true => tee/optee}/BoardConfig.mk  |  2 +-
 groups/{optee/true => tee/optee}/fstab        |  0
 .../{optee/true => tee/optee}/fstab.recovery  |  0
 groups/{optee/true => tee/optee}/init.rc      |  0
 groups/{optee/true => tee/optee}/product.mk   |  0
 .../true => tee/trusty}/AndroidBoard.mk       |  0
 .../true => tee/trusty}/BoardConfig.mk        |  3 ++-
 groups/{trusty/true => tee/trusty}/files.spec |  0
 groups/{trusty/true => tee/trusty}/init.rc    |  0
 .../trusty}/load_trusty_modules.in            |  0
 .../{trusty/true => tee/trusty}/option.spec   |  0
 groups/{trusty/true => tee/trusty}/product.mk |  0
 .../{trusty/true => tee/trusty}/trusty_abl.mk |  0
 .../{trusty/true => tee/trusty}/trusty_efi.mk |  0
 .../trusty}/trusty_project-celadon.mk         |  0
 .../{trusty/true => tee/trusty}/trusty_sbl.mk |  0
 .../true => tee/trusty}/trusty_vsbl.mk        |  0
 groups/{trusty/true => tee/trusty}/ueventd.rc |  0
 groups/trusty/default                         |  1 -
 groups/trusty/false/BoardConfig.mk            |  1 -
 groups/trusty/mixinfo.spec                    |  2 --
 34 files changed, 24 insertions(+), 34 deletions(-)
 delete mode 100644 groups/optee/doc.spec
 delete mode 100644 groups/optee/false/empty_dir
 rename groups/{optee => tee}/default (100%)
 rename groups/{trusty => tee}/doc.spec (63%)
 create mode 100644 groups/tee/false/BoardConfig.mk
 rename groups/{trusty => tee}/false/product.mk (100%)
 rename groups/{optee => tee}/mixinfo.spec (100%)
 rename groups/{optee/true => tee/optee}/AndroidBoard.mk (100%)
 rename groups/{optee/true => tee/optee}/BoardConfig.mk (90%)
 rename groups/{optee/true => tee/optee}/fstab (100%)
 rename groups/{optee/true => tee/optee}/fstab.recovery (100%)
 rename groups/{optee/true => tee/optee}/init.rc (100%)
 rename groups/{optee/true => tee/optee}/product.mk (100%)
 rename groups/{trusty/true => tee/trusty}/AndroidBoard.mk (100%)
 rename groups/{trusty/true => tee/trusty}/BoardConfig.mk (97%)
 rename groups/{trusty/true => tee/trusty}/files.spec (100%)
 rename groups/{trusty/true => tee/trusty}/init.rc (100%)
 rename groups/{trusty/true => tee/trusty}/load_trusty_modules.in (100%)
 rename groups/{trusty/true => tee/trusty}/option.spec (100%)
 rename groups/{trusty/true => tee/trusty}/product.mk (100%)
 rename groups/{trusty/true => tee/trusty}/trusty_abl.mk (100%)
 rename groups/{trusty/true => tee/trusty}/trusty_efi.mk (100%)
 rename groups/{trusty/true => tee/trusty}/trusty_project-celadon.mk (100%)
 rename groups/{trusty/true => tee/trusty}/trusty_sbl.mk (100%)
 rename groups/{trusty/true => tee/trusty}/trusty_vsbl.mk (100%)
 rename groups/{trusty/true => tee/trusty}/ueventd.rc (100%)
 delete mode 120000 groups/trusty/default
 delete mode 100644 groups/trusty/false/BoardConfig.mk
 delete mode 100644 groups/trusty/mixinfo.spec

diff --git a/exempt_groups.txt b/exempt_groups.txt
index 6405fee..9f2d528 100644
--- a/exempt_groups.txt
+++ b/exempt_groups.txt
@@ -170,7 +170,7 @@ thermal
 touch
 tpm
 treble
-trusty
+tee
 unity-replacement
 usb
 usb-audio-init
diff --git a/groups/aaf/mixinfo.spec b/groups/aaf/mixinfo.spec
index 32c3014..c3e029d 100644
--- a/groups/aaf/mixinfo.spec
+++ b/groups/aaf/mixinfo.spec
@@ -1,2 +1,2 @@
 [mixinfo]
-deps = trusty
+deps = tee
diff --git a/groups/boot-arch/project-celadon/option.spec b/groups/boot-arch/project-celadon/option.spec
index 14aed9d..d51483a 100644
--- a/groups/boot-arch/project-celadon/option.spec
+++ b/groups/boot-arch/project-celadon/option.spec
@@ -51,3 +51,4 @@ x64 = false
 use_ec_uart = false
 ifwi_variant = release
 acrn = false
+trusty = false
diff --git a/groups/firststage-mount/mixinfo.spec b/groups/firststage-mount/mixinfo.spec
index 2b78ac5..1cf7c8f 100644
--- a/groups/firststage-mount/mixinfo.spec
+++ b/groups/firststage-mount/mixinfo.spec
@@ -1,2 +1,2 @@
 [mixinfo]
-deps = boot-arch disk-bus trusty
+deps = boot-arch disk-bus tee
diff --git a/groups/gptbuild/mixinfo.spec b/groups/gptbuild/mixinfo.spec
index 4b319e4..efa5d48 100644
--- a/groups/gptbuild/mixinfo.spec
+++ b/groups/gptbuild/mixinfo.spec
@@ -1,2 +1,2 @@
 [mixinfo]
-deps = trusty vendor-partition product-partition odm-partition acpi-partition acpio-partition dynamic-partitions vendor-boot
+deps = tee vendor-partition product-partition odm-partition acpi-partition acpio-partition dynamic-partitions vendor-boot
diff --git a/groups/optee/doc.spec b/groups/optee/doc.spec
deleted file mode 100644
index 590a52e..0000000
--- a/groups/optee/doc.spec
+++ /dev/null
@@ -1,20 +0,0 @@
-=== Overview
-
-this group is used to enable/disable OP-TEE solution.
-
---- deps
-
-    - sepolicy
-    - boot-arch
-
-
-==== Options
-
---- true
-this option will enable OP-TEE.
-
---- false
-this option will disable OP-TEE.
-
---- default
-when not explicitly selected in mixin spec file, the default option will be used.
diff --git a/groups/optee/false/empty_dir b/groups/optee/false/empty_dir
deleted file mode 100644
index e69de29..0000000
diff --git a/groups/optee/default b/groups/tee/default
similarity index 100%
rename from groups/optee/default
rename to groups/tee/default
diff --git a/groups/trusty/doc.spec b/groups/tee/doc.spec
similarity index 63%
rename from groups/trusty/doc.spec
rename to groups/tee/doc.spec
index 510f369..a40eddc 100644
--- a/groups/trusty/doc.spec
+++ b/groups/tee/doc.spec
@@ -1,6 +1,6 @@
 === Overview
 
-trusty is used to enable/disable VMM based TEE solution.
+The mixin of tee is used to enable/disable one of TEE solution(trusty/optee/false).
 
 --- deps
 
@@ -10,8 +10,8 @@ trusty is used to enable/disable VMM based TEE solution.
 
 ==== Options
 
---- true
-this option will enable VMM based TEE.
+--- trusty
+This option will enable Trusty based TEE.
 
     --- parameters
         - ref_target: the refernece target
@@ -31,8 +31,19 @@ this option will enable VMM based TEE.
         - hardware/intel/kernelflinger/libqltipc
         - kernel/bxt/drivers/trusty
 
+--- optee
+This option will enable the OP-Tee based TEE.
+    --- parameters
+
+    --- code dir
+        - vendor/intel/optee/optee_apps
+        - vendor/intel/optee/optee_client
+        - vendor/intel/optee/optee_test
+        - vendor/intel/optee/optee_os
+ 
+
 --- false
-this option will disable VMM based TEE.
+this option will disable TEE.
 
 --- default
 when not explicitly selected in mixin spec file, the default option will be used.
diff --git a/groups/tee/false/BoardConfig.mk b/groups/tee/false/BoardConfig.mk
new file mode 100644
index 0000000..cc86e55
--- /dev/null
+++ b/groups/tee/false/BoardConfig.mk
@@ -0,0 +1 @@
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/tee/disabled
diff --git a/groups/trusty/false/product.mk b/groups/tee/false/product.mk
similarity index 100%
rename from groups/trusty/false/product.mk
rename to groups/tee/false/product.mk
diff --git a/groups/optee/mixinfo.spec b/groups/tee/mixinfo.spec
similarity index 100%
rename from groups/optee/mixinfo.spec
rename to groups/tee/mixinfo.spec
diff --git a/groups/optee/true/AndroidBoard.mk b/groups/tee/optee/AndroidBoard.mk
similarity index 100%
rename from groups/optee/true/AndroidBoard.mk
rename to groups/tee/optee/AndroidBoard.mk
diff --git a/groups/optee/true/BoardConfig.mk b/groups/tee/optee/BoardConfig.mk
similarity index 90%
rename from groups/optee/true/BoardConfig.mk
rename to groups/tee/optee/BoardConfig.mk
index f789048..e707df6 100644
--- a/groups/optee/true/BoardConfig.mk
+++ b/groups/tee/optee/BoardConfig.mk
@@ -9,4 +9,4 @@ CROSS_COMPILE64 ?= x86_64-unknown-linux-gnu-
 OPTEE_EXTRA_TA_FLAGS ?= $(OPTEE_EXTRA_FLAGS)
 BUILD_OPTEE_MK := $(OPTEE_OS_DIR)/mk/aosp_optee.mk
 
-BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/optee/enabled
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/tee/optee
diff --git a/groups/optee/true/fstab b/groups/tee/optee/fstab
similarity index 100%
rename from groups/optee/true/fstab
rename to groups/tee/optee/fstab
diff --git a/groups/optee/true/fstab.recovery b/groups/tee/optee/fstab.recovery
similarity index 100%
rename from groups/optee/true/fstab.recovery
rename to groups/tee/optee/fstab.recovery
diff --git a/groups/optee/true/init.rc b/groups/tee/optee/init.rc
similarity index 100%
rename from groups/optee/true/init.rc
rename to groups/tee/optee/init.rc
diff --git a/groups/optee/true/product.mk b/groups/tee/optee/product.mk
similarity index 100%
rename from groups/optee/true/product.mk
rename to groups/tee/optee/product.mk
diff --git a/groups/trusty/true/AndroidBoard.mk b/groups/tee/trusty/AndroidBoard.mk
similarity index 100%
rename from groups/trusty/true/AndroidBoard.mk
rename to groups/tee/trusty/AndroidBoard.mk
diff --git a/groups/trusty/true/BoardConfig.mk b/groups/tee/trusty/BoardConfig.mk
similarity index 97%
rename from groups/trusty/true/BoardConfig.mk
rename to groups/tee/trusty/BoardConfig.mk
index ef46dcc..8c6e52f 100644
--- a/groups/trusty/true/BoardConfig.mk
+++ b/groups/tee/trusty/BoardConfig.mk
@@ -6,7 +6,8 @@ endif
 
 BOARD_USES_TRUSTY := true
 BOARD_USES_KEYMASTER1 := true
-BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/trusty/enabled
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/tee/trusty
+
 BOARD_SEPOLICY_M4DEFS += module_trusty=true
 
 TRUSTY_BUILDROOT = $(PWD)/$(PRODUCT_OUT)/obj/trusty/
diff --git a/groups/trusty/true/files.spec b/groups/tee/trusty/files.spec
similarity index 100%
rename from groups/trusty/true/files.spec
rename to groups/tee/trusty/files.spec
diff --git a/groups/trusty/true/init.rc b/groups/tee/trusty/init.rc
similarity index 100%
rename from groups/trusty/true/init.rc
rename to groups/tee/trusty/init.rc
diff --git a/groups/trusty/true/load_trusty_modules.in b/groups/tee/trusty/load_trusty_modules.in
similarity index 100%
rename from groups/trusty/true/load_trusty_modules.in
rename to groups/tee/trusty/load_trusty_modules.in
diff --git a/groups/trusty/true/option.spec b/groups/tee/trusty/option.spec
similarity index 100%
rename from groups/trusty/true/option.spec
rename to groups/tee/trusty/option.spec
diff --git a/groups/trusty/true/product.mk b/groups/tee/trusty/product.mk
similarity index 100%
rename from groups/trusty/true/product.mk
rename to groups/tee/trusty/product.mk
diff --git a/groups/trusty/true/trusty_abl.mk b/groups/tee/trusty/trusty_abl.mk
similarity index 100%
rename from groups/trusty/true/trusty_abl.mk
rename to groups/tee/trusty/trusty_abl.mk
diff --git a/groups/trusty/true/trusty_efi.mk b/groups/tee/trusty/trusty_efi.mk
similarity index 100%
rename from groups/trusty/true/trusty_efi.mk
rename to groups/tee/trusty/trusty_efi.mk
diff --git a/groups/trusty/true/trusty_project-celadon.mk b/groups/tee/trusty/trusty_project-celadon.mk
similarity index 100%
rename from groups/trusty/true/trusty_project-celadon.mk
rename to groups/tee/trusty/trusty_project-celadon.mk
diff --git a/groups/trusty/true/trusty_sbl.mk b/groups/tee/trusty/trusty_sbl.mk
similarity index 100%
rename from groups/trusty/true/trusty_sbl.mk
rename to groups/tee/trusty/trusty_sbl.mk
diff --git a/groups/trusty/true/trusty_vsbl.mk b/groups/tee/trusty/trusty_vsbl.mk
similarity index 100%
rename from groups/trusty/true/trusty_vsbl.mk
rename to groups/tee/trusty/trusty_vsbl.mk
diff --git a/groups/trusty/true/ueventd.rc b/groups/tee/trusty/ueventd.rc
similarity index 100%
rename from groups/trusty/true/ueventd.rc
rename to groups/tee/trusty/ueventd.rc
diff --git a/groups/trusty/default b/groups/trusty/default
deleted file mode 120000
index 02e4a84..0000000
--- a/groups/trusty/default
+++ /dev/null
@@ -1 +0,0 @@
-false
\ No newline at end of file
diff --git a/groups/trusty/false/BoardConfig.mk b/groups/trusty/false/BoardConfig.mk
deleted file mode 100644
index f660786..0000000
--- a/groups/trusty/false/BoardConfig.mk
+++ /dev/null
@@ -1 +0,0 @@
-BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/trusty/disabled
diff --git a/groups/trusty/mixinfo.spec b/groups/trusty/mixinfo.spec
deleted file mode 100644
index 964c9f3..0000000
--- a/groups/trusty/mixinfo.spec
+++ /dev/null
@@ -1,2 +0,0 @@
-[mixinfo]
-deps = sepolicy boot-arch device-specific
-- 
2.25.1

