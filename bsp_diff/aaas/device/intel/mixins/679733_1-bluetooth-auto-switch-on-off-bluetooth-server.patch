From 7e22f807cb04c6654d089a0b38130e629cccc841 Mon Sep 17 00:00:00 2001
From: Chen Lin Z <lin.z.chen@intel.com>
Date: Thu, 5 Sep 2019 16:21:10 +0800
Subject: [PATCH 2/4] bluetooth: auto switch on/off bluetooth server

Change-Id: I9696db7a517e3456152323006b8b79854e441f99
Tracked-On:
Signed-off-by: Chen Lin Z <lin.z.chen@intel.com>
---
 groups/bluetooth/btusb/bluetooth_auto_detection.sh | 28 ++++++++++++++++++++++
 groups/bluetooth/btusb/files.spec                  |  1 +
 groups/bluetooth/btusb/init.rc                     |  3 +++
 groups/bluetooth/btusb/product.mk                  |  3 +++
 4 files changed, 35 insertions(+)
 create mode 100755 groups/bluetooth/btusb/bluetooth_auto_detection.sh

diff --git a/groups/bluetooth/btusb/bluetooth_auto_detection.sh b/groups/bluetooth/btusb/bluetooth_auto_detection.sh
new file mode 100755
index 0000000..df99772
--- /dev/null
+++ b/groups/bluetooth/btusb/bluetooth_auto_detection.sh
@@ -0,0 +1,28 @@
+#!/vendor/bin/sh
+
+bt_server="com.android.bluetooth"
+bt_server_enable=1
+
+pm list packages -d | grep $bt_server
+if [ $? == 0 ]; then
+	bt_server_enable=0
+fi
+
+hciconfig | grep -q hci
+
+if [ $? != 0 ]; then
+	echo "no bluetooth device"
+	if [ $bt_server_enable == 1 ]; then
+		echo "disable bluetooth server"
+		pm disable $bt_server
+		echo "pm disable: $?"
+	fi
+else
+	echo "bluetooth device exists"
+	if [ $bt_server_enable == 0 ]; then
+		echo "bluetooth server is disabled, re-enable it"
+		pm enable $bt_server
+		echo "pm enable ret: $?"
+	fi
+fi
+
diff --git a/groups/bluetooth/btusb/files.spec b/groups/bluetooth/btusb/files.spec
index 753b237..4249172 100644
--- a/groups/bluetooth/btusb/files.spec
+++ b/groups/bluetooth/btusb/files.spec
@@ -1,2 +1,3 @@
 [extrafiles]
 load_bt.in: "load bluetooth usb driver module"
+bluetooth_auto_detection.sh: "auto switch on/off bluetooth server"
diff --git a/groups/bluetooth/btusb/init.rc b/groups/bluetooth/btusb/init.rc
index 19eca4d..667383d 100644
--- a/groups/bluetooth/btusb/init.rc
+++ b/groups/bluetooth/btusb/init.rc
@@ -9,6 +9,9 @@ on boot
 on post-fs-data
     mkdir /data/misc/dhcp 0770 dhcp system
 
+on property:vendor.boot_completed=1
+	exec u:r:init:s0 -- /system/bin/logwrapper /system/bin/sh /vendor/bin/bluetooth_auto_detection.sh
+
 service dhcpcd_bt-pan /system/bin/dhcpcd -ABKL
     disabled
     oneshot
diff --git a/groups/bluetooth/btusb/product.mk b/groups/bluetooth/btusb/product.mk
index 2094cd9..366ab6c 100644
--- a/groups/bluetooth/btusb/product.mk
+++ b/groups/bluetooth/btusb/product.mk
@@ -19,6 +19,9 @@ PRODUCT_COPY_FILES += \
     vendor/linux/firmware/intel/ibt-12-16.sfi:$(TARGET_COPY_OUT_VENDOR)/firmware/intel/ibt-12-16.sfi \
     vendor/linux/firmware/intel/ibt-hw-37.8.10-fw-22.50.19.14.f.bseq:$(TARGET_COPY_OUT_VENDOR)/firmware/intel/ibt-hw-37.8.10-fw-22.50.19.14.f.bseq
 
+PRODUCT_COPY_FILES += \
+	$(LOCAL_PATH)/{{_extra_dir}}/bluetooth_auto_detection.sh:vendor/bin/bluetooth_auto_detection.sh
+
 PRODUCT_PROPERTY_OVERRIDES += bluetooth.rfkill=1
 
 PRODUCT_PACKAGES += \
-- 
2.7.4

