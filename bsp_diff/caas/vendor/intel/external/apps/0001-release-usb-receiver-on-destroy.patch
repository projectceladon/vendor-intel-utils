From 0f53fb87baffa3f6c7338fe477799b33e4428e1f Mon Sep 17 00:00:00 2001
From: kbillore <kaushal.billore@intel.com>
Date: Tue, 21 Jul 2020 20:02:13 +0530
Subject: [PATCH] release usb receiver on destroy

during stability observed crash because of receiver
is not unregistered.

Solution: releasing receiver on application destroy

Tracked-On: OAM-91658
Signed-off-by: Shiva Kumara shiva.kumara.rudrappa@intel.com
Signed-off-by: kbillore <kaushal.billore@intel.com>
---
 .../intel/multicamera/FullScreenActivity.java | 17 ++++++++++++
 .../intel/multicamera/MultiViewActivity.java  | 26 +++++++++++++++++++
 .../multicamera/SingleCameraActivity.java     | 11 +++++++-
 3 files changed, 53 insertions(+), 1 deletion(-)

diff --git a/camera/MultiCameraApplication/java/com/intel/multicamera/FullScreenActivity.java b/camera/MultiCameraApplication/java/com/intel/multicamera/FullScreenActivity.java
index 361fd32..9295029 100644
--- a/camera/MultiCameraApplication/java/com/intel/multicamera/FullScreenActivity.java
+++ b/camera/MultiCameraApplication/java/com/intel/multicamera/FullScreenActivity.java
@@ -319,6 +319,7 @@ public class FullScreenActivity extends AppCompatActivity {
     }
 
     public void openBackCamera() {
+	System.out.println(TAG+"open back camera start");
         closeCamera();
 
         GetCameraCnt();
@@ -335,15 +336,21 @@ public class FullScreenActivity extends AppCompatActivity {
         updateStorageSpace(null);
 
         OpenOnlyBackCamera();
+	System.out.println(TAG+"open back camera end");
+
     }
 
     public void openFrontCamera() {
+	System.out.println(TAG+"open front camera start");
+
         closeCamera();
 
         GetCameraCnt();
         updateStorageSpace(null);
 
         OpenOnlyFrontCamera();
+	System.out.println(TAG+"open front camera end");
+
     }
 
     private void OpenOnlyFrontCamera() {
@@ -474,6 +481,16 @@ public class FullScreenActivity extends AppCompatActivity {
 
     }
 
+    @Override
+    protected void onDestroy() {
+        try {
+            unregisterReceiver(mUsbReceiver);
+        }catch (Exception e) {
+            Log.e(TAG, "fatal during unregister receiver");
+        }
+        super.onDestroy();
+    }
+
     @Override
     protected void onPause() {
         super.onPause();
diff --git a/camera/MultiCameraApplication/java/com/intel/multicamera/MultiViewActivity.java b/camera/MultiCameraApplication/java/com/intel/multicamera/MultiViewActivity.java
index 10d1624..711f55e 100644
--- a/camera/MultiCameraApplication/java/com/intel/multicamera/MultiViewActivity.java
+++ b/camera/MultiCameraApplication/java/com/intel/multicamera/MultiViewActivity.java
@@ -313,6 +313,8 @@ public class MultiViewActivity extends AppCompatActivity {
     }
 
     public void Open_TopLeftCam() {
+        System.out.println(TAG+"open top left camera  start");
+
         String[] Data = new String[5];
         ImageButton[] Buttons = new ImageButton[6];
 
@@ -357,9 +359,13 @@ public class MultiViewActivity extends AppCompatActivity {
 
         ic_camera.setTopLeftCam(new CameraBase(this, mTopLeftCam_textureView, Buttons, mRecordingTimeView,
                                      Data, roundedThumbnailView));
+        System.out.println(TAG+"open top left camera  end");
+
     }
 
     public void Open_TopRightCam() {
+        System.out.println(TAG+"open top right camera  start");
+
         String[] Data = new String[5];
         ImageButton[] Buttons = new ImageButton[6];
         mTopRightCam_textureView = findViewById(R.id.textureview1);
@@ -403,9 +409,13 @@ public class MultiViewActivity extends AppCompatActivity {
 
         ic_camera.setTopRightCam(new CameraBase(this, mTopRightCam_textureView, Buttons,
                                       mRecordingTimeView0, Data, roundedThumbnailView));
+        System.out.println(TAG+"open top right camera  end");
+
     }
 
     public void Open_BotmLeftCam() {
+        System.out.println(TAG+"open bot left camera  start");
+
         String[] Data = new String[5];
         ImageButton[] Buttons = new ImageButton[6];
         mBotmLeftCam_textureView = findViewById(R.id.textureview2);
@@ -450,9 +460,13 @@ public class MultiViewActivity extends AppCompatActivity {
 
         ic_camera.setBotLeftCam(new CameraBase(this, mBotmLeftCam_textureView, Buttons,
                                       mRecordingTimeView1, Data, roundedThumbnailView));
+        System.out.println(TAG+"open top left camera  end");
+
     }
 
     public void Open_BotmRightCam() {
+	System.out.println(TAG+"open bot right camera  start");
+
         String[] Data = new String[5];
         ImageButton[] Buttons = new ImageButton[6];
         mBotmRightCam_textureView = findViewById(R.id.textureview3);
@@ -495,6 +509,8 @@ public class MultiViewActivity extends AppCompatActivity {
 
         ic_camera.setBotRightCam(new CameraBase(this, mBotmRightCam_textureView, Buttons,
                                        mRecordingTimeView2, Data, roundedThumbnailView));
+        System.out.println(TAG+"open bot right camera  end");
+
     }
 
     private void manageTopLeftCam() {
@@ -663,6 +679,16 @@ public class MultiViewActivity extends AppCompatActivity {
         }
     }
 
+    @Override
+    protected void onDestroy() {
+        try {
+            unregisterReceiver(mUsbReceiver);
+        }catch (Exception e) {
+            Log.e(TAG, "fatal during unregister receiver");
+        }
+        super.onDestroy();
+    }
+
     @Override
     protected void onPause() {
         System.out.println("onPause");
diff --git a/camera/MultiCameraApplication/java/com/intel/multicamera/SingleCameraActivity.java b/camera/MultiCameraApplication/java/com/intel/multicamera/SingleCameraActivity.java
index ce8df32..7dd1ec1 100644
--- a/camera/MultiCameraApplication/java/com/intel/multicamera/SingleCameraActivity.java
+++ b/camera/MultiCameraApplication/java/com/intel/multicamera/SingleCameraActivity.java
@@ -361,7 +361,16 @@ public class SingleCameraActivity extends AppCompatActivity {
 
     }
 
-
+    @Override
+    protected void onDestroy() {
+        try {
+            unregisterReceiver(mUsbReceiver);
+        }catch (Exception e) {
+            Log.e(TAG, "fatal during unregister receiver");
+        }
+        super.onDestroy();
+    }
+    
     @Override
     protected void onPause() {
         super.onPause();
-- 
2.17.1

