From de8a68008ee1aff6df3281f1d79d0a7b32940c0e Mon Sep 17 00:00:00 2001
From: Chen Lin Z <lin.z.chen@intel.com>
Date: Mon, 21 Oct 2019 15:06:28 +0800
Subject: [PATCH] WA for gfx issue on old Laptops/PCs

Tracked-On:
Signed-off-by: Chen Lin Z <lin.z.chen@intel.com>
---
 cros_gralloc/cros_gralloc_driver.cc | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/cros_gralloc/cros_gralloc_driver.cc b/cros_gralloc/cros_gralloc_driver.cc
index 7581fb6..af2af0f 100644
--- a/cros_gralloc/cros_gralloc_driver.cc
+++ b/cros_gralloc/cros_gralloc_driver.cc
@@ -14,6 +14,8 @@
 #include <fcntl.h>
 #include <unistd.h>
 #include <xf86drm.h>
+#include <cutils/properties.h>
+#include <utils/Log.h>
 
 cros_gralloc_driver::cros_gralloc_driver() : drv_(nullptr)
 {
@@ -93,6 +95,18 @@ bool cros_gralloc_driver::is_supported(const struct cros_gralloc_buffer_descript
 	return (combo != nullptr);
 }
 
+bool IsOldGpu() {
+  const char* key = "ro.hardware.oldgpu";
+  char* value = new char[20];
+  const char* property_true = "true";
+  int len = property_get(key, value, "");
+  if (len > 0 && strcmp(value, property_true) == 0) {
+    return true;
+  } else {
+    return false;
+  }
+}
+
 int32_t cros_gralloc_driver::allocate(const struct cros_gralloc_buffer_descriptor *descriptor,
 				      buffer_handle_t *out_handle)
 {
@@ -105,6 +119,10 @@ int32_t cros_gralloc_driver::allocate(const struct cros_gralloc_buffer_descripto
 	struct cros_gralloc_handle *hnd;
 
 	resolved_format = drv_resolve_format(drv_, descriptor->drm_format, descriptor->use_flags);
+    if (resolved_format == DRM_FORMAT_ABGR8888 && IsOldGpu()) {
+            resolved_format = DRM_FORMAT_XBGR8888;
+            //ALOGE("gralloc: Set to XB24");
+    }
 	if (descriptor->modifier == 0) {
 		bo = drv_bo_create(drv_, descriptor->width, descriptor->height, resolved_format,
 				   descriptor->use_flags);
-- 
1.9.1

