From e457d52c0f4a1304dc3350d5465706ec989ef203 Mon Sep 17 00:00:00 2001
From: varun <varunx.jeevangoudar@intel.com>
Date: Tue, 20 Nov 2018 15:02:33 +0530
Subject: [PATCH] [CELADON] Fix no notification seen for an alarm set

Change-Id: Ica3665ddc936133481f4b271c50fc8c8cfc274a9
Tracked-On:OAM-70638
Signed-off-by: varun <varunx.jeevangoudar@intel.com>
---
 .../deskclock/alarms/AlarmNotifications.java       | 42 +++++-----------------
 1 file changed, 9 insertions(+), 33 deletions(-)

diff --git a/src/com/android/deskclock/alarms/AlarmNotifications.java b/src/com/android/deskclock/alarms/AlarmNotifications.java
index 10735e4..ada6bc9 100644
--- a/src/com/android/deskclock/alarms/AlarmNotifications.java
+++ b/src/com/android/deskclock/alarms/AlarmNotifications.java
@@ -90,8 +90,7 @@ final class AlarmNotifications {
             AlarmInstance instance) {
         LogUtils.v("Displaying low priority notification for alarm instance: " + instance.mId);

-        createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_LOW);
-        Notification.Builder builder = new Notification.Builder(context)
+	NotificationCompat.Builder builder = new NotificationCompat.Builder(context)
                 .setShowWhen(false)
                 .setContentTitle(context.getString(
                         R.string.alarm_alert_predismiss_title))
@@ -103,7 +102,6 @@ final class AlarmNotifications {
                 .setPriority(NotificationCompat.PRIORITY_DEFAULT)
                 .setCategory(NotificationCompat.CATEGORY_ALARM)
                 .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                .setChannelId(CHANNEL_ID_ALARM)
                 .setLocalOnly(true);

         if (Utils.isNOrLater()) {
@@ -141,9 +139,8 @@ final class AlarmNotifications {
             AlarmInstance instance) {
         LogUtils.v("Displaying high priority notification for alarm instance: " + instance.mId);

-        createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_HIGH);
-        Notification.Builder builder = new Notification.Builder(context)
-                .setShowWhen(false)
+        NotificationCompat.Builder builder = new NotificationCompat.Builder(context)
+				.setShowWhen(false)
                 .setContentTitle(context.getString(R.string.alarm_alert_predismiss_title))
                 .setContentText(AlarmUtils.getAlarmText(context, instance, true /* includeLabel */))
                 .setColor(ContextCompat.getColor(context, R.color.default_background))
@@ -153,7 +150,6 @@ final class AlarmNotifications {
                 .setPriority(NotificationCompat.PRIORITY_HIGH)
                 .setCategory(NotificationCompat.CATEGORY_ALARM)
                 .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                .setChannelId(CHANNEL_ID_ALARM)
                 .setLocalOnly(true);

         if (Utils.isNOrLater()) {
@@ -252,8 +248,7 @@ final class AlarmNotifications {
         if (summary == null
                 || !Objects.equals(summary.contentIntent, firstUpcoming.contentIntent)) {

-            createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_LOW);
-            summary = new Notification.Builder(context)
+            summary = new NotificationCompat.Builder(context)
                     .setShowWhen(false)
                     .setContentIntent(firstUpcoming.contentIntent)
                     .setColor(ContextCompat.getColor(context, R.color.default_background))
@@ -263,7 +258,6 @@ final class AlarmNotifications {
                     .setPriority(NotificationCompat.PRIORITY_HIGH)
                     .setCategory(NotificationCompat.CATEGORY_ALARM)
                     .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                    .setChannelId(CHANNEL_ID_ALARM)
                     .setLocalOnly(true)
                     .build();
             nm.notify(ALARM_GROUP_NOTIFICATION_ID, summary);
@@ -289,8 +283,7 @@ final class AlarmNotifications {
         if (summary == null
                 || !Objects.equals(summary.contentIntent, firstMissed.contentIntent)) {

-            createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_LOW);
-            summary = new Notification.Builder(context)
+            summary = new NotificationCompat.Builder(context)
                     .setShowWhen(false)
                     .setContentIntent(firstMissed.contentIntent)
                     .setColor(ContextCompat.getColor(context, R.color.default_background))
@@ -300,7 +293,6 @@ final class AlarmNotifications {
                     .setPriority(NotificationCompat.PRIORITY_HIGH)
                     .setCategory(NotificationCompat.CATEGORY_ALARM)
                     .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                    .setChannelId(CHANNEL_ID_ALARM)
                     .setLocalOnly(true)
                     .build();
             nm.notify(ALARM_GROUP_MISSED_NOTIFICATION_ID, summary);
@@ -311,9 +303,8 @@ final class AlarmNotifications {
             AlarmInstance instance) {
         LogUtils.v("Displaying snoozed notification for alarm instance: " + instance.mId);

-        createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_LOW);
-        Notification.Builder builder = new Notification.Builder(context)
-                .setShowWhen(false)
+        NotificationCompat.Builder builder = new NotificationCompat.Builder(context)
+				.setShowWhen(false)
                 .setContentTitle(instance.getLabelOrDefault(context))
                 .setContentText(context.getString(R.string.alarm_alert_snooze_until,
                         AlarmUtils.getFormattedTime(context, instance.getAlarmTime())))
@@ -324,7 +315,6 @@ final class AlarmNotifications {
                 .setPriority(NotificationCompat.PRIORITY_MAX)
                 .setCategory(NotificationCompat.CATEGORY_ALARM)
                 .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                .setChannelId(CHANNEL_ID_ALARM)
                 .setLocalOnly(true);

         if (Utils.isNOrLater()) {
@@ -358,8 +348,7 @@ final class AlarmNotifications {
         String label = instance.mLabel;
         String alarmTime = AlarmUtils.getFormattedTime(context, instance.getAlarmTime());

-        createNotificationAlarmChannel(context, NotificationManager.IMPORTANCE_LOW);
-        Notification.Builder builder = new Notification.Builder(context)
+		NotificationCompat.Builder builder = new NotificationCompat.Builder(context)
                 .setShowWhen(false)
                 .setContentTitle(context.getString(R.string.alarm_missed_title))
                 .setContentText(instance.mLabel.isEmpty() ? alarmTime :
@@ -370,7 +359,6 @@ final class AlarmNotifications {
                 .setPriority(NotificationCompat.PRIORITY_HIGH)
                 .setCategory(NotificationCompat.CATEGORY_ALARM)
                 .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                .setChannelId(CHANNEL_ID_ALARM)
                 .setLocalOnly(true);

         if (Utils.isNOrLater()) {
@@ -404,8 +392,7 @@ final class AlarmNotifications {

         Resources resources = service.getResources();

-        createNotificationAlarmChannel(service, NotificationManager.IMPORTANCE_HIGH);
-        Notification.Builder notification = new Notification.Builder(service)
+        NotificationCompat.Builder notification = new NotificationCompat.Builder(service)
                 .setContentTitle(instance.getLabelOrDefault(service))
                 .setContentText(AlarmUtils.getFormattedTime(service, instance.getAlarmTime()))
                 .setColor(ContextCompat.getColor(service, R.color.default_background))
@@ -416,7 +403,6 @@ final class AlarmNotifications {
                 .setWhen(0)
                 .setCategory(NotificationCompat.CATEGORY_ALARM)
                 .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
-                .setChannelId(CHANNEL_ID_ALARM)
                 .setLocalOnly(true);

         // Setup Snooze Action
@@ -512,14 +498,4 @@ final class AlarmNotifications {
         return missedAlarm ? ("MISSED " + timeKey) : timeKey;
     }

-    private static void createNotificationAlarmChannel(Context context, int important) {
-        if (!BuildCompat.isAtLeastO()) {
-            return;
-        }
-        final NotificationManager nm = context.getSystemService(NotificationManager.class);
-        final NotificationChannel channel = new NotificationChannel(CHANNEL_ID_ALARM,
-            context.getString(R.string.default_label),
-            important);
-            nm.createNotificationChannel(channel);
-    }
 }
--
1.9.1
