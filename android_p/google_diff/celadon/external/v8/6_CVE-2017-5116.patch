From 8e0f0da7ffdc39199f787febe8b5d4d5da482c8b Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 19:59:23 +0800
Subject: [PATCH] CVE-2017-5116 fix

Reference https://chromium.googlesource.com/v8/v8.git/+/5b0aca522d3f25a0e612706e7cdddf526e16a59f

Change-Id: I73f63f783aec3cd0a120a18b8f1880d27ea61208
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/src/wasm/wasm-module.cc b/src/wasm/wasm-module.cc
index c218805..d481b75 100644
--- a/src/wasm/wasm-module.cc
+++ b/src/wasm/wasm-module.cc
@@ -2614,8 +2614,14 @@
     return {};
   }
 
-  ModuleResult result =
-      DecodeWasmModule(isolate, bytes.start(), bytes.end(), false, kWasmOrigin);
+  // TODO(titzer): only make a copy of the bytes if SharedArrayBuffer
+  std::unique_ptr<byte[]> copy(new byte[bytes.length()]);
+  memcpy(copy.get(), bytes.start(), bytes.length());
+  ModuleWireBytes bytes_copy(copy.get(), copy.get() + bytes.length());
+
+  ModuleResult result = DecodeWasmModule(
+      isolate, bytes_copy.start(), bytes_copy.end(), false, kWasmOrigin);
+
   if (result.failed()) {
     if (result.val) delete result.val;
     thrower->CompileFailed("Wasm decoding failed", result);
@@ -2623,7 +2629,7 @@
   }
 
   CompilationHelper helper(isolate, const_cast<WasmModule*>(result.val));
-  return helper.CompileToModuleObject(thrower, bytes, Handle<Script>(),
+  return helper.CompileToModuleObject(thrower, bytes_copy, Handle<Script>(),
                                       Vector<const byte>());
 }
 
