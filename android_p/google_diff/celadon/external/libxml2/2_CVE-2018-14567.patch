From c6734d0ce59d9b2b851f616af71a12172ba04c86 Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 19:27:01 +0800
Subject: [PATCH] VE-2018-14567 fix

Reference https://raw.githubusercontent.com/intel/luv-yocto/master/meta/recipes-core/libxml/libxml2/0001-Fix-infinite-loop-in-LZMA-decompression.patch

Change-Id: I4d28f0799b71e274fa769f9387c2caeb40c207ec
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/xzlib.c b/xzlib.c
index a839169..0ba88cf 100644
--- a/xzlib.c
+++ b/xzlib.c
@@ -562,6 +562,10 @@
                          "internal error: inflate stream corrupt");
                 return -1;
             }
+            /*
+             * FIXME: Remapping a couple of error codes and falling through
+             * to the LZMA error handling looks fragile.
+             */
             if (ret == Z_MEM_ERROR)
                 ret = LZMA_MEM_ERROR;
             if (ret == Z_DATA_ERROR)
@@ -587,6 +591,11 @@
             xz_error(state, LZMA_PROG_ERROR, "compression error");
             return -1;
         }
+        if ((state->how != GZIP) &&
+            (ret != LZMA_OK) && (ret != LZMA_STREAM_END)) {
+            xz_error(state, ret, "lzma error");
+            return -1;
+        }
     } while (strm->avail_out && ret != LZMA_STREAM_END);
 
     /* update available output and crc check value */
