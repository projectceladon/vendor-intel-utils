From 161615f17a89acab0970d9aaa16e777818e204d3 Mon Sep 17 00:00:00 2001
From: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
Date: Thu, 11 Apr 2019 16:48:49 +0530
Subject: [PATCH] mixin updates adding android property

Signed-off-by: rugnathr <rugnath.ram@intel.com>
---
 clk/BoardConfig.mk |  2 +-
 clk/clk.mk         |  5 -----
 clk/device.mk      |  4 ++++
 clk/init.rc        | 18 ++++++++++++++++--
 clk/ueventd.rc     |  2 +-
 5 files changed, 22 insertions(+), 9 deletions(-)

diff --git a/clk/BoardConfig.mk b/clk/BoardConfig.mk
index 9cbb874..931ec67 100644
--- a/clk/BoardConfig.mk
+++ b/clk/BoardConfig.mk
@@ -92,7 +92,7 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/debugfs
 # Source: device/intel/mixins/groups/usb-gadget/g_ffs/BoardConfig.mk
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/usb
-
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/usb-gadget
 ##############################################################
 # Source: device/intel/mixins/groups/slot-ab/true/BoardConfig.mk
 ##############################################################
diff --git a/clk/clk.mk b/clk/clk.mk
index 699f8b1..2ed877a 100644
--- a/clk/clk.mk
+++ b/clk/clk.mk
@@ -6,11 +6,6 @@ $(call inherit-product,device/intel/project-celadon/clk/device.mk)
 include build/make/target/product/treble_common.mk
 BOARD_PROPERTY_OVERRIDES_SPLIT_ENABLED := true
 
-# Include GMS application
-FLAG_GMS_MINIMAL := true
-FLAG_GMS_AVAILABLE := true
-$(call inherit-product-if-exists, vendor/google/gms/products/gms.mk)
-
 # Overrides
 PRODUCT_NAME := clk
 PRODUCT_BRAND := clk
diff --git a/clk/device.mk b/clk/device.mk
index 101f969..69244ae 100644
--- a/clk/device.mk
+++ b/clk/device.mk
@@ -107,6 +107,10 @@ PRODUCT_PROPERTY_OVERRIDES += \
 PRODUCT_PROPERTY_OVERRIDES += \
     ro.input.noresample=1
 
+# set default DBC configuration
+PRODUCT_PROPERTY_OVERRIDES += \
+    persist.vendor.sys.usb.adbover=dwc
+
 # AOSP Packages
 PRODUCT_PACKAGES += \
     Launcher3 \
diff --git a/clk/init.rc b/clk/init.rc
index d6ce778..602bae8 100644
--- a/clk/init.rc
+++ b/clk/init.rc
@@ -105,7 +105,7 @@ on boot
     write /sys/kernel/debug/pstate_snb/setpoint 75
 
     # adb over ethernet
-    setprop service.adb.tcp.port 5555
+    # setprop service.adb.tcp.port 5555
 
 service watchdogd /sbin/watchdogd 10 30
     user root
@@ -128,6 +128,20 @@ on fs
    # Update dm-verity persistent state and set partition.*.verified
    # properties
    verity_update_state
+
+# switch adb over dwc
+on property:persist.vendor.sys.usb.adbover=dwc
+#    write /sys/bus/pci/devices/0000:00:14.0/dbc disable
+    stop adbd
+    start adbd
+
+# switch adb over dbc
+on property:persist.vendor.sys.usb.adbover=dbc
+    write /sys/bus/pci/devices/0000:00:14.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:15.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:39.0/dbc enable
+    stop adbd
+    start adbd
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/init.rc.1
 ##############################################################
@@ -745,7 +759,7 @@ on boot
 
 on post-fs-data
     # Enable swaps described in the fstab
-    swapon_all /vendor/etc/fstab.${ro.hardware}
+    swapon_all /fstab.${ro.hardware}
 ##############################################################
 # Source: device/intel/mixins/groups/debug-kernel/default/init.rc
 ##############################################################
diff --git a/clk/ueventd.rc b/clk/ueventd.rc
index 4645262..b18f329 100644
--- a/clk/ueventd.rc
+++ b/clk/ueventd.rc
@@ -34,7 +34,7 @@
 /dev/ttyUSB*              0660   radio      radio
 /dev/iio:device*          0660   system     system
 /dev/radio0               0660   bluetooth  audio
-
+/dev/dbc_raw*		  0777	 system	    system
 /sys/devices/pci0000:00/0000:00:02.0/drm/card*/card*/intel_backlight brightness 0644 system system
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/ueventd.rc
-- 
2.20.1

