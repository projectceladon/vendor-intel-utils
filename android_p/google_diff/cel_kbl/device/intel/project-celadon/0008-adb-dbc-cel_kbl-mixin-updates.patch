From bc9b8713d20f547e712ba6e58227a83be8af4596 Mon Sep 17 00:00:00 2001
From: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
Date: Mon, 22 Apr 2019 16:10:35 +0530
Subject: [PATCH] adb : dbc: cel_kbl mixin updates

Tracked-On:
Signed-off-by: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
---
 cel_kbl/BoardConfig.mk |  6 +++---
 cel_kbl/device.mk      |  4 ++++
 cel_kbl/init.rc        | 19 ++++++++++++++++++-
 cel_kbl/ueventd.rc     |  2 +-
 4 files changed, 26 insertions(+), 5 deletions(-)

diff --git a/cel_kbl/BoardConfig.mk b/cel_kbl/BoardConfig.mk
index c88d925..f21689b 100644
--- a/cel_kbl/BoardConfig.mk
+++ b/cel_kbl/BoardConfig.mk
@@ -286,7 +286,7 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/debugfs
 # Source: device/intel/mixins/groups/usb-gadget/g_ffs/BoardConfig.mk
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/usb
-
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/usb-gadget
 ##############################################################
 # Source: device/intel/mixins/groups/kernel/project-celadon/BoardConfig.mk
 ##############################################################
@@ -399,7 +399,7 @@ DEVICE_PACKAGE_OVERLAYS += device/intel/common/wlan/overlay-wifi-tethering
 BOARD_SEPOLICY_M4DEFS += module_iwlwifi=true
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/wlan/iwlwifi
 ##############################################################
-# Source: device/intel/mixins/groups/cpu-arch/skl/BoardConfig.mk
+# Source: device/intel/mixins/groups/cpu-arch/kbl/BoardConfig.mk
 ##############################################################
 ifeq ($(BOARD_USE_64BIT_USERSPACE),true)
 # 64b-specific items:
@@ -413,8 +413,8 @@ TARGET_2ND_CPU_VARIANT := x86
 else
 # 32b-specific items:
 TARGET_ARCH := x86
-TARGET_ARCH_VARIANT := kabylake
 TARGET_CPU_ABI := x86
+TARGET_ARCH_VARIANT := kabylake
 endif
 ##############################################################
 # Source: device/intel/mixins/groups/cpuset/autocores/BoardConfig.mk
diff --git a/cel_kbl/device.mk b/cel_kbl/device.mk
index 2e265ec..19193e4 100644
--- a/cel_kbl/device.mk
+++ b/cel_kbl/device.mk
@@ -260,6 +260,10 @@ PRODUCT_PROPERTY_OVERRIDES += \
 PRODUCT_PROPERTY_OVERRIDES += \
     ro.input.noresample=1
 
+# set default DBC configuration
+PRODUCT_PROPERTY_OVERRIDES += \
+    persist.vendor.sys.usb.adbover=dwc
+
 # AOSP Packages
 PRODUCT_PACKAGES += \
     Launcher3 \
diff --git a/cel_kbl/init.rc b/cel_kbl/init.rc
index 0dc7512..a1a26e9 100644
--- a/cel_kbl/init.rc
+++ b/cel_kbl/init.rc
@@ -100,6 +100,9 @@ on fs
     mkdir /dev/pstore 0755 root system
     mount pstore pstore /dev/pstore
 
+on post-fs
+    setprop ro.setupwizard.mode DISABLED
+
 on post-fs-data
     mkdir /data/kpanic 0770 system system
     mkdir /data/kpanic/pstore 0770 system system
@@ -152,7 +155,7 @@ on boot
     write /sys/kernel/debug/pstate_snb/setpoint 75
 
     # adb over ethernet
-    setprop service.adb.tcp.port 5555
+    # setprop service.adb.tcp.port 5555
 
 service watchdogd /sbin/watchdogd 10 30
     user root
@@ -175,6 +178,20 @@ on fs
    # Update dm-verity persistent state and set partition.*.verified
    # properties
    verity_update_state
+
+# switch adb over dwc
+on property:persist.vendor.sys.usb.adbover=dwc
+#    write /sys/bus/pci/devices/0000:00:14.0/dbc disable
+    stop adbd
+    start adbd
+
+# switch adb over dbc
+on property:persist.vendor.sys.usb.adbover=dbc
+    write /sys/bus/pci/devices/0000:00:14.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:15.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:39.0/dbc enable
+    stop adbd
+    start adbd
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/init.rc.1
 ##############################################################
diff --git a/cel_kbl/ueventd.rc b/cel_kbl/ueventd.rc
index 12d58f2..6277968 100644
--- a/cel_kbl/ueventd.rc
+++ b/cel_kbl/ueventd.rc
@@ -38,7 +38,7 @@
 /dev/ttyUSB*              0660   radio      radio
 /dev/iio:device*          0660   system     system
 /dev/radio0               0660   bluetooth  audio
-
+/dev/dbc_raw*		  0777	 system	    system
 /sys/devices/pci0000:00/0000:00:02.0/drm/card*/card*/intel_backlight brightness 0644 system system
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/ueventd.rc
-- 
2.21.0

