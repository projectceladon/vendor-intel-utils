From 9c0bef8fd0d8a6b1cc98acebc0eb8c2bcd67f70d Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 18:31:43 +0800
Subject: [PATCH] CVE-2018-14618 fix

Reference
https://github.com/curl/curl/commit/57d299a499155d4b327e341c6024e293b0418243.patch
https://github.com/curl/curl/blob/e81cd9028f2ef6656df6653dcf7871a5fa081e2e/lib/curl_setup.h#L454

Change-Id: I820f72aa72a7597686ff8931e39b8615ac0c56ff
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/lib/curl_ntlm_core.c b/lib/curl_ntlm_core.c
index e896276..596265f 100644
--- a/lib/curl_ntlm_core.c
+++ b/lib/curl_ntlm_core.c
@@ -557,8 +557,11 @@
                                    unsigned char *ntbuffer /* 21 bytes */)
 {
   size_t len = strlen(password);
-  unsigned char *pw = len ? malloc(len * 2) : strdup("");
+  unsigned char *pw;
   CURLcode result;
+  if(len > SIZE_T_MAX/2) /* avoid integer overflow */
+    return CURLE_OUT_OF_MEMORY;
+  pw = len ? malloc(len * 2) : strdup("");
   if(!pw)
     return CURLE_OUT_OF_MEMORY;
 
diff --git a/lib/curl_setup.h b/lib/curl_setup.h
index 609ee9e..6c2a739 100644
--- a/lib/curl_setup.h
+++ b/lib/curl_setup.h
@@ -424,6 +424,15 @@
 #endif
 #define CURL_OFF_T_MIN (-CURL_OFF_T_MAX - CURL_OFF_T_C(1))
 
+#ifndef SIZE_T_MAX
+/* some limits.h headers have this defined, some don't */
+#if defined(SIZEOF_SIZE_T) && (SIZEOF_SIZE_T > 4)
+#define SIZE_T_MAX 18446744073709551615U
+#else
+#define SIZE_T_MAX 4294967295U
+#endif
+#endif
+
 /*
  * Arg 2 type for gethostname in case it hasn't been defined in config file.
  */
