From ebd22df12fd61036b45b825d6d3953daf4a18ee9 Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 20:07:29 +0800
Subject: [PATCH] CVE-2018-6036 fix

Reference https://chromium.googlesource.com/v8/v8.git/+/b299115d88b53dfe18225892c6c813d7ba112705

Change-Id: Ie6d10e8f4a68c61809c6803c39651d891a5c7d8c
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/src/wasm/module-decoder.cc b/src/wasm/module-decoder.cc
index 0c765f2..5d8086a 100644
--- a/src/wasm/module-decoder.cc
+++ b/src/wasm/module-decoder.cc
@@ -1334,8 +1334,13 @@
     uint32_t name_offset = decoder.pc_offset();
     decoder.consume_bytes(name_length, "section name");
     uint32_t payload_offset = decoder.pc_offset();
+    if (section_length < (payload_offset - section_start)) {
+      decoder.error("invalid section length");
+      break;
+    }
     uint32_t payload_length = section_length - (payload_offset - section_start);
     decoder.consume_bytes(payload_length);
+    if (decoder.failed()) break;
     result.push_back({section_start, name_offset, name_length, payload_offset,
                       payload_length, section_length});
   }
