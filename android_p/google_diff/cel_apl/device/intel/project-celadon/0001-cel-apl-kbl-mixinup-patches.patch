From ff2134bdd61b1c8011b77ffef8c4db089f608832 Mon Sep 17 00:00:00 2001
From: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
Date: Mon, 22 Apr 2019 11:50:54 +0530
Subject: [PATCH] cel : apl : kbl: mixinup patches

Tracked-On:
Signed-off-by: Prabhat Chand Pandey <prabhat.chand.pandey@intel.com>
---
 cel_apl/BoardConfig.mk |  6 +++++-
 cel_apl/device.mk      | 22 ++++++++++++++++++++++
 cel_apl/init.rc        | 19 ++++++++++++++++++-
 cel_apl/ueventd.rc     |  2 +-
 cel_kbl/BoardConfig.mk | 10 +++++++---
 cel_kbl/device.mk      | 22 ++++++++++++++++++++++
 cel_kbl/init.rc        | 16 +++++++++++++++-
 cel_kbl/ueventd.rc     |  2 +-
 8 files changed, 91 insertions(+), 8 deletions(-)

diff --git a/cel_apl/BoardConfig.mk b/cel_apl/BoardConfig.mk
index 3c93918..12e2af6 100644
--- a/cel_apl/BoardConfig.mk
+++ b/cel_apl/BoardConfig.mk
@@ -88,7 +88,7 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/debugfs
 # Source: device/intel/mixins/groups/usb-gadget/g_ffs/BoardConfig.mk
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/usb
-
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/usb-gadget
 ##############################################################
 # Source: device/intel/mixins/groups/slot-ab/true/BoardConfig.mk
 ##############################################################
@@ -522,4 +522,8 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/drm-default
 ifneq ($(TARGET_BUILD_VARIANT),user)
 BOARD_KERNEL_CMDLINE += console=ttyUSB0,115200n8
 endif
+##############################################################
+# Source: device/intel/mixins/groups/neuralnetworks/true/BoardConfig.mk
+##############################################################
+BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/neuralnetworks
 # ------------------ END MIX-IN DEFINITIONS ------------------
diff --git a/cel_apl/device.mk b/cel_apl/device.mk
index a1e34e0..9b46415 100644
--- a/cel_apl/device.mk
+++ b/cel_apl/device.mk
@@ -107,6 +107,10 @@ PRODUCT_PROPERTY_OVERRIDES += \
 PRODUCT_PROPERTY_OVERRIDES += \
     ro.input.noresample=1
 
+# set default DBC configuration
+PRODUCT_PROPERTY_OVERRIDES += \
+    persist.vendor.sys.usb.adbover=dwc
+
 # AOSP Packages
 PRODUCT_PACKAGES += \
     Launcher3 \
@@ -791,6 +795,24 @@ PRODUCT_PACKAGES += android.hardware.drm@1.0-service \
                     android.hardware.drm@1.0-impl \
                     android.hardware.drm@1.1-service.clearkey
 
+##############################################################
+# Source: device/intel/mixins/groups/neuralnetworks/true/product.mk
+##############################################################
+# neuralnetworks HAL
+PRODUCT_PACKAGES += \
+    android.hardware.neuralnetworks@1.0-generic-service \
+    android.hardware.neuralnetworks@1.0-generic-impl
+
+PRODUCT_PACKAGES += \
+    libinference_engine
+
+PRODUCT_PACKAGES += \
+    libMKLDNNPlugin\
+    libmkldnn
+
+PRODUCT_PACKAGES += \
+    graphtest_cpu
+
 ##############################################################
 # Source: device/intel/mixins/groups/debug-kernel/default/product.mk
 ##############################################################
diff --git a/cel_apl/init.rc b/cel_apl/init.rc
index e10a3d1..7b52974 100644
--- a/cel_apl/init.rc
+++ b/cel_apl/init.rc
@@ -50,6 +50,9 @@ on fs
     mkdir /dev/pstore 0755 root system
     mount pstore pstore /dev/pstore
 
+on post-fs
+    setprop ro.setupwizard.mode DISABLED
+
 on post-fs-data
     mkdir /data/kpanic 0770 system system
     mkdir /data/kpanic/pstore 0770 system system
@@ -102,7 +105,7 @@ on boot
     write /sys/kernel/debug/pstate_snb/setpoint 75
 
     # adb over ethernet
-    setprop service.adb.tcp.port 5555
+    # setprop service.adb.tcp.port 5555
 
 service watchdogd /sbin/watchdogd 10 30
     user root
@@ -125,6 +128,20 @@ on fs
    # Update dm-verity persistent state and set partition.*.verified
    # properties
    verity_update_state
+
+# switch adb over dwc
+on property:persist.vendor.sys.usb.adbover=dwc
+#    write /sys/bus/pci/devices/0000:00:14.0/dbc disable
+    stop adbd
+    start adbd
+
+# switch adb over dbc
+on property:persist.vendor.sys.usb.adbover=dbc
+    write /sys/bus/pci/devices/0000:00:14.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:15.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:39.0/dbc enable
+    stop adbd
+    start adbd
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/init.rc.1
 ##############################################################
diff --git a/cel_apl/ueventd.rc b/cel_apl/ueventd.rc
index 4645262..b18f329 100644
--- a/cel_apl/ueventd.rc
+++ b/cel_apl/ueventd.rc
@@ -34,7 +34,7 @@
 /dev/ttyUSB*              0660   radio      radio
 /dev/iio:device*          0660   system     system
 /dev/radio0               0660   bluetooth  audio
-
+/dev/dbc_raw*		  0777	 system	    system
 /sys/devices/pci0000:00/0000:00:02.0/drm/card*/card*/intel_backlight brightness 0644 system system
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/ueventd.rc
diff --git a/cel_kbl/BoardConfig.mk b/cel_kbl/BoardConfig.mk
index 7974dff..e3f81eb 100644
--- a/cel_kbl/BoardConfig.mk
+++ b/cel_kbl/BoardConfig.mk
@@ -88,7 +88,7 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/debugfs
 # Source: device/intel/mixins/groups/usb-gadget/g_ffs/BoardConfig.mk
 ##############################################################
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/usb
-
+BOARD_SEPOLICY_DIRS += $(INTEL_PATH_SEPOLICY)/usb-gadget
 ##############################################################
 # Source: device/intel/mixins/groups/slot-ab/true/BoardConfig.mk
 ##############################################################
@@ -356,7 +356,7 @@ DEVICE_PACKAGE_OVERLAYS += device/intel/common/wlan/overlay-wifi-tethering
 BOARD_SEPOLICY_M4DEFS += module_iwlwifi=true
 BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/wlan/iwlwifi
 ##############################################################
-# Source: device/intel/mixins/groups/cpu-arch/skl/BoardConfig.mk
+# Source: device/intel/mixins/groups/cpu-arch/kbl/BoardConfig.mk
 ##############################################################
 ifeq ($(BOARD_USE_64BIT_USERSPACE),true)
 # 64b-specific items:
@@ -370,8 +370,8 @@ TARGET_2ND_CPU_VARIANT := x86
 else
 # 32b-specific items:
 TARGET_ARCH := x86
-TARGET_ARCH_VARIANT := kabylake
 TARGET_CPU_ABI := x86
+TARGET_ARCH_VARIANT := kabylake
 endif
 ##############################################################
 # Source: device/intel/mixins/groups/cpuset/autocores/BoardConfig.mk
@@ -525,4 +525,8 @@ BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/drm-default
 ifneq ($(TARGET_BUILD_VARIANT),user)
 BOARD_KERNEL_CMDLINE += console=ttyS0,115200n8
 endif
+##############################################################
+# Source: device/intel/mixins/groups/neuralnetworks/true/BoardConfig.mk
+##############################################################
+BOARD_SEPOLICY_DIRS += device/intel/project-celadon/sepolicy/neuralnetworks
 # ------------------ END MIX-IN DEFINITIONS ------------------
diff --git a/cel_kbl/device.mk b/cel_kbl/device.mk
index a1e34e0..9b46415 100644
--- a/cel_kbl/device.mk
+++ b/cel_kbl/device.mk
@@ -107,6 +107,10 @@ PRODUCT_PROPERTY_OVERRIDES += \
 PRODUCT_PROPERTY_OVERRIDES += \
     ro.input.noresample=1
 
+# set default DBC configuration
+PRODUCT_PROPERTY_OVERRIDES += \
+    persist.vendor.sys.usb.adbover=dwc
+
 # AOSP Packages
 PRODUCT_PACKAGES += \
     Launcher3 \
@@ -791,6 +795,24 @@ PRODUCT_PACKAGES += android.hardware.drm@1.0-service \
                     android.hardware.drm@1.0-impl \
                     android.hardware.drm@1.1-service.clearkey
 
+##############################################################
+# Source: device/intel/mixins/groups/neuralnetworks/true/product.mk
+##############################################################
+# neuralnetworks HAL
+PRODUCT_PACKAGES += \
+    android.hardware.neuralnetworks@1.0-generic-service \
+    android.hardware.neuralnetworks@1.0-generic-impl
+
+PRODUCT_PACKAGES += \
+    libinference_engine
+
+PRODUCT_PACKAGES += \
+    libMKLDNNPlugin\
+    libmkldnn
+
+PRODUCT_PACKAGES += \
+    graphtest_cpu
+
 ##############################################################
 # Source: device/intel/mixins/groups/debug-kernel/default/product.mk
 ##############################################################
diff --git a/cel_kbl/init.rc b/cel_kbl/init.rc
index 2437cc7..a510d5b 100644
--- a/cel_kbl/init.rc
+++ b/cel_kbl/init.rc
@@ -105,7 +105,7 @@ on boot
     write /sys/kernel/debug/pstate_snb/setpoint 75
 
     # adb over ethernet
-    setprop service.adb.tcp.port 5555
+    # setprop service.adb.tcp.port 5555
 
 service watchdogd /sbin/watchdogd 10 30
     user root
@@ -128,6 +128,20 @@ on fs
    # Update dm-verity persistent state and set partition.*.verified
    # properties
    verity_update_state
+
+# switch adb over dwc
+on property:persist.vendor.sys.usb.adbover=dwc
+#    write /sys/bus/pci/devices/0000:00:14.0/dbc disable
+    stop adbd
+    start adbd
+
+# switch adb over dbc
+on property:persist.vendor.sys.usb.adbover=dbc
+    write /sys/bus/pci/devices/0000:00:14.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:15.0/dbc enable
+    write /sys/bus/pci/devices/0000:00:39.0/dbc enable
+    stop adbd
+    start adbd
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/init.rc.1
 ##############################################################
diff --git a/cel_kbl/ueventd.rc b/cel_kbl/ueventd.rc
index 4645262..b18f329 100644
--- a/cel_kbl/ueventd.rc
+++ b/cel_kbl/ueventd.rc
@@ -34,7 +34,7 @@
 /dev/ttyUSB*              0660   radio      radio
 /dev/iio:device*          0660   system     system
 /dev/radio0               0660   bluetooth  audio
-
+/dev/dbc_raw*		  0777	 system	    system
 /sys/devices/pci0000:00/0000:00:02.0/drm/card*/card*/intel_backlight brightness 0644 system system
 ##############################################################
 # Source: device/intel/mixins/groups/graphics/mesa/ueventd.rc
-- 
2.21.0

