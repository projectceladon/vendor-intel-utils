From 64f6e1dc66da21d500ba3385d6766f473f7343b5 Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 19:21:02 +0800
Subject: [PATCH] CVE-2018-13785 fix

Reference https://github.com/glennrp/libpng/commit/8a05766cb74af05c04c53e6c9d60c13fc4d59bf2.patch

Change-Id: I25c4fb5fd5a5ae72b9ebac742def7aa86df78f9c
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/pngrutil.c b/pngrutil.c
index 8692933..eab2973 100644
--- a/pngrutil.c
+++ b/pngrutil.c
@@ -3149,10 +3149,13 @@
    {
       png_alloc_size_t idat_limit = PNG_UINT_31_MAX;
       size_t row_factor =
-         (png_ptr->width * png_ptr->channels * (png_ptr->bit_depth > 8? 2: 1)
-          + 1 + (png_ptr->interlaced? 6: 0));
+         (size_t)png_ptr->width
+         * (size_t)png_ptr->channels
+         * (png_ptr->bit_depth > 8? 2: 1)
+         + 1
+         + (png_ptr->interlaced? 6: 0);
       if (png_ptr->height > PNG_UINT_32_MAX/row_factor)
-         idat_limit=PNG_UINT_31_MAX;
+         idat_limit = PNG_UINT_31_MAX;
       else
          idat_limit = png_ptr->height * row_factor;
       row_factor = row_factor > 32566? 32566 : row_factor;
