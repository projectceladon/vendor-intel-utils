From b489fcf847bb3637f60307a5d68a360aad2bdf70 Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 18:43:19 +0800
Subject: [PATCH] CVE-2018-1000301 fix

Reference https://curl.haxx.se/CVE-2018-1000301.patch

Change-Id: Ib46286b72c6e0d944dba46f446eb51bf6590aa4a
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/lib/http.c b/lib/http.c
index a500767..a9e31d9 100644
--- a/lib/http.c
+++ b/lib/http.c
@@ -2959,6 +2959,8 @@
 {
   CURLcode result;
   struct SingleRequest *k = &data->req;
+  ssize_t onread = *nread;
+  char *ostr = k->str;
 
   /* header line within buffer loop */
   do {
@@ -3023,7 +3025,9 @@
         else {
           /* this was all we read so it's all a bad header */
           k->badheader = HEADER_ALLBAD;
-          *nread = (ssize_t)rest_length;
+          *nread = onread;
+          k->str = ostr;
+          return CURLE_OK;
         }
         break;
       }
