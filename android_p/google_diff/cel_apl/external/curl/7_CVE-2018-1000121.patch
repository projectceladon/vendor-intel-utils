From 47fbd8cfd21f3139cb32b8fb2564b846c3b3287f Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 18:45:44 +0800
Subject: [PATCH] CVE-2018-1000121 fix

Reference https://curl.haxx.se/CVE-2018-1000121.patch

Change-Id: I66e35f777a1e18c8e5a05f3c537a024001f51eca
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/lib/openldap.c b/lib/openldap.c
index f2ffdfe..6927275 100644
--- a/lib/openldap.c
+++ b/lib/openldap.c
@@ -473,7 +473,7 @@
 
   for(ent = ldap_first_message(li->ld, msg); ent;
     ent = ldap_next_message(li->ld, ent)) {
-    struct berval bv, *bvals, **bvp = &bvals;
+    struct berval bv, *bvals;
     int binary = 0, msgtype;
     CURLcode writeerr;
 
@@ -535,9 +535,9 @@
     }
     data->req.bytecount += bv.bv_len + 5;
 
-    for(rc = ldap_get_attribute_ber(li->ld, ent, ber, &bv, bvp);
-      rc == LDAP_SUCCESS;
-      rc = ldap_get_attribute_ber(li->ld, ent, ber, &bv, bvp)) {
+    for(rc = ldap_get_attribute_ber(li->ld, ent, ber, &bv, &bvals);
+        (rc == LDAP_SUCCESS) && bvals;
+        rc = ldap_get_attribute_ber(li->ld, ent, ber, &bv, &bvals)) {
       int i;
 
       if(bv.bv_val == NULL) break;
