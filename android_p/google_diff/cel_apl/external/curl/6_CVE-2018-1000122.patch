From aa00a633c39e810b43c08d3482b5d0f5f5d0336f Mon Sep 17 00:00:00 2001
From: zhongjie <zhongjie.shi@intel.com>
Date: Thu, 14 Feb 2019 18:44:28 +0800
Subject: [PATCH] CVE-2018-1000122 fix

Reference https://curl.haxx.se/CVE-2018-1000122.patch

Change-Id: I12d9d7db1f208fa681115b3d6f07905454ecf5a0
Tracked-On:
Signed-off-by: zhongjie <zhongjie.shi@intel.com>
---

diff --git a/lib/transfer.c b/lib/transfer.c
index 8f15b1a..0ec8574 100644
--- a/lib/transfer.c
+++ b/lib/transfer.c
@@ -801,10 +801,15 @@
 
     } /* if(!header and data to read) */
 
-    if(conn->handler->readwrite &&
-       (excess > 0 && !conn->bits.stream_was_rewound)) {
+    if(conn->handler->readwrite && excess && !conn->bits.stream_was_rewound) {
       /* Parse the excess data */
       k->str += nread;
+
+      if(&k->str[excess] > &k->buf[data->set.buffer_size]) {
+        /* the excess amount was too excessive(!), make sure
+           it doesn't read out of buffer */
+        excess = &k->buf[data->set.buffer_size] - k->str;
+      }
       nread = (ssize_t)excess;
 
       result = conn->handler->readwrite(data, conn, &nread, &readmore);
