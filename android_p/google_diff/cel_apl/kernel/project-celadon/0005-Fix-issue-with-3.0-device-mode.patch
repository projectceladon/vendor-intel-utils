From 0f1dfb4fd8877e61f89b20833d0409501b39e802 Mon Sep 17 00:00:00 2001
From: saranya <saranya.gopal@intel.com>
Date: Thu, 6 Dec 2018 17:26:46 +0530
Subject: [PATCH] Fix issue with 3.0 device mode

Jira: None

Signed-off-by: saranya <saranya.gopal@intel.com>
---
 drivers/usb/dwc3/core.c   | 8 ++------
 drivers/usb/dwc3/gadget.c | 1 +
 2 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 88c80fc..dd620d9 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -901,12 +901,8 @@ static int dwc3_core_init(struct dwc3 *dwc)
 	 */
 	dwc3_writel(dwc->regs, DWC3_GUID, LINUX_VERSION_CODE);
 
-	/* Handle USB2.0-only core configuration */
-	if (DWC3_GHWPARAMS3_SSPHY_IFC(dwc->hwparams.hwparams3) ==
-			DWC3_GHWPARAMS3_SSPHY_IFC_DIS) {
-		if (dwc->maximum_speed == USB_SPEED_SUPER)
-			dwc->maximum_speed = USB_SPEED_HIGH;
-	}
+	if (dwc->maximum_speed == USB_SPEED_SUPER)
+		dwc->maximum_speed = USB_SPEED_HIGH;
 
 	ret = dwc3_phy_setup(dwc);
 	if (ret)
diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index 69c6f51..9db2752 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -3202,6 +3202,7 @@ int dwc3_gadget_init(struct dwc3 *dwc)
 		goto err4;
 	}
 
+	dwc3_gadget_set_speed(&dwc->gadget, dwc->maximum_speed);
 	return 0;
 
 err4:
-- 
2.7.4

