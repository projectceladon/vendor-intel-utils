From 0aced6e7f7b251acdaaa7df0f545f69989b33b5a Mon Sep 17 00:00:00 2001
From: Rander Wang <rander.wang@linux.intel.com>
Date: Thu, 26 Sep 2019 16:30:06 +0800
Subject: [PATCH] FROMGIT: ALSA: SOF: disable L1SEN for capture stream

Fix noise issue when doing capture

Signed-off-by: Rander Wang <rander.wang@linux.intel.com>
---
 sound/soc/sof/intel/hda-pcm.c | 19 +++++++++++++++++++
 sound/soc/sof/intel/hda.h     |  3 +++
 sound/soc/sof/sof-priv.h      |  1 +
 3 files changed, 23 insertions(+)

diff --git a/sound/soc/sof/intel/hda-pcm.c b/sound/soc/sof/intel/hda-pcm.c
index c7022346aba0..f92ffa893e91 100644
--- a/sound/soc/sof/intel/hda-pcm.c
+++ b/sound/soc/sof/intel/hda-pcm.c
@@ -214,6 +214,16 @@ int hda_dsp_pcm_open(struct snd_sof_dev *sdev,
 		return -ENODEV;
 	}
 
+	if (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {
+		sdev->capture_stream_num++;
+		if (sdev->capture_stream_num == 1)
+			snd_sof_dsp_update_bits(sdev, HDA_DSP_HDA_BAR,
+						HDA_DSP_EM2,
+						HDA_DSP_L1SEN,
+						0);
+	}
+
+
 	/* binding pcm substream to hda stream */
 	substream->runtime->private_data = &dsp_stream->hstream;
 	return 0;
@@ -233,6 +243,15 @@ int hda_dsp_pcm_close(struct snd_sof_dev *sdev,
 		return -ENODEV;
 	}
 
+	if (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {
+		sdev->capture_stream_num--;
+		if (sdev->capture_stream_num == 0)
+			snd_sof_dsp_update_bits(sdev, HDA_DSP_HDA_BAR,
+						HDA_DSP_EM2,
+						HDA_DSP_L1SEN,
+						1);
+	}
+
 	/* unbinding pcm substream to hda stream */
 	substream->runtime->private_data = NULL;
 	return 0;
diff --git a/sound/soc/sof/intel/hda.h b/sound/soc/sof/intel/hda.h
index 8382694d09e8..bc90fde985c5 100644
--- a/sound/soc/sof/intel/hda.h
+++ b/sound/soc/sof/intel/hda.h
@@ -338,6 +338,9 @@
 #define SOF_SKL_NUM_DAIS		8
 #endif
 
+#define HDA_DSP_EM2            0x1030
+#define HDA_DSP_L1SEN          BIT(13)
+
 /* Intel HD Audio SRAM Window 0*/
 #define HDA_ADSP_SRAM0_BASE_SKL		0x8000
 
diff --git a/sound/soc/sof/sof-priv.h b/sound/soc/sof/sof-priv.h
index 1f04a23b9851..894b862319ed 100644
--- a/sound/soc/sof/sof-priv.h
+++ b/sound/soc/sof/sof-priv.h
@@ -436,6 +436,7 @@ struct snd_sof_dev {
 
 	u32 msi_enabled;
 
+	u32 capture_stream_num;
 	void *private;			/* core does not touch this */
 };
 
-- 
2.17.1

