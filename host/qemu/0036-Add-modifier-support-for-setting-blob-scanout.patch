From f008fb9142ed3e79e9ca4339ddc8bc2fbc72aa51 Mon Sep 17 00:00:00 2001
From: "Zhu, ChenyanX" <zhucx@intel.com>
Date: Mon, 3 Jul 2023 19:33:39 +0800
Subject: [PATCH] Add modifier support for setting blob scanout

Use modifier information from frontend

Signed-off-by: Yifan Liu <yifan1.liu@intel.com>
Signed-off-by: Zhu, ChenyanX <zhucx@intel.com>
---
 hw/display/virtio-gpu-udmabuf.c             | 1 +
 hw/display/virtio-gpu.c                     | 1 +
 include/hw/virtio/virtio-gpu-bswap.h        | 4 ++--
 include/hw/virtio/virtio-gpu.h              | 1 +
 include/standard-headers/linux/virtio_gpu.h | 1 +
 5 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/hw/display/virtio-gpu-udmabuf.c b/hw/display/virtio-gpu-udmabuf.c
index b11ac5bc6..2fb2d8c5d 100644
--- a/hw/display/virtio-gpu-udmabuf.c
+++ b/hw/display/virtio-gpu-udmabuf.c
@@ -184,6 +184,7 @@ static VGPUDMABuf
     dmabuf->buf.width = fb->width;
     dmabuf->buf.height = fb->height;
     dmabuf->buf.stride = fb->stride;
+    dmabuf->buf.modifier = fb->modifier;
     dmabuf->buf.x = r->x;
     dmabuf->buf.y = r->y;
     dmabuf->buf.scanout_width = r->width;
diff --git a/hw/display/virtio-gpu.c b/hw/display/virtio-gpu.c
index a8c46f6d8..ecf3c5ecc 100644
--- a/hw/display/virtio-gpu.c
+++ b/hw/display/virtio-gpu.c
@@ -759,6 +759,7 @@ static void virtio_gpu_set_scanout_blob(VirtIOGPU *g,
     fb.height = ss.height;
     fb.stride = ss.strides[0];
     fb.offset = ss.offsets[0] + ss.r.x * fb.bytes_pp + ss.r.y * fb.stride;
+    fb.modifier = ss.modifier;
 
     fbend = fb.offset;
     fbend += fb.stride * (ss.r.height - 1);
diff --git a/include/hw/virtio/virtio-gpu-bswap.h b/include/hw/virtio/virtio-gpu-bswap.h
index e2bee8f59..87cdb0b25 100644
--- a/include/hw/virtio/virtio-gpu-bswap.h
+++ b/include/hw/virtio/virtio-gpu-bswap.h
@@ -71,8 +71,8 @@ virtio_gpu_create_blob_bswap(struct virtio_gpu_resource_create_blob *cblob)
 static inline void
 virtio_gpu_scanout_blob_bswap(struct virtio_gpu_set_scanout_blob *ssb)
 {
-    virtio_gpu_bswap_32(ssb, sizeof(*ssb) - sizeof(ssb->offsets[3]));
-    le32_to_cpus(&ssb->offsets[3]);
+    virtio_gpu_bswap_32(ssb, sizeof(*ssb) - sizeof(ssb->modifier));
+    le64_to_cpus(&ssb->modifier);
 }
 
 #endif
diff --git a/include/hw/virtio/virtio-gpu.h b/include/hw/virtio/virtio-gpu.h
index da6e4a415..1dd79b994 100644
--- a/include/hw/virtio/virtio-gpu.h
+++ b/include/hw/virtio/virtio-gpu.h
@@ -65,6 +65,7 @@ struct virtio_gpu_framebuffer {
     uint32_t width, height;
     uint32_t stride;
     uint32_t offset;
+    uint64_t modifier;
 };
 
 struct virtio_gpu_scanout {
diff --git a/include/standard-headers/linux/virtio_gpu.h b/include/standard-headers/linux/virtio_gpu.h
index 1357e4774..2e81efe19 100644
--- a/include/standard-headers/linux/virtio_gpu.h
+++ b/include/standard-headers/linux/virtio_gpu.h
@@ -412,6 +412,7 @@ struct virtio_gpu_set_scanout_blob {
 	uint32_t padding;
 	uint32_t strides[4];
 	uint32_t offsets[4];
+	uint64_t modifier;
 };
 
 /* VIRTIO_GPU_CMD_RESOURCE_MAP_BLOB */
-- 
2.25.1

